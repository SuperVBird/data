{"id":187278,"link":"https://chinadigitaltimes.net/chinese/2011/10/翻墙-转openvz安装openvpn配置vpn/","date":"2011-10-10T10:29:26Z","modified":"2011-10-10T10:29:26Z","title":"翻墙 | 转:Openvz安装Openvpn配置vpn","content":"<p><p>来源：<a rel=\"nofollow\" target=\"_blank\" href=\"http://qianjia.org/archives/6038\">http://qianjia.org/archives/6038</a>   </p>\n<p>今天购买并开通了国内群众比较熟悉的Burst vps(“84 vps”)，在CentOS 5系统下选择Openvz安装Openvpn，经过复杂的搭建过程配置好vpn线路，却发现速度却并不是很快。前两个月写了一篇关于基于ssh结合 Tunnelier+Foxyproxy代理上网的文章，不过确实是vpn的速度要比ssh快一些；今天发现留言的两位鱼童靴对文中提到的快速的免费日本 VPN客户端感兴趣，因为客户端不在这台电脑上，只能明天白天再将vpn发到你们邮箱了。</p>\n<h3>Burstnet vs Rapidxen</h3>\n<p>前几天也写了篇关于rapidxen vps搭建vpn的文章，建了几个vpn账号国内访问国外网站速度还算可以。Rapidxen和Burst net都是比较便宜的vps主 机(每月$6左右)，相比较而言Burst的vePortal vps管理后台功能更加强大，而且相同价位的vps性能参数要比rapidxen高很多，如6美元的vps型号：CPU: 1GHZ, RAM: 512MB, DISKSPACE: 20GB, BANDWIDTH: 1000GB/MONTH ，还附送两个ip，而rapidxen ram只有128MB且流量限制每月600G。</p>\n<h3>Openvz vs Xen</h3>\n<p><span></span>    <br />因此按理说Burst 的vpn速度会比Rapidxen好很多，事实上并非如此。这可能和两者vps系统的虚拟化技术不同有关，rapidxen采用基于xen的半虚拟化技 术，Burst 则是基于操作系统级别虚拟化技术Openvz的vps，Google上查了些资料说虽然Openvz虚拟化技术会使vps有更高的性能表现，但其配置却非 常灵活，表面上分了512M内存给你，实际上因主机商超买vps后，最后分配到每个用户的甚至还没有Xen的128M好。</p>\n<h3>Openvpn vs pptpd</h3>\n<p>在Openvz vps下只有venet0，没有eth0，大部分Openvz没有masqurade；因此不能像Xen vps通过pptpd来搭建vpn。在Openvz下可以使用Openvpn来搭建vpn，需要生成key证书，生成服务器端和客户端配置文件，在用户的 客户端机器上也要安装openvpn 的GUI客户端，因此Openvz安装Openvpn配置vpn搭建的整个过程要复杂很多，下面是具体步骤：</p>\n<h3>Openvz VPS安装Openvpn配置vpn</h3>\n<p><strong>一、VPS安装Openvpn配置准备工作</strong></p>\n<p>以Burst为例，购买Burst vps的过程中，选择vps操作系统如CentOS 5 32 bit，vps开通之后可以通过<code>uname –a</code>命令查看linux vps系统的发行版本信息，<code>getconf WORD_BIT</code>查看是64位还是32位机。vps开通之后，进入Burstnet vePortal管理后台开启TUN/TAB，点击<code>Enable Tun/Tap</code>按钮即可，并不需要发ticket给Burst net客服帮助启用。开启之后输入命令<code>cat /dev/net/tun</code>，若出现 cat: /dev/net/tun: File descriptor in bad state 说明开启成功。以下部分参考mven .cn博客的介绍：BurstNET VPS搭建OpenVPN全过程记录。</p>\n<p><strong>二、升级下载和安装系统软件</strong></p>\n<p><em>1. 安装iptables等</em>： <code>yum install gcc gcc-devel openssl openssl-devel iptables</code></p>\n<p><em>2. 下载Openvpn和lzo</em></p>\n<pre>mkdir /opt/software cd /opt/software wget <a rel=\"nofollow\" target=\"_blank\" href=\"http://www.oberhumer.com/opensource/lzo/download/lzo-2.03.tar.gz\">http://www.oberhumer.com/opensource/lzo/download/lzo-2.03.tar.gz</a> wget <a rel=\"nofollow\" target=\"_blank\" href=\"http://openvpn.net/release/openvpn-2.0.9.tar.gz\">http://openvpn.net/release/openvpn-2.0.9.tar.gz</a></pre>\n<p><em>3. 安装Openvpn和lzo</em></p>\n<pre>#cd /opt/software #tar -zxvf lzo-2.03.tar.gz #cd lzo-2.03 #./configure #make && make install #cd ../ #tar -zxvf openvpn-2.0.9.tar.gz #cd openvpn-2.0.9 #./configure --with-lzo-headers=/usr/local/include --with-lzo-lib=/usr/local/lib --with-ssl-headers=/usr/include/openssl --with-ssl-lib=/usr/lib #make && make install</pre>\n<p><strong>三、生成CA证书、Server Key和Client Key</strong></p>\n<p><em>1. 初始化参数</em></p>\n<pre>#cd /opt/software/openvpn-2.0.9/easy-rsa #export D=`pwd` #export KEY_CONFIG=$D/openssl.cnf #export KEY_DIR=$D/keys #export KEY_SIZE=1024 #export KEY_COUNTRY=CN #export KEY_PROVINCE=GD #export KEY_CITY=GZ #export KEY_ORG=\"<a rel=\"nofollow\" target=\"_blank\" href=\"http://farlee.info\">farlee.info</a>\" (设置为自己的) #export KEY_EMAIL=\"<a rel=\"nofollow\" target=\"_blank\" href=\"mailto:farlee@farlee.info\">farlee@farlee.info</a>\"(设置为自己的)</pre>\n<p><em>2. 生成CA证书</em></p>\n<pre>./clean-all ./build-ca  采用初始化参数的只需按Enter取用默认值，生成OpenVPN的CA证书只要设置下面两项，其他直接回车：  Organizational Unit Name (eg, section) []:<a rel=\"nofollow\" target=\"_blank\" href=\"http://farlee.info\">farlee.info</a>(设置为你自己的) Common Name (eg, your name or your server's hostname) []:vpnhostname(设置为自己的名称或主机名)</pre>\n<p><em>3. 建立Server Key</em></p>\n<pre>#./build-key-server server OpenVPN创建server key只要设置下面几项，其他采用初始化参数的只需回车： Organizational Unit Name (eg, section) []:<a rel=\"nofollow\" target=\"_blank\" href=\"http://farlee.info\">farlee.info</a> (设置为自己的) Common Name (eg, your name or your server's hostname) []:vpnhostname A challenge password []:vpn111(设置密码) An optional company name []:<a rel=\"nofollow\" target=\"_blank\" href=\"http://farlee.info\">farlee.info</a> Sign the certificate? [y/n]:y 1 out of 1 certificate requests certified, commit? [y/n]y</pre>\n<p><em>4、生成Client Key</em></p>\n<pre>#./build-key client1  设置同上 Organizational Unit Name (eg, section) []:<a rel=\"nofollow\" target=\"_blank\" href=\"http://farlee.info\">farlee.info</a> Common Name (eg, your name or your server's hostname) []:client1 A challenge password []:abcd1234 An optional company name []:<a rel=\"nofollow\" target=\"_blank\" href=\"http://farlee.info\">farlee.info</a> Sign the certificate? [y/n]:y 1 out of 1 certificate requests certified, commit? [y/n]y</pre>\n<p>如果要创建多个vpn帐户，则同样如client1一样生成其他客户端证书/key</p>\n<pre>./build-key client2harry ./build-key client3farlee</pre>\n<p><em>5、生成 Diffie Hellman 参数</em>：<code>./build-dh</code></p>\n<p><strong>四、创建Openvpn vps服务器和客户端配置文件</strong></p>\n<p><em>1. Openvpn服务器端配置文件</em>：<code>nano /usr/local/etc/server.conf</code> 复制如下文件内容：</p>\n<pre>local 1.1.1.1 (改为你的VPS IP地址) port 1194 proto udp dev tun ca /opt/software/openvpn-2.0.9/easy-rsa/keys/ca.crt cert /opt/software/openvpn-2.0.9/easy-rsa/keys/server.crt key /opt/software/openvpn-2.0.9/easy-rsa/keys/server.key dh /opt/software/openvpn-2.0.9/easy-rsa/keys/dh1024.pem  server 10.8.0.0 255.255.255.0 client-to-client keepalive 10 120 comp-lzo persist-key persist-tun status /opt/software//openvpn-2.0.5/easy-rsa/keys/openvpn-status.log verb 4  push \"dhcp-option DNS 10.8.0.1\" push \"dhcp-option DNS 4.2.2.1\" push \"dhcp-option DNS 4.2.2.2\"</pre>\n<p><em>2. Openvpn配置客户端配置文件</em>：<code>nano /usr/local/etc/client.ovp</code></p>\n<pre>client  dev tun proto udp remote VPS的IP地址 1194 persist-key persist-tun ca ca.crt cert client1.crt key client1.key ns-cert-type server comp-lzo verb 3 redirect-gateway def1</pre>\n<p><em>3. 下载以上生成的客户端client key和客户端配置文件到本地计算机</em></p>\n<pre>#cp /usr/local/etc/client.ovpn /opt/software/openvpn-2.0.9/easy-rsa/keys/ #tar -vcf keys.tar /opt/software/openvpn-2.0.9/easy-rsa/keys/</pre>\n<p>如使用putty客户端程序psftp.exe下载这些文件到本地计算机：<code>lcd</code> 本地路径设置保存压缩文件的位置，<code>cd /opt/software/openvpn-2.0.9/easy-rsa/</code>，执行psftp下载命令<code>get keys.tar</code>即下载到本地客户端。</p>\n<p><strong>五、配置OpenVPN启动和设置</strong></p>\n<p><em>1. 启动OpenVPN服务器</em>：<code>/usr/local/sbin/openvpn --config /usr/local/etc/server.conf</code></p>\n<p><em>2. 设置OpenVPN开机自动启动</em>：<code>nano /etc/rc.local</code>，在最后面加入：</p>\n<p>/usr/local/sbin/openvpn –config /usr/local/etc/server.conf > /dev/null 2>&#038;1 &#038;</p>\n<p><em>3. 修改本机OpenVPN VPS域名服务器</em>：<code>nano /etc/resolv.conf</code>，将nameserver改为下面两行：</p>\n<pre>nameserver   4.2.2.1 nameserver   4.2.2.2</pre>\n<p><em>4. 开启域名服务</em>：</p>\n<p>若需要访问被blocked掉了域名的网站，如twitter、facebook、google相关产品网站，需要在OpenVPN 服务器VPS主机上开启 name server, 并将 dns push 给 client，命令：<code>service named start</code></p>\n<p><em>5. 修改/etc/sysctl.conf</em>：<code>nano /etc/sysctl.conf</code>，改成如下：<code>net.ipv4.ip_forward = 1</code></p>\n<p><em>6. 设置iptables</em></p>\n<pre>#iptables -t nat -A POSTROUTING -s <a rel=\"nofollow\" target=\"_blank\" href=\"http://10.8.0.0/16\">10.8.0.0/16</a> -j SNAT --to 1.1.1.1 (改成VPS的IP地址) #/etc/init.d/iptables save #/etc/init.d/iptables restart</pre>\n<p><strong>六、Opnevpn windows 客户端安装设置</strong></p>\n<p>终于配置到了客户端了，接下来在用户Windows 系统下的安装OpenVPN GUI程序就比较简单了。</p>\n<p>1. 下载安装和服务器端配套的OpenVPN GUI For Windows：</p>\n<p><a rel=\"nofollow\" target=\"_blank\" href=\"http://openvpn.se/files/install_packages/openvpn-2.0.9-gui-1.0.3-install.exe\">http://openvpn.se/files/install_packages/openvpn-2.0.9-gui-1.0.3-install.exe</a>，直接点next安装即可；</p>\n<p>2. 将刚才下载到本地的keys.tar解压，全部放到OpenVPN GUI For Windows安装目录下的config目录下，检查一下至少要包含以下6个文件：</p>\n<p>ca.crt | ca.key | client1.crt | client1.csr | client1.key | client.ovpn</p>\n<p>3. 在客户端双击client.ovpn即可启动OpenVPN GUI For Windows客户端，不用输入账号密码即可连接至vpn服务器。若双击client.ovpn 没有反应，则在任务栏点 OpenVPN GUI 的小图标右键，选择 edit config，将内容复制过去再保存，然后再点右键中的 connect即可。</p>\n<p>4、如果多个客户端要用到多个vpn账号，OpenVPN的配置和上面相同，再将config文件目录里的 client1.crt，client1.csr，client1.key 替换成对应的 client2harry.xxx 即可，最后在client.ovpn 中将cert client1.crt 和key client1.key的值改成client2harry.crt和client2harry.key。</p>\n<div>原文地址：</div>\n<div><a rel=\"nofollow\" target=\"_blank\" href=\"http://farlee.info/archives/burstnet-vps-openvz-install-openvpn-config-vpn-centos.html\">http://farlee.info/archives/burstnet-vps-openvz-install-openvpn-config-vpn-centos.html</a></div>\n</p>\n<p>  <a rel=\"nofollow\" target=\"_blank\" href=\"http://feeds.wordpress.com/1.0/gocomments/xijie.wordpress.com/5152/\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/comments/xijie.wordpress.com/5152/\" /></a> <a rel=\"nofollow\" target=\"_blank\" href=\"http://feeds.wordpress.com/1.0/godelicious/xijie.wordpress.com/5152/\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/delicious/xijie.wordpress.com/5152/\" /></a> <a rel=\"nofollow\" target=\"_blank\" href=\"http://feeds.wordpress.com/1.0/gofacebook/xijie.wordpress.com/5152/\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/facebook/xijie.wordpress.com/5152/\" /></a> <a rel=\"nofollow\" target=\"_blank\" href=\"http://feeds.wordpress.com/1.0/gotwitter/xijie.wordpress.com/5152/\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/twitter/xijie.wordpress.com/5152/\" /></a> <a rel=\"nofollow\" target=\"_blank\" href=\"http://feeds.wordpress.com/1.0/gostumble/xijie.wordpress.com/5152/\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/stumble/xijie.wordpress.com/5152/\" /></a> <a rel=\"nofollow\" target=\"_blank\" href=\"http://feeds.wordpress.com/1.0/godigg/xijie.wordpress.com/5152/\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/digg/xijie.wordpress.com/5152/\" /></a> <a rel=\"nofollow\" target=\"_blank\" href=\"http://feeds.wordpress.com/1.0/goreddit/xijie.wordpress.com/5152/\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/reddit/xijie.wordpress.com/5152/\" /></a> <img alt=\"\" border=\"0\" height=\"1\" src=\"http://stats.wordpress.com/b.gif?host=xijie.wordpress.com&#038;blog=10068099&#038;post=5152&#038;subd=xijie&#038;ref=&#038;feed=1\" width=\"1\" /></p>\n<p><img src=\"http://feeds.wordpress.com/1.0/comments/xijie.wordpress.com/5152/\" /></p>\n<p>翻越防火长城，你可以到达世界上的每一个角落。（Across the Great Firewall, you can reach every corner in the world.）<br />\n<small>本文由自动聚合程序取自网络，内容和观点不代表数字时代立场</small></p>\n<form method=\"POST\" action=\"http://www.feedblitz.com/f/f.fbz?AddNewUserDirect\">\n定期获得翻墙信息？<a href=\"http://www.feedblitz.com/f/?Sub=738338\">请电邮订阅数字时代</a> <br /><input name=\"EMAIL\" maxlength=\"64\" type=\"text\" size=\"25\" value=\"\"><br />\n<input name=\"FEEDID\" type=\"hidden\" value=\"738338\"><br />\n<input name=\"PUBLISHER\" type=\"hidden\" value=\"7485568\"><br />\n<input type=\"submit\" value=\"订阅!\"><br />\n</form>\n","author":983,"categories":[15300],"tags":[7775,8510,8795]}