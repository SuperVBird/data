{"id":188238,"link":"https://chinadigitaltimes.net/chinese/2011/10/翻墙-如何在-vps-上搭建-l2tpipsec-简易教程/","date":"2011-10-12T17:30:59Z","modified":"2011-10-12T17:30:59Z","title":"翻墙 | 如何在 VPS 上搭建 L2TP/IPSec 简易教程","content":"<p><p>来源：<a rel=\"nofollow\" target=\"_blank\" href=\"http://jingpin.org/set-up-l2tp-ipsec-in-a-vps/\">http://jingpin.org/set-up-l2tp-ipsec-in-a-vps/</a>    </p>\n<p>如之前所说，<a rel=\"nofollow\" target=\"_blank\" href=\"http://jingpin.org/how-to-set-up-pptp-vpn-in-a-vps/\">PPTP</a> 类的 VPN 可以在 iPhone 手机上使用，但是不能在 Mac OS X 电脑系统上使用，于是，我需要使用 L2TP/IPSec (L2TP over IPSec，即在 IPSec 上搭建 L2TP) 类的 VPN。</p>\n<p>这 篇文章将介绍如何在 VPS （Xen）上搭建 L2TP/IPSec 类的 VPN，而你只需要一个 VPS 和一台可以上网的电脑。和 PPTP 的一样，L2TP/IPSec 的操作步骤也是基于 Mac 电脑的终端应用程序，对 Linux 系统来讲，步骤几乎是一模一样的，而对 Windows 用户来讲，则需要先安装一个叫 Putty 的软件。</p>\n<p>顺便提一下，Xen VPS 的 Ubuntu 系统最好使用 11.04 版本的，因为其他较低的版本（例如 10.04）很可能不行。 <span></span></p>\n<p><img alt=\"How To Set Up A L2TP/IPSec VPN In A VPS\" height=\"287\" src=\"http://freenuts.com/images/l2tp-set-up.gif\" title=\"l2tp-set-up\" width=\"530\" /></p>\n<h2>I、连接 VPS</h2>\n<p>打开终端应用程序并输入以下命令：</p>\n<blockquote>\n<p>ssh root@xxx.xxx.xxx.xxx</p>\n</blockquote>\n<p>记得将 &#8220;xxx.xxx.xxx.xxx&#8221; 替换成 VPS 的 IP 地址，例如 &#8220;178.18.17.30&#8221;，然后回车就可以了。</p>\n<p><strong>P.S.</strong>:</p>\n<p>如果在连接的过程中遇到问题，可以参考之前的 <a rel=\"nofollow\" target=\"_blank\" href=\"http://jingpin.org/how-to-set-up-pptp-vpn-in-a-vps/\">PPTP</a> 教程。</p>\n<h2>II、安装 OpenSwan</h2>\n<p>虽然你可以通过输入 &#8220;aptitude install openswan&#8221; 命令直接安装 OpenSwan，但根据我分别在两个不同的 VPS 上测试的结果，这种方法已经无效，所以，最好还是直接从 OpenSwan 官方网站下载再安装，具体方法如下：</p>\n<p><strong>1、输入以下命令：</strong></p>\n<blockquote>\n<p>aptitude install build-essential</p>\n</blockquote>\n<p>回车，输入 &#8220;y&#8221;，再回车。</p>\n<p><strong>2、输入以下命令：</strong></p>\n<blockquote>\n<p>aptitude install libgmp3-dev gawk flex bison</p>\n</blockquote>\n<p>回车，输入 &#8220;y&#8221;，再回车。</p>\n<p><strong>3、输入以下命令：</strong></p>\n<blockquote>\n<p>wget <a rel=\"nofollow\" target=\"_blank\" href=\"http://www.openswan.org/download/openswan-2.6.35.tar.gz\">http://www.openswan.org/download/openswan-2.6.35.tar.gz</a></p>\n</blockquote>\n<p>回车。</p>\n<p><strong>4、输入以下命令：</strong></p>\n<blockquote>\n<p>tar xzvf openswan-2.6.35.tar.gz</p>\n</blockquote>\n<p>回车。</p>\n<p><strong>5、输入以下命令：</strong></p>\n<blockquote>\n<p>cd openswan-2.6.35</p>\n</blockquote>\n<p>回车。</p>\n<p><strong>6、输入以下命令：</strong></p>\n<blockquote>\n<p>make programs</p>\n</blockquote>\n<p>回车。</p>\n<p><strong>7、输入以下命令：</strong></p>\n<blockquote>\n<p>make install</p>\n</blockquote>\n<p>回车。到此，OpenSwan 就安装成功了。</p>\n<p><strong>备注：</strong></p>\n<p>a、2.6.35 是目前最新的版本，将来你可以访问 <a rel=\"nofollow\" target=\"_blank\" href=\"http://www.openswan.org/code/\">OpenSwan</a> 官方网站看看有没有更新的版本，如有，不妨尝试一下。</p>\n<p>b、文章中的所有命令都可以直接复制粘贴到终端应用程序。</p>\n<h2>III、编辑 IPSec</h2>\n<p>OpenSwan 是用来建 <a rel=\"nofollow\" target=\"_blank\" href=\"http://en.wikipedia.org/wiki/IPsec\">IPSec</a> 的，而 IPSec 是用来建 L2TP 的。</p>\n<p><strong>1、输入以下命令：</strong></p>\n<blockquote>\n<p>vi /etc/ipsec.conf</p>\n</blockquote>\n<p>回车，输入 &#8220;dG&#8221; 删除所有内容，按 &#8220;i&#8221; 键，然后复制并粘贴以下内容：</p>\n<blockquote>\n<pre>version 2.0 config setup     nat_traversal=yes     virtual_private=%v4:<a rel=\"nofollow\">10.0.0.0/8,%v4:192.168.0.0/16,%v4:172.16.0.0/12,%v4:25.0.0.0/8,%v6:fd00::/8,%v6:fe80::/10</a>     oe=off     protostack=netkey  conn %default     forceencaps=yes  conn L2TP-PSK-NAT     rightsubnet=vhost:%priv     also=L2TP-PSK-noNAT  conn L2TP-PSK-noNAT     authby=secret     pfs=no     auto=add     keyingtries=3     rekey=no     ikelifetime=8h     keylife=1h     type=transport     left=YOUR.VPS.IP.ADDRESS     leftprotoport=17/1701     right=%any     rightprotoport=17/%any </pre>\n</blockquote>\n<p>记得将 YOUR.VPS.IP.ADDRESS 替换成自己 VPS 的 IP 地址，例如 178.18.17.30。替换方法如下：</p>\n<p>按 下&#8221;ESC&#8221; 键退出插入模式，将光标移到 &#8220;Y&#8221; 字母上，接着按下 &#8220;i&#8221; 键，输入 IP 地址，再按一下 &#8220;ESC&#8221; 键，并将光标移到 &#8220;YOUR.VPS.IP.ADDRESS&#8221; 上，然后按下 &#8220;x&#8221; 键把它们全部删除。或者你可以先把内容粘贴到记事本之类的编辑器上并修改好之后再复制粘贴到终端应用程序。</p>\n<p>完了之后，输入 &#8220;:wq&#8221; 并回车保存所做的修改。</p>\n<p><strong>备注：</strong></p>\n<p>在 Vi 编辑模式下，你需要按 &#8220;i&#8221; 才能插入内容，完了之后，要按 &#8220;ESC&#8221; 退出插入模式和保存。</p>\n<p><strong>2、输入以下命令：</strong></p>\n<blockquote>\n<p>vi /etc/ipsec.secrets</p>\n</blockquote>\n<p>回车，按 &#8220;i&#8221; 键并输入以下内容：</p>\n<blockquote>\n<p><code>YOUR.VPS.IP.ADDRESS %any: PSK \"YourSharedSecret\"</code></p>\n</blockquote>\n<p>例如：</p>\n<blockquote>\n<p><code>178.18.17.30 %any: PSK \"123456abcdef\"</code></p>\n</blockquote>\n<p>（小技巧：你需要按 Tab 键创建不同数值之间的空格。）</p>\n<p>按 &#8220;ESC&#8221; 键，输入 &#8220;:wq&#8221;，再回车保存。</p>\n<p><strong>3、一行一行地输入以下命令：</strong></p>\n<blockquote>\n<p>for each in /proc/sys/net/ipv4/conf/*</p>\n<p>do</p>\n<p>echo 0 > $each/accept_redirects</p>\n<p>echo 0 > $each/send_redirects</p>\n<p>done</p>\n</blockquote>\n<p>每一行都要回车。</p>\n<p><strong>4、输入以下命令：</strong></p>\n<blockquote>\n<p>service ipsec restart</p>\n</blockquote>\n<p>回车。</p>\n<p><strong>备注：</strong></p>\n<p>输入 &#8220;ipsec verify&#8221;，回车，如果一切正确，你将会看到如下图所示的结果：</p>\n<p><img alt=\"Ipsec verify\" height=\"329\" src=\"http://freenuts.com/images/l2tp-ipsec-verify.jpg\" title=\"l2tp-ipsec-verify\" width=\"530\" /></p>\n<p>如果不是，则需要重新检查之前的操作步骤，特别是 &#8220;ipsec.conf&#8221; 的内容。</p>\n<h2>IV、安装 L2TP</h2>\n<p>基于 IPSec 的 L2TP 就是 VPN 了。</p>\n<p><strong>1、输入以下命令：</strong></p>\n<blockquote>\n<p>cd ..</p>\n</blockquote>\n<p>回车以便进入 VPS 根目录。</p>\n<p><strong>2、输入以下命令：</strong></p>\n<blockquote>\n<p>aptitude install xl2tpd</p>\n</blockquote>\n<p>回车，输入 &#8220;y&#8221;，再回车。</p>\n<p><strong>3、输入以下命令：</strong></p>\n<blockquote>\n<p>vi /etc/xl2tpd/xl2tpd.conf</p>\n</blockquote>\n<p>回车，输入 &#8220;dG&#8221; 删除所有的内容，按下 &#8220;i&#8221; 键，然后粘贴以下内容：</p>\n<blockquote>\n<p>[global]</p>\n<p>; listen-addr = 192.168.1.98</p>\n<p>[lns default]</p>\n<p>ip range = 10.1.1.2-10.1.1.255</p>\n<p>local ip = 10.1.1.1</p>\n<p>require chap = yes</p>\n<p>refuse pap = yes</p>\n<p>require authentication = yes</p>\n<p>name = LinuxVPNserver</p>\n<p>ppp debug = yes</p>\n<p>pppoptfile = /etc/ppp/options.xl2tpd</p>\n<p>length bit = yes</p>\n</blockquote>\n<p>按下 &#8220;ESC&#8221; 键，输入 &#8220;:wq&#8221;，并回车保存。</p>\n<h2>V、创建 xl2tpd</h2>\n<p>这里假设你的 VPS 已经支持 PPP，如果没有，先输入 &#8220;aptitude install ppp&#8221; 命令安装 PPP。</p>\n<p><strong>1、输入以下命令：</strong></p>\n<blockquote>\n<p>vi /etc/ppp/options.xl2tpd</p>\n</blockquote>\n<p>回车，按下 &#8220;i&#8221; 键，然后粘贴以下内容：</p>\n<blockquote>\n<p>require-mschap-v2</p>\n<p>ms-dns 8.8.8.8</p>\n<p>ms-dns 8.8.4.4</p>\n<p>asyncmap 0</p>\n<p>auth</p>\n<p>crtscts</p>\n<p>lock</p>\n<p>hide-password</p>\n<p>modem</p>\n<p>debug</p>\n<p>name l2tpd</p>\n<p>proxyarp</p>\n<p>lcp-echo-interval 30</p>\n<p>lcp-echo-failure 4</p>\n</blockquote>\n<p>按下 &#8220;ESC&#8221; 键，输入 &#8220;:wq&#8221;，并回车保存。</p>\n<p><strong>备注：</strong></p>\n<p>你可以将 8.8.8.8 和 8.8.4.4 替换成 208.67.222.222 和 208.67.220.220。</p>\n<p><strong>2、输入以下命令：</strong></p>\n<blockquote>\n<p>vi /etc/ppp/chap-secrets</p>\n</blockquote>\n<p>回车，按下 &#8220;i&#8221; 键，并输入如下内容：</p>\n<blockquote>\n<p>username l2tpd password *</p>\n</blockquote>\n<p>例如：</p>\n<blockquote>\n<p>freenuts l2tpd 123456 *</p>\n</blockquote>\n<p>记得用 &#8220;tab&#8221; 键输入空格，用 &#8220;:wq&#8221; 保存文件。</p>\n<p><strong>3、输入以下命令：</strong></p>\n<blockquote>\n<p>service xl2tpd restart</p>\n</blockquote>\n<p>回车。</p>\n<h2>VI、IP 转发</h2>\n<p>这个步骤将使你的 VPN 连接整个互联网。</p>\n<p><strong>1、输入以下命令：</strong></p>\n<blockquote>\n<p>vi /etc/sysctl.conf</p>\n</blockquote>\n<p>回车，找到 &#8220;#net.ipv4.ip_forward=1&#8221; 这一行，接着按 &#8220;x&#8221; 键删除 &#8220;#&#8221; 号，然后输入 &#8220;:wq&#8221; 保存。</p>\n<p><strong>2、使转发生效：</strong></p>\n<blockquote>\n<p>sysctl -p</p>\n</blockquote>\n<p>回车，如果一切正常，你将会只看到以下结果：</p>\n<p><strong>3、输入以下命令：</strong></p>\n<blockquote>\n<p>iptables -t nat -A POSTROUTING -s <a rel=\"nofollow\" target=\"_blank\" href=\"http://10.1.1.0/24\">10.1.1.0/24</a> -o eth0 -j MASQUERADE</p>\n</blockquote>\n<p>回车之后，你就可以连接自己的 L2TP/IPSec VPN 翻墙了，但是如果你重启 VPS 的话，就需要重新执行一次 iptables 命令，并重启 ipsec，为了避免这些，你只需要输入以下命令：</p>\n<blockquote>\n<p>vi /etc/rc.local</p>\n</blockquote>\n<p>并在 &#8220;exit 0&#8221; 这一行之前粘贴以下内容就可以了：</p>\n<blockquote>\n<p>for each in /proc/sys/net/ipv4/conf/*</p>\n<p>do</p>\n<p>echo 0 > $each/accept_redirects</p>\n<p>echo 0 > $each/send_redirects</p>\n<p>done</p>\n<p>iptables -t nat -A POSTROUTING -s <a rel=\"nofollow\" target=\"_blank\" href=\"http://10.1.1.0/24\">10.1.1.0/24</a> -o eth0 -j MASQUERADE</p>\n<p>/etc/init.d/ipsec restart</p>\n</blockquote>\n<p>完了之后，你就可以尽情地享用自己搭建的 L2TP/IPSec VPN 了。</p>\n<h2>额外收获：</h2>\n<p>以下是根据上面的教程在 2host 的 Xen VPS 上搭建的 L2TP/IPSec VPN：</p>\n<p><strong>Server Address</strong>: 178.18.17.30</p>\n<p><strong>Account Name</strong> : freenuts</p>\n<p><strong>Password</strong> : 123456</p>\n<p><strong>Shared Secret</strong> : 123456abcdef</p>\n<p>这个 VPN 帐号会免费大概半个月，你可以参考<a rel=\"nofollow\" target=\"_blank\" href=\"http://freenuts.com/how-to-set-up-vpn-in-your-computer-and-mobile-phone/\">这篇文章</a> 在电脑或者手机上试用。</p>\n</p>\n<p>  <a rel=\"nofollow\" target=\"_blank\" href=\"http://feeds.wordpress.com/1.0/gocomments/xijie.wordpress.com/5182/\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/comments/xijie.wordpress.com/5182/\" /></a> <a rel=\"nofollow\" target=\"_blank\" href=\"http://feeds.wordpress.com/1.0/godelicious/xijie.wordpress.com/5182/\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/delicious/xijie.wordpress.com/5182/\" /></a> <a rel=\"nofollow\" target=\"_blank\" href=\"http://feeds.wordpress.com/1.0/gofacebook/xijie.wordpress.com/5182/\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/facebook/xijie.wordpress.com/5182/\" /></a> <a rel=\"nofollow\" target=\"_blank\" href=\"http://feeds.wordpress.com/1.0/gotwitter/xijie.wordpress.com/5182/\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/twitter/xijie.wordpress.com/5182/\" /></a> <a rel=\"nofollow\" target=\"_blank\" href=\"http://feeds.wordpress.com/1.0/gostumble/xijie.wordpress.com/5182/\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/stumble/xijie.wordpress.com/5182/\" /></a> <a rel=\"nofollow\" target=\"_blank\" href=\"http://feeds.wordpress.com/1.0/godigg/xijie.wordpress.com/5182/\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/digg/xijie.wordpress.com/5182/\" /></a> <a rel=\"nofollow\" target=\"_blank\" href=\"http://feeds.wordpress.com/1.0/goreddit/xijie.wordpress.com/5182/\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/reddit/xijie.wordpress.com/5182/\" /></a> <img alt=\"\" border=\"0\" height=\"1\" src=\"http://stats.wordpress.com/b.gif?host=xijie.wordpress.com&#038;blog=10068099&#038;post=5182&#038;subd=xijie&#038;ref=&#038;feed=1\" width=\"1\" /></p>\n<p><img src=\"http://chinadigitaltimes.net/chinese/files/2011/10/7cd20c24l2tp-set-up.gif-150x150.gif\" /></p>\n<p>翻越防火长城，你可以到达世界上的每一个角落。（Across the Great Firewall, you can reach every corner in the world.）<br />\n<small>本文由自动聚合程序取自网络，内容和观点不代表数字时代立场</small></p>\n<form method=\"POST\" action=\"http://www.feedblitz.com/f/f.fbz?AddNewUserDirect\">\n定期获得翻墙信息？<a href=\"http://www.feedblitz.com/f/?Sub=750556\">请电邮订阅数字时代</a> <br /><input name=\"EMAIL\" maxlength=\"64\" type=\"text\" size=\"25\" value=\"\"><br />\n<input name=\"FEEDID\" type=\"hidden\" value=\"750556\"><br />\n<input name=\"PUBLISHER\" type=\"hidden\" value=\"7485568\"><br />\n<input type=\"submit\" value=\"订阅!\"><br />\n</form>\n","author":983,"categories":[15300],"tags":[8510,8795,8817]}