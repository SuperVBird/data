{"id":170845,"link":"https://chinadigitaltimes.net/chinese/2011/08/ipv4openvpn实现ipv6访问/","date":"2011-08-07T19:30:20Z","modified":"2011-08-07T19:30:20Z","title":"IPv4+OpenVPN实现IPv6访问","content":"<p><p><span>来源：<a href=\"http://lolis.info/2011-08/thread-1271-1-1.html\">http://lolis.info/2011-08/thread-1271-1-1.html</a>     </p>\n<p>IPv4资源已经从好久前就已经枯竭，天朝电信等ISP丝毫没有加入IPv6支持的打算，怎样才能在IPv4环境下访问IPv6资源呢？本文将着重介绍。</p>\n<p><span></span></p>\n<p>说下配置环境：Centos+OVPN服务端，Win7作为客户端</p>\n<p>参考配置的文章有<a href=\"https://humou.net/blog/201102041307.html\">这篇</a>，<a href=\"http://www.linode.com/wiki/index.php/IPv6#Debian\">这篇</a>，<a href=\"http://www.linux-ipv6.org/ml/usagi-users/msg00847.html\">这篇</a>，<a href=\"http://forum.soluslabs.com/showthread.php/2083-Setting-up-Ipv6-in-Ovh\">这篇</a>和<a href=\"http://lolis.info/2010-04/thread-635-1-1.html\">这篇</a>。</p>\n<p>其他要求：服务器要支持IPv6，要有大量的时间调试。</p>\n<p>实现效果如下：</p>\n<p><a href=\"http://lolis.info/wp-content/uploads/2011/08/image.png\"><img alt=\"image\" border=\"0\" height=\"196\" src=\"http://lolis.info/wp-content/uploads/2011/08/image_thumb.png\" title=\"image\" width=\"522\" /></a></p>\n<p> </p>\n<p>首先，先在VPS面板启用IPv6支持，记录下本机的IP</p>\n<p><a href=\"http://lolis.info/wp-content/uploads/2011/08/image1.png\"><img alt=\"image\" border=\"0\" height=\"138\" src=\"http://lolis.info/wp-content/uploads/2011/08/image_thumb1.png\" title=\"image\" width=\"523\" /></a></p>\n<p>然后到<a href=\"http://tunnelbroker.net/\">HE</a>创建一个tunnel，创建过程不表，界面留着别关。</p>\n<p><a href=\"http://lolis.info/wp-content/uploads/2011/08/image2.png\"><img alt=\"image\" border=\"0\" height=\"429\" src=\"http://lolis.info/wp-content/uploads/2011/08/image_thumb2.png\" title=\"image\" width=\"614\" /></a></p>\n<p>上图为很重要的配置页面，切记留住</p>\n<p>下面回到shell</p>\n<blockquote>\n<p>vi /etc/sysconfig/network</p>\n</blockquote>\n<p>加入以下内容：</p>\n<blockquote>\n<p>NETWORKING_IPV6=yes</p>\n<p>IPV6_DEFAULTDEV=sit1</p>\n</blockquote>\n<p>保存，创建/etc/sysconfig/network-scripts/ifcfg-sit1</p>\n<p>输入以下内容：</p>\n<blockquote>\n<p>DEVICE=sit1<span> </span>        <br />BOOTPROTO=none<span> </span>        <br />ONBOOT=yes<span> </span>        <br />IPV6INIT=yes<span> </span>        <br />IPV6TUNNELIPV4=HESupplied-ServerIPv4address<span> </span>          <br />IPV6ADDR=HESupplied-ClientIPv6address</p>\n</blockquote>\n<p>第一段高亮是HE的服务器IPv4地址，第二段是客户端IPv6地址，分别填写，注意别把/64也写进去了</p>\n<p>解释一下，上面是添加一个sit1的接口和HE的tunnel通信。</p>\n<p>启用这个接口执行：</p>\n<blockquote>\n<p>ifup sit1</p>\n</blockquote>\n<p>无回显则正常。</p>\n<p>重启网络服务：</p>\n<blockquote>\n<p>/etc/init.d/network restart</p>\n</blockquote>\n<p>要确保无错误才正常</p>\n<p>然后启用IPv6转发支持：</p>\n<p>在 /etc/sysconfig/network中，加入：</p>\n<blockquote>\n<p>IPV6FORWARDING=yes</p>\n</blockquote>\n<p>在/etc/sysconfig/network-scripts/ifcfg-eth0中，加入：</p>\n<blockquote>\n<p>IPV6_ROUTER=yes</p>\n</blockquote>\n<p>编辑转发选项（千万别和IPv4的转发混了，然后忘了添加）：</p>\n<blockquote>\n<p>vi /etc/sysctl.conf</p>\n</blockquote>\n<p>加入以下内容：</p>\n<blockquote>\n<p>net.ipv6.conf.all.forwarding = 1<span> </span>        <br />net.ipv6.conf.default.forwarding=1</p>\n</blockquote>\n<p>执行：</p>\n<blockquote>\n<p>sysctl -p</p>\n<p>/etc/init.d/network restart</p>\n</blockquote>\n<p>当重启网络服务时，这时候不应该再看见有如下错误：</p>\n<blockquote>\n<p>Bringing up interface eth0:  Global IPv6 forwarding is disabled in configuration, but not currently disabled in kernel<span> </span>        <br />Please restart network with ‘/sbin/service network restart’</p>\n</blockquote>\n<p>然后构建OVPN，具体不在这篇文章讨论范围内。在服务器配置文件中，加入如下几行：</p>\n<blockquote>\n<p>script-security 2<span> </span>        <br />client-connect /etc/openvpn/client-connect.sh<span> </span>        <br />client-disconnect /etc/openvpn/client-disconnect.sh</p>\n</blockquote>\n<p>保存，编辑/etc/openvpn/client-connect.sh<span> </span>      <br />输入：</p>\n<blockquote>\n<p>#!/bin/bash</p>\n<p># This is a script that is run each time a remote client connects<span> </span>        <br /># to this openvpn server.<span> </span>        <br /># it will setup the ipv6 tunnel depending on the ip address that was<span> </span>        <br /># given to the client</p>\n<p>BASERANGE=&#8221;2001:470:baa2&#8243;<span> </span>##你的48位的ipv6地址块前缀，见图<span> </span>          <br /># v6net is the last section of the ipv4 address that openvpn allocated<span> </span>        <br />V6NET=$(echo $ifconfig_pool_remote_ip | awk -F. ‘print $NF’)</p>\n<p>SITID=&#8221;sit$V6NET&#8221;</p>\n<p># setup the sit between the local and remote openvpn addresses<span> </span>        <br />/sbin/ip tunnel add $SITID mode sit ttl 64 remote $ifconfig_pool_remote_ip local $ifconfig_local<span> </span>        <br />/sbin/ip link set dev $SITID up</p>\n<p># config routing for the new network<span> </span>        <br />/sbin/ip -6 addr add $BASERANGE:$V6NET::1/64 dev $SITID<span> </span>        <br />/sbin/ip -6 route add $BASERANGE:$V6NET::/64 via $BASERANGE:$V6NET::2 dev $SITID metric 1</p>\n<p># log to syslog<span> </span>        <br />echo &#8220;$script_type client_ip:$trusted_ip common_name:$common_name local_ip:$ifconfig_local <span> </span>        <br />remote_ip:$ifconfig_pool_remote_ip sit:$SITID ipv6net:$V6NET&#8221; | /usr/bin/logger -t ovpn</p>\n</blockquote>\n<p>切记修改。</p>\n<p>编辑/etc/openvpn/client-disconnect.sh<span> </span>      <br />输入：</p>\n<blockquote>\n<p>#!/bin/bash</p>\n<p># This is a script that is run each time a remote client disconnects<span> </span>        <br /># to this openvpn server.</p>\n<p>BASERANGE=&#8221;2001:470:baa2&#8243;<span> </span>        <br /># v6net is the last section of the ipv4 address that openvpn allocated<span> </span>        <br />V6NET=$(echo $ifconfig_pool_remote_ip | awk -F. ‘print $NF’)</p>\n<p>SITID=&#8221;sit$V6NET&#8221;</p>\n<p>/sbin/ip -6 addr del $BASERANGE:$V6NET::1/64 dev $SITID</p>\n<p># remove the sit between the local and:q</p>\n<p>#remote openvpn addresses</p>\n<p>/sbin/ip link set dev $SITID down<span> </span>        <br />/sbin/ip tunnel del $SITID mode sit ttl 64 remote $ifconfig_pool_remote_ip local $ifconfig_local</p>\n<p># log to syslog<span> </span>        <br />echo &#8220;$script_type client_ip:$trusted_ip common_name:$common_name local_ip:$ifconfig_local <span> </span>        <br />remote_ip:$ifconfig_pool_remote_ip sit:$SITID ipv6net:$V6NET duration:$time_duration <span> </span>        <br />received:$bytes_received sent:$bytes_sent&#8221; | /usr/bin/logger -t ovpn</p>\n</blockquote>\n<p>黄字部分切记修改，见HE配置修改。</p>\n<p>然后配置权限：</p>\n<blockquote>\n<p>cd /etc/openvpn/</p>\n<p>chmod 777 ./*</p>\n</blockquote>\n<p>用killall openvpn杀死OVPN进程后，重载配置文件，连接一遍VPN，看是否连得上。</p>\n<p>连上OVPN后，在shell执行ifconfig -a<span> </span>应该能看见除了sit1外的sit接口，例如sit6等等。</p>\n<p>回到客户机，打开cmd，逐条输入以下指令：</p>\n<blockquote>\n<p>netsh interface ipv6 add v6v4tunnel interface=IP6Tunnel<span> </span>10.168.1.6 10.168.1.1<span> </span>          <br />netsh interface ipv6 add address IP6Tunnel<span> </span>2001:470:baa2:6::2/64<span> </span>        <br />netsh interface ipv6 add route ::/0 IP6Tunnel<span> </span>2001:470:baa2:6::1</p>\n</blockquote>\n<p>黄字部分是需要修改的，网段是OVPN分配的网段，2001:470:baa2:6::1是由ifconfig -a命令查得sit接口的IPv6地址得到的，两个地址保持前缀一致，后面的::2和::1不需要一致。</p>\n<p>连上OVPN，正常来说，ping一下<a href=\"http://ipv6.google.com/\">ipv6.google.com</a><span> </span>就会通了，如果不通，但是能解析出IPv6的IP，则说明是上述CMD命令有问题，应该删除后重新建立，否则会因为不会到达下一跳，出现ping不通，可 以解析的问题。但是同时要区别于IPv6 forward配置有误，IPv6 forward配置错误但是本地客户端无误，则应该出现可以ping通服务器本机的IPv6地址，ping不通其他地址的问题。</p>\n<p> </p>\n<p>配置过程中还出现过“OpenVPN: script failed: could not execute external program”之类的问题，均是由于教程不全面导致的奇奇怪怪的问题，均已经在本文修正，如果在配置过程中发现有其他问题，应该理清思路，逐点排查，将 错误定位在最小的范围内，才有希望能解决。</p>\n</p>\n<p></span></p>\n<p>  <a href=\"http://feeds.wordpress.com/1.0/gocomments/xijie.wordpress.com/4846/\" rel=\"nofollow\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/comments/xijie.wordpress.com/4846/\" /></a> <a href=\"http://feeds.wordpress.com/1.0/godelicious/xijie.wordpress.com/4846/\" rel=\"nofollow\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/delicious/xijie.wordpress.com/4846/\" /></a> <a href=\"http://feeds.wordpress.com/1.0/gofacebook/xijie.wordpress.com/4846/\" rel=\"nofollow\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/facebook/xijie.wordpress.com/4846/\" /></a> <a href=\"http://feeds.wordpress.com/1.0/gotwitter/xijie.wordpress.com/4846/\" rel=\"nofollow\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/twitter/xijie.wordpress.com/4846/\" /></a> <a href=\"http://feeds.wordpress.com/1.0/gostumble/xijie.wordpress.com/4846/\" rel=\"nofollow\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/stumble/xijie.wordpress.com/4846/\" /></a> <a href=\"http://feeds.wordpress.com/1.0/godigg/xijie.wordpress.com/4846/\" rel=\"nofollow\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/digg/xijie.wordpress.com/4846/\" /></a> <a href=\"http://feeds.wordpress.com/1.0/goreddit/xijie.wordpress.com/4846/\" rel=\"nofollow\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/reddit/xijie.wordpress.com/4846/\" /></a> <img alt=\"\" border=\"0\" height=\"1\" src=\"http://stats.wordpress.com/b.gif?host=xijie.wordpress.com&#038;blog=10068099&#038;post=4846&#038;subd=xijie&#038;ref=&#038;feed=1\" width=\"1\" /></p>\n<p><img src=\"http://chinadigitaltimes.net/chinese/files/2011/08/a39abb99image_thumb.png-150x150.png\" /></p>\n<p><small>本文由自动聚合程序取自网络，内容和观点不代表数字时代立场</small></p>\n<form method=\"POST\" action=\"http://www.feedblitz.com/f/f.fbz?AddNewUserDirect\">\n定期获得翻墙信息？<a href=\"http://www.feedblitz.com/f/?Sub=738338\">请电邮订阅数字时代</a> <br /><input name=\"EMAIL\" maxlength=\"64\" type=\"text\" size=\"25\" value=\"\"><br />\n<input name=\"FEEDID\" type=\"hidden\" value=\"738338\"><br />\n<input name=\"PUBLISHER\" type=\"hidden\" value=\"7485568\"><br />\n<input type=\"submit\" value=\"订阅!\"><br />\n</form>\n","author":936,"categories":[15300],"tags":[8510,8795]}