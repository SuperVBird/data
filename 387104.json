{"id":387104,"link":"https://chinadigitaltimes.net/chinese/2015/03/乌云｜漏洞分析-：百度统计js被劫持用来ddos-github/","date":"2015-03-28T01:54:58Z","modified":"2015-04-25T08:34:08Z","title":"乌云｜漏洞分析 ：百度统计js被劫持用来DDOS Github","content":"<blockquote><p><strong>背景新闻</strong>：G<a href=\"http://chinadigitaltimes.net/chinese/2015/03/github%E7%96%91%E9%81%AD%E6%9D%A5%E8%87%AA%E9%98%B2%E7%81%AB%E9%95%BF%E5%9F%8E%E7%9A%84%E5%A4%A7%E5%9E%8Bddos%E6%94%BB%E5%87%BB/\">ithub疑遭来自防火长城的大型DDoS攻击</a></p></blockquote>\n<h3>0x00 背景</h3>\n<p>今天中午刷着全国最大的信息安全从业人员同性交友社区zone.wooyun.org的时候，忽然浏览器每隔2秒就不断的弹窗：</p>\n<blockquote>\n<pre><code>malicious javascript detected on this domain\r\n</code></pre>\n</blockquote>\n<p><a href=\"http://chinadigitaltimes.net/chinese/files/2015/03/2015032705423060206s1.png\"><img class=\"alignnone  wp-image-387108\" src=\"http://chinadigitaltimes.net/chinese/files/2015/03/2015032705423060206s1.png\" alt=\"2015032705423060206s1\" width=\"600\" height=\"342\" srcset=\"https://chinadigitaltimes.net/chinese/files/2015/03/2015032705423060206s1.png 1440w, https://chinadigitaltimes.net/chinese/files/2015/03/2015032705423060206s1-300x171.png 300w, https://chinadigitaltimes.net/chinese/files/2015/03/2015032705423060206s1-1024x583.png 1024w\" sizes=\"(max-width: 600px) 100vw, 600px\" /></a></p>\n<p>我第一反应就是不知道哪个调皮的基友又把zone给XSS了，马上打开开发者工具分析。</p>\n<h3>0x01 细节</h3>\n<p>之后立刻发现弹窗的js居然是从github加载的：</p>\n<p><a href=\"http://chinadigitaltimes.net/chinese/files/2015/03/2015032705423358371s2.png\"><img class=\"alignnone wp-image-387109\" src=\"http://chinadigitaltimes.net/chinese/files/2015/03/2015032705423358371s2.png\" alt=\"2015032705423358371s2\" width=\"600\" height=\"178\" srcset=\"https://chinadigitaltimes.net/chinese/files/2015/03/2015032705423358371s2.png 1091w, https://chinadigitaltimes.net/chinese/files/2015/03/2015032705423358371s2-300x89.png 300w, https://chinadigitaltimes.net/chinese/files/2015/03/2015032705423358371s2-1024x303.png 1024w\" sizes=\"(max-width: 600px) 100vw, 600px\" /></a></p>\n<p>可是为什么乌云会从github加载js呢，并且还是从greatfire和纽约时报镜像加载。</p>\n<p>第一反应是页面有xss或者js被劫持了，找了半天终于找到了，居然是</p>\n<blockquote>\n<pre><code>hm.baidu.com/h.js\r\n</code></pre>\n</blockquote>\n<p>这个js的确被乌云加载了没错，这是百度统计的js代码，打开后里面是一个简单加密后的js，eval了一串编码后的内容，随便找了个在线解密看了下，发现如下内容:</p>\n<p><a href=\"http://chinadigitaltimes.net/chinese/files/2015/03/百度js.png\"><img class=\"alignnone  wp-image-387110\" src=\"http://chinadigitaltimes.net/chinese/files/2015/03/百度js.png\" alt=\"百度js\" width=\"540\" height=\"542\" srcset=\"https://chinadigitaltimes.net/chinese/files/2015/03/百度js.png 667w, https://chinadigitaltimes.net/chinese/files/2015/03/百度js-150x150.png 150w, https://chinadigitaltimes.net/chinese/files/2015/03/百度js-300x300.png 300w, https://chinadigitaltimes.net/chinese/files/2015/03/百度js-70x70.png 70w, https://chinadigitaltimes.net/chinese/files/2015/03/百度js-50x50.png 50w\" sizes=\"(max-width: 540px) 100vw, 540px\" /></a></p>\n<p>大概功能就是关闭缓存后每隔2秒加载一次</p>\n<blockquote>\n<pre><code>url_array = [\"https://github.com/greatfire/\", \"https://github.com/cn-nytimes/\"];\r\n</code></pre>\n</blockquote>\n<p>里面的两个url</p>\n<p>问了下墙内的小伙伴们，他们看到的js都是正常的，但是通过墙外ip访问</p>\n<blockquote>\n<pre><code>http://hm.baidu.com/h.js\r\n</code></pre>\n</blockquote>\n<p>就会得到上面的js文件，每隔2秒请求一下这两个url。</p>\n<p>打开twitter看了下，似乎从3月18号以来Github就受到了DDoS攻击，之后greatfire把被攻击的页面内容换成了</p>\n<div>\n<div id=\"highlighter_872835\" class=\"syntaxhighlighter  js\">\n<table border=\"0\" cellspacing=\"0\" cellpadding=\"0\">\n<tbody>\n<tr>\n<td class=\"gutter\">\n<div class=\"line number1 index0 alt2\">1</div>\n</td>\n<td class=\"code\">\n<div class=\"container\">\n<div class=\"line number1 index0 alt2\"><code class=\"js plain\">alert(</code><code class=\"js string\">\"WARNING: malicious javascript detected on this domain\"</code><code class=\"js plain\">)</code></div>\n</div>\n</td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n<p>以弹窗的方式阻止了js的循环执行。</p>\n<p><a href=\"http://chinadigitaltimes.net/chinese/files/2015/03/2015032705422816608s3-1.png\"><img class=\"alignnone  wp-image-387107\" src=\"http://chinadigitaltimes.net/chinese/files/2015/03/2015032705422816608s3-1.png\" alt=\"2015032705422816608s3 (1)\" width=\"600\" height=\"451\" srcset=\"https://chinadigitaltimes.net/chinese/files/2015/03/2015032705422816608s3-1.png 970w, https://chinadigitaltimes.net/chinese/files/2015/03/2015032705422816608s3-1-300x225.png 300w\" sizes=\"(max-width: 600px) 100vw, 600px\" /></a><br />\n<em>图3 国外ip traceroute到hm.baidu.com的记录</em></p>\n<p>似乎DNS并没有被劫持，看来是像之前一样直接把IP劫持了或者直接在HTTP协议里替换文件。</p>\n<p><a href=\"http://chinadigitaltimes.net/chinese/files/2015/03/2015032705422632644s4.png\"><img class=\"alignnone wp-image-387106\" src=\"http://chinadigitaltimes.net/chinese/files/2015/03/2015032705422632644s4.png\" alt=\"2015032705422632644s4\" width=\"600\" height=\"358\" srcset=\"https://chinadigitaltimes.net/chinese/files/2015/03/2015032705422632644s4.png 1440w, https://chinadigitaltimes.net/chinese/files/2015/03/2015032705422632644s4-300x179.png 300w, https://chinadigitaltimes.net/chinese/files/2015/03/2015032705422632644s4-1024x612.png 1024w, https://chinadigitaltimes.net/chinese/files/2015/03/2015032705422632644s4-80x48.png 80w\" sizes=\"(max-width: 600px) 100vw, 600px\" /></a></p>\n<p>扫了下端口，只开了80和443，通过https协议访问后是正常的空页面(只有带referer才会出现js文件)。</p>\n<p><a href=\"http://chinadigitaltimes.net/chinese/files/2015/03/2015032705422243412s5.png\"><img class=\"alignnone size-full wp-image-387105\" src=\"http://chinadigitaltimes.net/chinese/files/2015/03/2015032705422243412s5.png\" alt=\"2015032705422243412s5\" width=\"505\" height=\"248\" srcset=\"https://chinadigitaltimes.net/chinese/files/2015/03/2015032705422243412s5.png 505w, https://chinadigitaltimes.net/chinese/files/2015/03/2015032705422243412s5-300x147.png 300w\" sizes=\"(max-width: 505px) 100vw, 505px\" /></a></p>\n<p>作者要进行抓包分析时劫持已经停止，在<a href=\"http://chinadigitaltimes.net/chinese/2015/03/github%E7%96%91%E9%81%AD%E6%9D%A5%E8%87%AA%E9%98%B2%E7%81%AB%E9%95%BF%E5%9F%8E%E7%9A%84%E5%A4%A7%E5%9E%8Bddos%E6%94%BB%E5%87%BB/\">twitter</a>上看到有人已经分析过引用如下：</p>\n<blockquote><p>抓包跟踪，正常百度服务器返回给我日本VPS的TTL为51， RESP返回HTTP 200 OK的报文的TTL是47，可以确定的是有中间设备对VPS发了伪造报文。</p></blockquote>\n<p><a href=\"http://chinadigitaltimes.net/chinese/files/2015/03/CBFHgJ0UIAAtJ8R.png\"><img class=\"alignnone size-full wp-image-387025\" src=\"http://chinadigitaltimes.net/chinese/files/2015/03/CBFHgJ0UIAAtJ8R.png\" alt=\"CBFHgJ0UIAAtJ8R\" width=\"566\" height=\"473\" srcset=\"https://chinadigitaltimes.net/chinese/files/2015/03/CBFHgJ0UIAAtJ8R.png 566w, https://chinadigitaltimes.net/chinese/files/2015/03/CBFHgJ0UIAAtJ8R-300x251.png 300w\" sizes=\"(max-width: 566px) 100vw, 566px\" /></a></p>\n<p>真是无耻，呵呵</p>\n<p>忽然想起一句话,之前DNS被劫持到外国服务器的时候某站长说的:</p>\n<blockquote>\n<pre><code>They have weaponized their entire population.\r\n</code></pre>\n</blockquote>\n<p>现在应该是:</p>\n<blockquote>\n<pre><strong><code>They have weaponized their entire population of the Earth.</code></strong></pre>\n</blockquote>\n","author":980,"categories":[18271,18270,18269,9203],"tags":[3,7775,27432,13070,22609,9250,10268,27581,12948,8894,8817]}