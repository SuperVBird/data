{"id":168267,"link":"https://chinadigitaltimes.net/chinese/2011/07/ios开发之免改hosts翻墙/","date":"2011-07-23T21:30:22Z","modified":"2011-07-23T21:30:22Z","title":"iOS开发之免改hosts翻墙","content":"<p><p>来源：<a href=\"http://www.keakon.net/2011/07/10/iOS%E5%BC%80%E5%8F%91%E4%B9%8B%E5%85%8D%E6%94%B9hosts%E7%BF%BB%E5%A2%99\">http://www.keakon.net/2011/07/10/iOS%E5%BC%80%E5%8F%91%E4%B9%8B%E5%85%8D%E6%94%B9hosts%E7%BF%BB%E5%A2%99</a>  </p>\n<p>在开发iOS的web应用时，不可避免地会遇到一些被墙的网站。使用VPN或代理服务器自然是可以解决的，不过成本比较高。而Google的大部分服务都有很多IP，可以通过修改hosts文件来翻墙访问，但在iOS设备上却需要用户去越狱才能修改，显得颇为不便。  <br />好在HTTP请求其实也是使用socket，在请求前要用socket连接服务器，提供域名/IP和端口，这里只要改成可用的IP就能连上了。在连接之后，还要提供访问方法、路径、Host等其他头字段，这里只要把Host改成原本的域名即可。  </p>\n<p>举例来说，我们要访问&#8221;<a href=\"https://docs.google.com/?pli=1\">https://docs.google.com/?pli=1</a>&#8220;，那么标准的方法是这样的：  </p>\n<blockquote><p># 先连接docs.google.com:443，再发送下列HTTP头   <br />GET /?pli=1 HTTP 1.1    <br />Host: <a href=\"http://docs.google.com\">docs.google.com</a>    <br /># 其他头省略⋯</p></blockquote>\n<p> 而由于GFW的存在，我们在连接<a href=\"http://docs.google.com:443\">docs.google.com:443</a>时就超时或证书被劫持了，无法继续下面的步骤。  </p>\n<p>而新方法则是这样：  </p>\n<blockquote><p># 先连接<a href=\"http://docs.google.com\">docs.google.com</a>的某个可用IP:443，再发送下列HTTP头    <br />GET /?pli=1 HTTP 1.1    <br />Host: <a href=\"http://docs.google.com\">docs.google.com</a>    <br /># 其他头省略⋯</p></blockquote>\n<p> 现在连接可以顺利完成，但可能还会出现Host无法通过SSL验证的情况，这时只要不对HTTPS请求进行验证即可（因为我们信任这个IP）。  </p>\n<p>不过，要让NSURLConnection忽略SSL验证比较麻烦，想知道的可以参考<a href=\"http://www.iphonedevsdk.com/forum/iphone-sdk-development/5423-nsurlerrordomain-bad-server-certificate.html\">《NSURLErrorDomain &#8220;bad server certificate&#8221;》</a>，这里我就直接用第三方的<a href=\"http://allseeing-i.com/ASIHTTPRequest\">ASIHTTPRequest</a>库来演示了。  </p>\n<p>先是标准方法：   </p>\n<pre><code>NSURL *url = [NSURL URLWithString:@\"<a href=\"https://docs.google.com/?pli=1\">https://docs.google.com/?pli=1</a>\"]; ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:url]; [request startSynchronous]; NSLog(@\"%@\", [request error]);</code></pre>\n<p>会得到如下错误，看上去GFW把证书给劫持了：</p>\n</p>\n<blockquote>\n<p>Domain=ASIHTTPRequestErrorDomain Code=1 &#8220;A connection failure occurred: SSL problem (Possible causes may include a bad/expired/self-signed certificate, clock set to wrong date)&#8221; UserInfo=0x4c7d6e0 NSUnderlyingError=0x4c8d520 &#8220;The operation couldn’t be completed. (OSStatus error -9810.)&#8221;, NSLocalizedDescription=A connection failure occurred: SSL problem (Possible causes may include a bad/expired/self-signed certificate, clock set to wrong date)</p>\n</blockquote>\n<p>新方法：</p>\n</p>\n<pre><code>NSURL *url = [NSURL URLWithString:@\"<a href=\"https://xn--ip-gy2c332hbms6ua/?pli=1\">https://某个神秘IP/?pli=1</a>\"]; // 连接的地址改成其他其他IP ASIHTTPRequest *request = [ASIHTTPRequest requestWithURL:url]; [request addRequestHeader:@\"Host\" value:@\"<a href=\"http://docs.google.com\">docs.google.com</a>\"]; // 手动设置Host字段 [request setValidatesSecureCertificate:NO]; // 不进行验证 NSLog(@\"%@\", [request responseString]);</code></pre>\n<p>这下就能看到HTML文档了。</p>\n<p>至于这些IP是什么我就不说了，原因你懂的。</p>\n<p>  <a href=\"http://feeds.wordpress.com/1.0/gocomments/xijie.wordpress.com/4765/\" rel=\"nofollow\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/comments/xijie.wordpress.com/4765/\" /></a> <a href=\"http://feeds.wordpress.com/1.0/godelicious/xijie.wordpress.com/4765/\" rel=\"nofollow\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/delicious/xijie.wordpress.com/4765/\" /></a> <a href=\"http://feeds.wordpress.com/1.0/gofacebook/xijie.wordpress.com/4765/\" rel=\"nofollow\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/facebook/xijie.wordpress.com/4765/\" /></a> <a href=\"http://feeds.wordpress.com/1.0/gotwitter/xijie.wordpress.com/4765/\" rel=\"nofollow\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/twitter/xijie.wordpress.com/4765/\" /></a> <a href=\"http://feeds.wordpress.com/1.0/gostumble/xijie.wordpress.com/4765/\" rel=\"nofollow\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/stumble/xijie.wordpress.com/4765/\" /></a> <a href=\"http://feeds.wordpress.com/1.0/godigg/xijie.wordpress.com/4765/\" rel=\"nofollow\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/digg/xijie.wordpress.com/4765/\" /></a> <a href=\"http://feeds.wordpress.com/1.0/goreddit/xijie.wordpress.com/4765/\" rel=\"nofollow\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/reddit/xijie.wordpress.com/4765/\" /></a> <img alt=\"\" border=\"0\" height=\"1\" src=\"http://stats.wordpress.com/b.gif?host=xijie.wordpress.com&#038;blog=10068099&#038;post=4765&#038;subd=xijie&#038;ref=&#038;feed=1\" width=\"1\" /></p>\n</p>\n<p><img src=\"http://feeds.wordpress.com/1.0/comments/xijie.wordpress.com/4765/\" /></p>\n<p><small>本文由自动聚合程序取自网络，内容和观点不代表数字时代立场</small></p>\n<form method=\"POST\" action=\"http://www.feedblitz.com/f/f.fbz?AddNewUserDirect\">\n定期获得翻墙信息？<a href=\"http://www.feedblitz.com/f/?Sub=750556\">请电邮订阅数字时代</a> <br /><input name=\"EMAIL\" maxlength=\"64\" type=\"text\" size=\"25\" value=\"\"><br />\n<input name=\"FEEDID\" type=\"hidden\" value=\"750556\"><br />\n<input name=\"PUBLISHER\" type=\"hidden\" value=\"7485568\"><br />\n<input type=\"submit\" value=\"订阅!\"><br />\n</form>\n","author":958,"categories":[15300],"tags":[8510,8795]}