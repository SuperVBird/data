{"id":178850,"link":"https://chinadigitaltimes.net/chinese/2011/09/翻墙-在-vps-上搭建-openvpn-简易教程/","date":"2011-09-13T04:00:34Z","modified":"2011-09-13T22:46:47Z","title":"翻墙 | 在 VPS 上搭建 OpenVPN 简易教程","content":"<p>来源：<a rel=\"nofollow\" href=\"http://jingpin.org/set-up-openvpn-in-vps/\" target=\"_blank\">http://jingpin.org/set-up-openvpn-in-vps/</a></p>\n<p>虽然都是 VPN， 但 <a rel=\"nofollow\" href=\"http://jingpin.org/how-to-set-up-pptp-vpn-in-a-vps/\" target=\"_blank\">PPTP</a> 和 <a rel=\"nofollow\" href=\"http://jingpin.org/set-up-l2tp-ipsec-in-a-vps/\" target=\"_blank\">L2TP/IPSec</a> 主要适用于 Xen，而 OpenVPN 则既可以在 Xen 也可以在 OpenVZ 类型的 VPS 上搭建，只不过你需要安装一个客户端才能使用。</p>\n<p>这 篇文章将介绍如何仅通过 10 个步骤就可以成功搭建 OpenVPN 的方法，而你需要的仅是一个 VPS 和一台可以上网的电脑。和 PPTP 以及  L2TP/IPSec 的一样，以下 OpenVPN 的搭建教程也是基于 Xen VPS 的 Ubuntu 系统以及 Mac  电脑自带的终端应用程序，对 Linux 来讲，操作步骤几乎一模一样，但是对 Windows 来讲，你就需要事先安装 Putty 软件。 <span> </span></p>\n<h2>I、连接 VPS</h2>\n<p>打开终端应用程序并输入以下命令：</p>\n<p>ssh root@xxx.xxx.xxx.xxx</p>\n<p>记得把 &#8220;xxx.xxx.xxx.xxx&#8221; 替换成你 VPS 的 IP 地址，例如 &#8220;178.18.17.142″。</p>\n<p><strong>小技巧：</strong>关于如何连接的更多信息，可以参考 <a rel=\"nofollow\" href=\"http://jingpin.org/how-to-set-up-pptp-vpn-in-a-vps/\" target=\"_blank\">PPTP</a> 的搭建教程。</p>\n<h2>II、安装 OpenVPN</h2>\n<p>输入以下命令：</p>\n<blockquote><p>apt-get install openvpn</p></blockquote>\n<p>回车，输入 &#8220;y&#8221;，再回车。</p>\n<h2>III、移动 easy-rsa 文件夹</h2>\n<p>输入以下命令：</p>\n<blockquote><p>cp -R /usr/share/doc/openvpn/examples/easy-rsa /etc/openvpn</p></blockquote>\n<p>回车完成将 easy-rsa 文件夹复制到 OpenVPN 根目录的操作。</p>\n<h2>IV、生成加密文件</h2>\n<p>一行一行地输入以下命令，每行都要回车，在出现 &#8220;yes/no&#8221; 问题的地方输入 &#8220;yes&#8221; 再回车：</p>\n<blockquote><p>cd /etc/openvpn/easy-rsa/2.0</p>\n<p>. ./vars</p>\n<p>./clean-all</p>\n<p>./build-ca</p>\n<p>./build-key-server server</p>\n<p>./build-key client</p>\n<p>./build-dh</p></blockquote>\n<p><strong>小技巧：</strong>你可以将 &#8220;client&#8221; 改成任意的名字，但是下面的步骤也要跟着改。</p>\n<h2>V、应用 iptables 规则</h2>\n<p>这个步骤将使你的 OpenVPN 连接到互联网：</p>\n<p><strong>1、转发 IP</strong></p>\n<p>输入以下命令：</p>\n<blockquote><p>vi /etc/sysctl.conf</p></blockquote>\n<p>回车，找到 &#8220;#net.ipv4.ip_forward=1&#8221; 这一行，按 &#8220;x&#8221; 键删除那个 &#8220;#&#8221; 号，然后输入 &#8220;:wq&#8221; 保存。</p>\n<p><strong>2、使转发生效</strong></p>\n<p>输入以下命令：</p>\n<blockquote><p>sysctl -p</p></blockquote>\n<p>如果一切正常，你将只会看到以下结果：</p>\n<blockquote><p>net.ipv4.ip_forward=1</p></blockquote>\n<p><strong>3、创建 iptables 规则</strong></p>\n<p>输入以下命令：</p>\n<blockquote><p><code>iptables -t nat -A POSTROUTING -s <a rel=\"nofollow\" href=\"http://10.8.0.0/24\" target=\"_blank\">10.8.0.0/24</a> -o eth0 -j SNAT --to 178.18.17.142</code></p></blockquote>\n<p>记得将 &#8220;178.18.17.142&#8221; 改为你 VPS 的 IP 地址。</p>\n<p><strong>小技巧：</strong>如果是 OpenVZ 类型的 VPS，则需要将 &#8220;eth0&#8221; 替换成 &#8220;venet0&#8243;。</p>\n<h2>VI、创建 VPS 上的 OpenVPN 配置文件</h2>\n<p>输入以下命令：</p>\n<blockquote><p># vi /etc/openvpn/server.conf</p></blockquote>\n<p>回车，按下 &#8220;i&#8221; 键，然后粘贴以下内容：</p>\n<blockquote><p><code>port 1194<br />\nproto udp<br />\ndev tun<br />\nca /etc/openvpn/easy-rsa/2.0/keys/ca.crt<br />\ncert /etc/openvpn/easy-rsa/2.0/keys/server.crt<br />\nkey /etc/openvpn/easy-rsa/2.0/keys/server.key<br />\ndh /etc/openvpn/easy-rsa/2.0/keys/dh1024.pem<br />\nserver 10.8.0.0 255.255.255.0<br />\nifconfig-pool-persist ipp.txt<br />\npush \"redirect-gateway def1 bypass-dhcp\"<br />\npush \"dhcp-option DNS 8.8.8.8\"<br />\npush \"dhcp-option DNS 8.8.4.4\"<br />\nclient-to-client<br />\nduplicate-cn<br />\nkeepalive 10 120<br />\ncomp-lzo<br />\nuser nobody<br />\ngroup nogroup<br />\npersist-key<br />\npersist-tun<br />\nstatus openvpn-status.log<br />\nlog /var/log/openvpn.log<br />\nverb 3</code></p></blockquote>\n<p>按下 &#8220;esc&#8221; 键退出插入模式，输入 &#8220;:wq&#8221; 保存文件。</p>\n<p><strong>小技巧：</strong>你也可以将 8.8.8.8 和 8.8.4.4 分别替换成 208.67.222.222 和 208.67.220.220。</p>\n<h2>VII、启动 OpenVPN</h2>\n<p>输入以下命令：</p>\n<blockquote><p># /etc/init.d/openvpn start</p></blockquote>\n<p>回车。</p>\n<h2>VIII、创建电脑上的 OpenVPN 配置文件</h2>\n<p>输入以下命令：</p>\n<blockquote><p>vi /etc/openvpn/easy-rsa/2.0/keys/client.conf</p></blockquote>\n<p>回车，按下 &#8220;i&#8221; 键，并粘贴以下内容：</p>\n<blockquote><p><code>client<br />\ndev tun<br />\nproto udp<br />\nremote 178.18.17.142 1194<br />\nresolv-retry infinite<br />\nnobind<br />\npersist-key<br />\npersist-tun<br />\nca ca.crt<br />\ncert client.crt<br />\nkey client.key<br />\ncomp-lzo<br />\nverb 3<br />\nredirect-gateway<br />\nscript-security 2</code></p></blockquote>\n<p>记得将 &#8220;178.18.17.142&#8221; 换成你 VPS 的 IP 地址。</p>\n<p>完了之后，按下 &#8220;esc&#8221; 键退出插入模式，输入 &#8220;:wq&#8221; 保存。</p>\n<h2>IX、重启</h2>\n<p>为了避免 VPS 重启后重新设置一遍 iptables 规则，你可以输入以下命令：</p>\n<blockquote><p>vi /etc/rc.local</p></blockquote>\n<p>回车，按下 &#8220;i&#8221; 键，并将以下内容粘贴到 &#8220;exit 0&#8221; 这一行的上面：</p>\n<blockquote><p><code>iptables -t nat -A POSTROUTING -s <a rel=\"nofollow\" href=\"http://10.8.0.0/24\" target=\"_blank\">10.8.0.0/24</a> -o eth0 -j SNAT --to 178.18.17.142</code><br />\n<code>openvpn /etc/openvpn/server.conf</code></p></blockquote>\n<p>记得将 &#8220;178.18.17.142″ 替换成你 VPS 的 IP 地址，完了之后，按下 &#8220;esc&#8221; 键退出插入模式，然后输入 &#8220;:wq&#8221; 保存。</p>\n<p><strong>小技巧：</strong>以上的命令是针对 Xen 类型的 VPS，如果是 OpenVZ 类型的，则需要将 &#8220;eth0&#8221; 替换成 &#8220;venet0&#8243;。</p>\n<h2>X、将配置文件下载到电脑里</h2>\n<p>电脑上需要有以下四个 OpenVPN 的配置文件：</p>\n<ul>\n<li>client.conf</li>\n<li>ca.crt</li>\n<li>client.crt</li>\n<li>client.key</li>\n</ul>\n<p>要下载以上文件，你可以使用 <a rel=\"nofollow\" href=\"http://fetchsoftworks.com/\" target=\"_blank\">Fetch</a> (Mac)、<a rel=\"nofollow\" href=\"http://winscp.net/\" target=\"_blank\">WinSCP</a> (Windows) 或者其他 SFTP 软件，也可以直接在 Mac 的终端上使用以下 SSH 命令：</p>\n<p><strong>1、进入文件所在的目录</strong></p>\n<p>输入以下命令：</p>\n<blockquote><p>cd /etc/openvpn/easy-rsa/2.0/keys/</p></blockquote>\n<p>回车。</p>\n<p><strong>2、下载文件</strong></p>\n<p>输入以下命令：</p>\n<blockquote><p>scp ca.crt client.crt client.key client.conf <a rel=\"nofollow\" href=\"mailto:air@68.68.40.151\" target=\"_blank\">air@68.68.40.151</a>:</p></blockquote>\n<p>记得将 &#8220;air&#8221; 换成你电脑的用户名，将 &#8220;68.68.40.151&#8221; 换成你本地的 IP ―― 这个你可以通过以下方法获得：</p>\n<p>首先，打开一个新的终端窗口，接着输入 &#8220;ifconfig&#8221;，回车，如果结果包含一行 &#8220;ppp0&#8221; 的类似如下的内容：</p>\n<p><img title=\"terminal-scp-ip\" src=\"http://freenuts.com/images/terminal-scp-ip.jpg\" alt=\"How to set up OpenVPN\" width=\"530\" height=\"332\" /></p>\n<p>那么第一个 inet 值就是你本地的 IP，如果没有 &#8220;ppp0&#8221; 这一行，那么你就不能通过以上的 SCP 命令直接从 VPS 上下载文件。</p>\n<p>完了之后，回车，输入 &#8220;yes&#8221;，如果电脑有设置密码，则接着输入电脑密码，然后那 4 个文件就会被下载到该用户名的根目录。</p>\n<p><strong>3、移动下载文件</strong></p>\n<p>完了之后，找到下载的文件并复制粘贴到电脑上 OpenVPN 的 Configurations 文件夹，然后，你的 OpenVPN 就可以翻墙了。</p>\n<h2>额外收获：</h2>\n<p>以下是一个根据以上步骤搭建的 OpenVPN：</p>\n<p><a rel=\"nofollow\" href=\"http://freenuts.com/images/FreeNuts-OpenVPN.zip\" target=\"_blank\">FreeNuts OpenVPN</a></p>\n<p>这个 OpenVPN 将免费大概一个月，你可以下载并参考<a rel=\"nofollow\" href=\"http://freenuts.com/how-to-set-up-vpn-in-your-computer-and-mobile-phone/\" target=\"_blank\">这篇文章</a>在电脑或者手机上试用。</p>\n","author":1,"categories":[15300],"tags":[8510,8795]}