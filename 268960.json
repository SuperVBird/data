{"id":268960,"link":"https://chinadigitaltimes.net/chinese/2012/12/翻墙-openvpn配置静态共享密钥，应对防火长城（gfw）封/","date":"2012-12-18T20:00:38Z","modified":"2012-12-18T20:00:38Z","title":"翻墙 | OpenVPN配置静态共享密钥，应对防火长城（GFW）封锁","content":"<p><b>1. 背景：</b></p>\n<p>防火长城在十八大期间前所未有的升级，导致大批OpenVPN不能访问了。</p>\n<p><b>2. 原因分析：</b></p>\n<p>OpenVPN象几乎所有的安全通信协议的缺陷一样，最开始的密钥交换阶段所有交互流量都是明文的。防火长城或许发现了其中的一些特征（signature，比如某些字符串)，这些特征是其他应用协议中不会出现的。然后，GFW或许象当年封锁Tor 一样 [2]，模仿OpenVPN客户端去连接 服务器。尽管不太可能成功连接，但是可以确认服务器是否是OpenVPN。然后的动作可以想象：TCP RST 或者封地址，甚者有可能有串联的设备动态丢包了。</p>\n<p><b>3. 应对方法（之一）：</b></p>\n<p>既然密钥交换过程容易被发现，我们就不做密钥交换了吧，使用预先商定的密钥。尽管这对于安全性要求高的应用有风险，但是对于我们小老百姓翻墙，已经足够了。</p>\n<p>这种方法还有一个限制：只能有一个服务器、一个客户端。好在客户端（一般在国内）可以配置成PPTP VPN服务器，于是，用这种方法最好是这样的结构：</p>\n<p>OpenVPN Server <------> OpenVPN Client | PPTP Server <---> Multiple PPTP Clients<br /></---></------><br /><b>4. 操作步骤</b></p>\n<p>参照［1］，这里只介绍OpenVPN客户和服务器之间的共享密钥配置，具体操作如下：</p>\n<p>1） 在服务器上运行下面的命令，生成共享密钥（2048 bit ，足够了吧？）</p>\n<pre><strong>openvpn --genkey --secret static.key</strong></pre>\n<pre><b><br /></b></pre>\n<pre><b><br /></b></pre>\n<p>把生成的static.key 传到客户端 openvpn 配置文件所在目录下，如/etc/openvpn</p>\n<p>2）服务器端的配置：</p>\n<p>dev tun<br />ifconfig 10.8.0.1 10.8.0.2<br />secret static.key<br />proto udp<br /># 选一个随机的端口，至少不要用缺省的1194<br />port  35287<br />comp-lzo<br />log-append  openvpn-static.log<br /><b><br /></b>3）客户端的配置：</p>\n<p>#端口需要与服务器设置的端口一致<br />remote IP_address_of_your_server 35287<br />proto udp<br />dev tun<br />ifconfig 10.8.0.2 10.8.0.1<br />secret static.key<br />#如果客户端不制定端口，使用缺省的1194，仍然容易被发现<br />port 23456</p>\n<div>\n<div>comp-lzo</div>\n<div>log-append openvpn-static.log</div>\n</div>\n<div>\n<div>redirect-gateway def1</div>\n</div>\n<div></div>\n<div>注意：不能同时配置证书认证、同时又配置静态密钥认证。</div>\n<div></div>\n<div>然后，可以配置本地路由，使国内访问不经过VPN。</div>\n<div></div>\n<div></div>\n<div><b>5. 参考：</b></div>\n<div></div>\n<div>[1] <a rel=\"nofollow\" target=\"_blank\" href=\"https://www.usenix.org/conference/foci12/how-great-firewall-china-blocking-tor\">How the Great Firewall of China is Blocking Tor</a></p>\n","author":1005,"categories":[18269,15300],"tags":[8817]}