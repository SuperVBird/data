{"id":142677,"link":"https://chinadigitaltimes.net/chinese/2011/04/如何避免-vpn-连接后会降低本地网络访问速度的问题/","date":"2011-04-04T00:31:02Z","modified":"2011-04-04T00:31:02Z","title":"如何避免 VPN 连接后会降低本地网络访问速度的问题","content":"<p>来源：<a href=\"http://www.cnblogs.com/dancefire/archive/2011/03/28/how-to-setup-vpn-cn-route.html\">http://www.cnblogs.com/dancefire/archive/2011/03/28/how-to-setup-vpn-cn-route.html</a></p>\n<div>\n<h1>前言</h1>\n<p>上回说到了<a href=\"http://www.cnblogs.com/dancefire/archive/2011/03/28/how-to-use-strongvpn.html\">通过 VPN 进行加速</a>， 有不少朋友已经体会到了 VPN 的好处，许多网站从缓慢到无法访问，变得可以流畅的访问了。但是，我们经常面临一个问题，VPN 拨通后，所有流量都会流经 VPN，导致本地的网络访问可能会很不顺畅，有的速度非常缓慢，有的甚至不能访问。特别是对于那些在使用 VPN 同时还在进行本地下载的用户，这个问题更加明显。对于那些收费的 VPN 而言，因为它们速度较快，所以感觉问题不大。但是，对于那些免费的、速度比较缓慢、甚至限制流量的 VPN 来说，这就是一个比较严重的问题了。很多人不得不同时只干一件事情，要使用 VPN 就停止本地网络的访问，要访问本地网络就需要断开 VPN。那么，可不可以只有访问镇外的流量走 VPN，而本地网络依旧使用本地连接呢？答案自然是可以的。 </p>\n<h1>解决方案</h1>\n<p>其实这个问题在使用 VPN 之前就存在过。使用过教育网的朋友肯定有经验，国内流量是免费的，而国外流量是收费的。一般来说大家都会访问国内网络，但是毕竟偶尔也需要访问国外网络。 有的学校做的比较一刀切，干脆禁止国外流量，而有的学校则收取国外流量高昂的费用。所以，在教育网生活的时间，大家都到处寻找国内代理服务器，一时间代理 服务器搜索软件、代理服务器列表比比皆是。当时我们学校面临这个问题的时候，我们采用了另外一种办法，除了教育网光纤接入外，我们还申请了电信的包月 ADSL 作为第二链路。当时对于非服务器的网段使用的是 NAT，分别在教育网和ADSL接入上做NAT。然后，修改路由设置，凡是国内流量，都路由到教育网光纤接口；凡是国外流量，都路由到电信的 ADSL 接口。虽然，国外流量的带宽不大，但是对于当时的学生对国外网站的需求不高的情况下，这个问题还是得到了很好的解决。 </p>\n<p>再回过来看我们 VPN 的问题，会发现其实是一个问题。我们可以添加路由，将所有本地的网络(如上例的所有国内网络范围)，路由到我们使用 VPN 前的默认网关。而剩余的，也就是国外的网络范围，自动流经 VPN。这就很好的解决了 VPN 降低本地网络访问速度的问题。 </p>\n<p>然后，我们需要寻找到本地的 IP 地址范围，在本例中，我使用的是国内的地址范围。因为这个数据库属于公开数据，我们可以从 CNNIC 或者 APNIC 获得相关数据。剩下的就是对地址库进行分析，然后生成路由添加和删除的脚本就可以了。  </p>\n<p>由于我的机器分别有 Ubuntu 和 Windows 7，因此，我将针对这两个系统写脚本。脚本语言不同，但是参数是一样的。  </p>\n<ul>\n<li>on    表明开启国内路由走默认网关的配置。也就是说添加国内网络的路由指向原默认网关。  </li>\n<li>off    表明关闭这个功能。也就是说删除之前操作所添加的路由。  </li>\n<li>update    是指下载更新 IP 地址库。 </li>\n</ul>\n<h1>代码编写以及使用</h1>\n<h2>Linux </h2>\n<p>对于 Linux 最通用的莫过于 Shell 了，因此，我使用 Bash 完成了这个脚本。虽然我是在 Ubuntu 系统上测试的，但是它应该支持大部分 Linux 系统。  </p>\n<p>下载脚本到本地 </p>\n<pre>wget <a href=\"http://files.cnblogs.com/dancefire/vpnroute.zip\">http://files.cnblogs.com/dancefire/vpnroute.zip</a><br> unzip vpnroute.zip<br>sudo bash vpnroute.sh on </pre>\n<p>需要删除添加的路由，可以执行： </p>\n<pre>sudo bash vpnroute.sh off </pre>\n<p>需要更新网络路由数据，可以执行： </p>\n<pre>bash vpnroute.sh update </pre>\n<h2>Windows </h2>\n<p>Windows 的批处理文件虽然也能写一些东西，但是总觉得它的功能太受限了。因此，这次我使用 <a href=\"http://technet.microsoft.com/en-us/scriptcenter/dd742419\">PowerShell</a> 来写这个脚本。<a href=\"http://zh.wikipedia.org/zh-cn/Windows_PowerShell\">PowerShell</a> 是微软 2006 年推出的抗衡 *nix 中的 shell 的产品，通过紧密结合 .Net Framework 大幅提高命令行及脚本的能力。熟悉 linux shell 脚本的朋友会在使用中会发现有很多语法似曾相识。虽然有各种不适应，但是不得不说 PowerShell 还是很强大的。 </p>\n<p>下载脚本 <a href=\"http://files.cnblogs.com/dancefire/vpnroute.zip\">http://files.cnblogs.com/dancefire/vpnroute.zip</a> 到某个目录，比如 d:tmp  </p>\n<p>修改 PowerShell 执行权限，默认只能执行签名脚本。：  </p>\n<p><strong>开始->附件->Windows PowerShell->右键点击 Windows PowerShell->以管理员身份执行 </strong> </p>\n<p>在命令行里执行： </p>\n<pre>Set-ExecutionPolicy -ExecutionPolicy Unrestricted</pre>\n<p>可能会提示如下信息： </p>\n<pre>执行策略更改<br>执行策略可以防止您执行不信任的脚本。更改执行策略可能会使您面临<br> about_Execution_Policies <br>帮助主题中所述的安全风险。是否要更改执行策略?<br>[Y] 是(Y) [N] 否(N) [S] 挂起(S) [?] 帮助 (默认值为“Y”):</pre>\n<p>选择 Y，或者回车即可。  </p>\n<p>然后，进入下载文件所在目录，执行脚本 </p>\n<pre> </pre>\n<pre>cd d:tmp</pre>\n<pre>.vpnroute.ps1</pre>\n<p>如果脚本可以执行，它会返回如下帮助信息：  </p>\n<pre>PS d:tmp> .vpnroute.ps1<br> Route networks of CN to the default gateway instead of VPN tunnel<br><br>usage: vpnroute.ps1 on<br><br>\ton\tAdd routes of CN to default gateway<br>\toff\tRemove routes of CN<br>\tupdate\tForce download/update CN network data</pre>\n<p>如要添加路由，希望所有中国范围的IP使用默认的网关访问，就运行： </p>\n<pre>.vpnroute.ps1 on</pre>\n<p>如果想要去掉添加的路由，就运行 </p>\n<pre>.vpnroute.ps1 off</pre>\n<p>想更新中国IP路由数据，就运行 </p>\n<pre>.vpnroute.ps1 update</pre>\n<p>我注意到 Windows 的 PowerShell 脚本执行速度不是很高，在 Linux 上使用 Bash 添加路由大约只需要10-20秒，在 Windows 上使用 PowerShell 需要 70-80 秒。大家如果看到有段时间没响应，不要着急，给他一些时间就会好的。 </p>\n<p>连接后，分别访问 <a href=\"http://www.ip.cn/\">http://www.ip.cn</a> 和 <a href=\"http://whatismyipaddress.com/\">http://whatismyipaddress.com</a> 以测试路由设置是否正常。  </p>\n<p>如果路由添加正确，访问国内网站 <a href=\"http://www.ip.cn/\">http://www.ip.cn</a> 应该看到的是你国内的 ip。而访问国外网站 <a href=\"http://whatismyipaddress.com/\">http://whatismyipaddress.com</a> ，应该看到的是你 vpn 的 ip。</p>\n</div>\n<p> </p>\n<h4>—————————————————————————————————————————</h4>\n<h4>需要翻墙利器赛风? 请<a href=\"https://www.google.com/profiles/112915952962578336480\">阅读和关注中国数字时代</a>。</p>\n<p>推特用户请点击<a href=\"http://qinzhigang.in/login.php\">这里</a>免翻墙上推特</h4>\n<p>请点击<a href=\"https://sesawe.net/-Tools-zh-.html\">这里</a>下载翻墙软件 </p>\n<p>更多翻墙方法请发电邮(最好用Gmail)到：<a href=\"mailto:fanqiang70ma@gmail.com\">fanqiang70ma@gmail.com</a>  </p>\n<p>请阅读和关注<a href=\"https://www.google.com/profiles/112915952962578336480\">中国数字时代</a>、翻墙技术博客<a href=\"https://www.google.com/profiles/chinagfwblog\">GFW BLOG</a>（免翻墙）  </p>\n<p>请使用<a href=\"https://www.google.com/reader/view/\">Google Reader</a><a href=\"https://www.google.com/reader/view/feed/http://chinadigitaltimes.net/chinese/feed\">订阅中国数字时代中文版</a>（<a href=\"http://chinadigitaltimes.net/chinese/feed\">http://chinadigitaltimes.net/chinese/feed</a>），阅读最有价值的中文信息；以及<a href=\"https://www.google.com/reader/view/feed/http://feeds2.feedburner.com/chinagfwblog\">GFW BLOG（功夫网与翻墙）</a><a href=\"http://feeds2.feedburner.com/chinagfwblog\">http://feeds2.feedburner.com/chinagfwblog</a>，获取最新翻墙工具和翻墙技巧信息。</p>\n<p>  </p>\n<div>要翻墙? <a href=\"http://ziyouxinxi.info/\">用赛风</a>.<br />\n推特用户请点击<a href=\"http://edu20.in/login.php\">这里</a>免翻墙上推特<wbr><br />\n点击<a href=\"http://fanqiangsesawe.info\">这里</a>下载翻墙软件<br />\n更多翻墙方法请发电邮(最好用Gmail)到:gongminshehui1@gmail.com<br />\n翻墙技术博客<a href=\"https://www.google.com/profiles/chinagfwblog\">GFW BLOG</a>（免翻墙）<br />\n阅读<a href=\"http://www.google.com/profiles/112915952962578336480\">中国数字时代</a>（免翻墙）<img alt=\"\" height=\"1\" src=\"https://blogger.googleusercontent.com/tracker/5500297126185736776-99456282051806461?l=www.chinagfw.org\" width=\"1\" /></div>\n<p><img height=\"1\" src=\"http://feeds.feedburner.com/~r/chinagfwblog/~4/-Ort_n6d_l8\" width=\"1\" /></p>\n<p><b>要翻墙？(发邮件到Gmail):caonimaxingdongATgmail.com</b></p>\n","author":275,"categories":[15300],"tags":[8510,8795,8800]}