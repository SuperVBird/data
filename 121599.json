{"id":121599,"link":"https://chinadigitaltimes.net/chinese/2010/11/围观腾讯云输入法如何回发用户输入/","date":"2010-11-13T06:22:32Z","modified":"2010-11-13T06:22:32Z","title":"围观腾讯云输入法如何回发用户输入","content":"<p><p>来自: <a href=\"http://www.feedzshare.com/b/5730239/2\">博客园-鸟食轩 &#8211; FeedzShare</a>  <a href=\"http://www.feedzshare.com/b/3489/2\">博客园-首页原创区 &#8211; FeedzShare</a>  <a href=\"http://www.feedzshare.com/b/4580214/2\">中文热文榜|最新 &#8211; FeedzShare</a>  <br />\n<br />发布时间:2010年11月11日,  已有 7 人推荐 </p>\n<hr>\n<div>\n<p><p>　　太久没有写博客了，这个懒惰的惯性实在是太强大。这两天不说说360和QQ的事情，就显得很out了，但是说来说去却又很鸡毛。另外我怎么没有看到什么弹窗呢，听说好不热闹啊，TM/MSN和MSE用户艰难的表示鸭梨很大。腾讯云输入法回传用户输入数据，在这个节骨眼上被逮到，还真算给力。</p>\n<p> </p>\n<p>　　大家可以去“腾讯软件中心”试试这个云输入法，<a href=\"http://py.qq.com/web/\">http://py.qq.com/web/</a>。但是注意不要输入什么敏感内容，免的有被跨省的风险。百度也有类似的输入法，只是好像没有咋呼叫作云输入法，而且百度还支持手写。谁有兴趣，可以查一下哪家先出的这种输入法？</p>\n<p> </p>\n<p>　　说正经的，QQ云输入法是怎么工作的呢？很简单，给任意一个网页导入一个脚本文件就可以了。 </p>\n<div>\n<div><span><</span><span>script </span><span>type</span><span>=&#8221;text/javascript&#8221;</span><span> language</span><span>=&#8221;JavaScript&#8221;</span><span> src</span><span>=&#8221;http://ime.qq.com/fcgi-bin/getjs&#8221;</span><span>></</span><span>script</span><span>></span><span><br /></span></div>\n</div>\n<p> 　　相当简单。然后呢，取回一个大约42k的文件，叫ime.js。文件是压缩过的，版本号：rev.632（这个很重要，待会儿他们一加班，就拿不到了）</p>\n<p> </p>\n<p>　　脚本启动后，会后先向服务器报告一下客户端环境，这些从浏览器里获取的参数，不是什么隐私，就是user-agent都比这丰富。</p>\n<div>\n<div><span>http://ime.qq.com/fcgi-bin/reportfirst?</span><span><strong>key=d02e5d08310c90ac54d37089fbf3d8ed</strong></span><span>&#038;version</span><span>=632</span><span>&#038;sp</span><span>=1</span><span>&#038;sw</span><span>=1920</span><span>&#038;sh</span><span>=1080</span><span>&#038;dw</span><span>=1920</span><span>&#038;dh</span><span>=512</span><span>&#038;t</span><span>=1289458673612</span></div>\n</div>\n<p> 　　但是惊喜还是有的，这个报告中包含了一个唯一的key，作用就相当于浏览器session_id。接下来的所有和腾讯服务器的交互，都会带着这个key。</p>\n<p> </p>\n<p>　　在英文输入状态下，任何字符输入会被云输入法脚本截获，然后向服务器回发如下请求：</p>\n<div>\n<div><span>http://ime.qq.com/fcgi-bin/getword?key=d02e5d08310c90ac54d37089fbf3d8ed</span><span>&#038;cb</span><span>=window.QQWebIME.callback612</span><span>&#038;q</span><span>=qq</span></div>\n</div>\n<p> 　　注意key！cb是ime.js运行后注册的回调函数，蓝色的<span>qq</span>是我的输入。服务器响因为：</p>\n<div>\n<div>\n<div><span>window.QQWebIME.callback612({</span><span>&#8220;</span><span>is_end</span><span>&#8220;</span><span>:</span><span>&#8220;</span><span>0</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>p</span><span>&#8220;</span><span>:</span><span>&#8220;</span><span>1</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>pg</span><span>&#8220;</span><span>:</span><span>&#8220;</span><span>5</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>q</span><span>&#8220;</span><span>:</span><span>&#8220;</span><span>qq</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>ret</span><span>&#8220;</span><span>:</span><span>&#8220;</span><span>suc</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>rs</span><span>&#8220;</span><span>:[</span><span>&#8220;</span><span>QQ</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>亲戚</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>亲亲</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>悄悄</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>轻轻</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>强求</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>求求</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>缺钱</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>请求</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>亲切</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>圈圈</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>前期</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>瞧瞧</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>亲情</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>全球</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>气球</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>齐全</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>取钱</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>情趣</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>千千</span><span>&#8220;</span><span>],</span><span>&#8220;</span><span>rscnt</span><span>&#8220;</span><span>:</span><span>&#8220;</span><span>20</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>rsn</span><span>&#8220;</span><span>:[</span><span>&#8220;</span><span>2</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>2</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>2</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>2</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>2</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>2</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>2</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>2</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>2</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>2</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>2</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>2</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>2</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>2</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>2</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>2</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>2</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>2</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>2</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>2</span><span>&#8220;</span><span>]})</span></div>\n</div>\n</div>\n<p> 　　这时你可以像普通输入法一样进行选词，而且很自然的是，选词后没有服务器请求发生。也就是你的输入内容，都是在浏览器本地完成的，腾讯除了知道你请求了什么候选词列表外，不知道你到底输入了什么。似乎这一切都很美好，也就应该是这么美好才对，是吧？</p>\n<p> </p>\n<p>　　但是这不是360在隐私问题上掐QQ吗，本来我一直认为腾讯这么大一个上市公司，做事还是该有点底线的。但是360让大家看到了腾讯是没有底线的，真流氓揭露了伪君子。于是我就怀着最大的恶意想，这输入法因该还是有问题的。于是继续使用，突然发现一个异常的服务器请求，如下： </p>\n<div>\n<div>\n<div><span>http://ime.qq.com/fcgi-bin/reportword?key=d02e5d08310c90ac54d37089fbf3d8ed</span><span>&#038;num</span><span>=11</span><span>&#038;xl</span><span>=danshi,%E4%BD%86%E6%98%AF,0,0,1,0|zhe,%E8%BF%99,0,0,1,0|bushi,%E4%B8%8D%E6%98%AF,0,0,1,0|zaihe,%E5%9C%A8%E5%92%8C,0,0,1,0|tengxun,%E8%85%BE%E8%AE%AF,0,0,1,0|zuoweiyige,%E4%BD%9C%E4%B8%BA%E4%B8%80%E4%B8%AA,0,0,1,0|shangshi,%E4%B8%8A%E5%B8%82,0,0,1,0|gongsi,%E5%85%AC%E5%8F%B8,0,0,1,0|zuoshihaishiyinggai,%E5%81%9A%E4%BA%8B%E8%BF%98%E6%98%AF%E5%BA%94%E8%AF%A5,0,0,1,0|you,%E6%9C%89,0,0,1,0|dixian,%E5%BA%95%E7%BA%BF,0,0,1,0</span></div>\n</div>\n</div>\n<p> 　　把这堆编码过的字符转回来，是： </p>\n<div>\n<div>\n<div><span>http://ime.qq.com/fcgi-bin/reportword?key=d02e5d08310c90ac54d37089fbf3d8ed</span><span>&#038;num</span><span>=11</span><span>&#038;xl</span><span>=danshi,但是,0,0,1,0|zhe,这,0,0,1,0|bushi,不是,0,0,1,0|zaihe,在和,0,0,1,0|tengxun,腾讯,0,0,1,0|zuoweiyige,作为一个,0,0,1,0|shangshi,上市,0,0,1,0|gongsi,公司,0,0,1,0|zuoshihaishiyinggai,做事还是应该,0,0,1,0|you,有,0,0,1,0|dixian,底线,0,0,1,0</span></div>\n</div>\n</div>\n<p>　　你这时是不是只想向狗日的企鹅竖起中指呢？</p>\n<p> </p>\n<p>　　这是不是我没看清楚了，把ime.js仔细看了一下，tmd居然是混淆过的，看得我好累<img alt=\"\" src=\"http://www.cnblogs.com/Emoticons/msn/angry_smile.gif\" />。谜底就在这里了：</p>\n<div><span>ha </span><span>=</span><span> </span><span>function</span><span> () {<br />    </span><span>var</span><span> e </span><span>=</span><span> [], a </span><span>=</span><span> </span><span>new</span><span> Image(</span><span>1</span><span>, </span><span>1</span><span>), b </span><span>=</span><span> </span><span>false</span><span>,<br />    j </span><span>=</span><span> </span><span>function</span><span> () {<br />        a.onload </span><span>=</span><span> a.onerror </span><span>=</span><span> </span><span>null</span><span>;<br />        b </span><span>=</span><span> </span><span>false</span><span>;<br />        J </span><span>&#038;&#038;</span><span> CollectGarbage()<br />    },<br />    r </span><span>=</span><span> </span><span>function</span><span> (w) {<br />        b </span><span>&#038;&#038;</span><span> j();<br />        a.src </span><span>=</span><span> w;<br />        a.onload </span><span>=</span><span> a.onerror </span><span>=</span><span> j;<br />        a.complete </span><span>&#038;&#038;</span><span> j();<br />        b </span><span>=</span><span> </span><span>true</span><span><br />    },<br />    s </span><span>=</span><span> </span><span>&#8220;&#8221;</span><span>, n </span><span>=</span><span> </span><span>&#8220;&#8221;</span><span>,<br />    v </span><span>=</span><span> </span><span>function</span><span> () {<br />        </span><span>return</span><span> s </span><span>+</span><span> </span><span>&#8220;</span><span>&#038;num=</span><span>&#8220;</span><span> </span><span>+</span><span> e.length </span><span>+</span><span> </span><span>&#8220;</span><span>&#038;xl=</span><span>&#8220;</span><span> </span><span>+</span><span> e.join(</span><span>&#8220;</span><span>|</span><span>&#8220;</span><span>)<br />    };<br />    </span><span>return</span><span> {<br />        a:<br />        </span><span>function</span><span> () {<br />            </span><span>var</span><span> w;<br />            w </span><span>=</span><span> c.c();<br />            w </span><span>=</span><span> o.b(</span><span>&#8220;</span><span>cgiPrx</span><span>&#8220;</span><span>) </span><span>+</span><span> </span><span>&#8220;</span><span>reportfirst?key=</span><span>&#8220;</span><span> </span><span>+</span><span> o.b(</span><span>&#8220;</span><span>prvKey</span><span>&#8220;</span><span>) </span><span>+</span><span> </span><span>&#8220;</span><span>&#038;version=632&#038;sp=</span><span>&#8220;</span><span> </span><span>+</span><span> o.b(</span><span>&#8220;</span><span>lnchr</span><span>&#8220;</span><span>) </span><span>+</span><span> </span><span>&#8220;</span><span>&#038;sw=</span><span>&#8220;</span><span><br />                </span><span>+</span><span> screen.width </span><span>+</span><span> </span><span>&#8220;</span><span>&#038;sh=</span><span>&#8220;</span><span> </span><span>+</span><span> screen.height </span><span>+</span><span> </span><span>&#8220;</span><span>&#038;dw=</span><span>&#8220;</span><span> </span><span>+</span><span> w[</span><span>0</span><span>] </span><span>+</span><span> </span><span>&#8220;</span><span>&#038;dh=</span><span>&#8220;</span><span> </span><span>+</span><span> w[</span><span>1</span><span>] </span><span>+</span><span> </span><span>&#8220;</span><span>&#038;t=</span><span>&#8220;</span><span> </span><span>+</span><span> Ba;<br />            r(w);<br />            s </span><span>=</span><span> o.b(</span><span>&#8220;</span><span>cgiPrx</span><span>&#8220;</span><span>) </span><span>+</span><span> </span><span>&#8220;</span><span>reportword?key=</span><span>&#8220;</span><span> </span><span>+</span><span> o.b(</span><span>&#8220;</span><span>prvKey</span><span>&#8220;</span><span>)<br />        },<br />        b:<br />        </span><span>function</span><span> (w) {<br />            </span><span>if</span><span> (S </span><span>!==</span><span> w) {<br />                </span><span>var</span><span> l </span><span>=</span><span> w.length;<br />                </span><span>if</span><span> (</span><span>0</span><span> </span><span>!==</span><span> l) {<br />                    </span><span>for</span><span> (</span><span>var</span><span> h </span><span>=</span><span> </span><span>&#8220;&#8221;</span><span>, m </span><span>=</span><span> </span><span>&#8220;&#8221;</span><span>, g </span><span>=</span><span> </span><span>0</span><span>; g </span><span><</span><span> l; g</span><span>++</span><span>) {<br />                        </span><span>var</span><span> x </span><span>=</span><span> w[g],<br />                        k </span><span>=</span><span> encodeURIComponent(x.kanji);<br />                        e.push(x.spell </span><span>+</span><span> </span><span>&#8220;</span><span>,</span><span>&#8220;</span><span> </span><span>+</span><span> k </span><span>+</span><span> </span><span>&#8220;</span><span>,</span><span>&#8220;</span><span> </span><span>+</span><span> n);<br />                        h </span><span>+=</span><span> x.spell;<br />                        m </span><span>+=</span><span> k<br />                    }<br />                    </span><span>1</span><span> </span><span><</span><span> l </span><span>&#038;&#038;</span><span> e.push(h </span><span>+</span><span> </span><span>&#8220;</span><span>,</span><span>&#8220;</span><span> </span><span>+</span><span> m </span><span>+</span><span> </span><span>&#8220;</span><span>,</span><span>&#8220;</span><span> </span><span>+</span><span> n);<br />                    </span><span>if</span><span> (</span><span>10</span><span> </span><span><</span><span> e.length) {<br />                        r(v()); e </span><span>=</span><span> []<br />                    }<br />                }<br />            }<br />        },<br />        j:<br />        </span><span>function</span><span> (w) {<br />            w </span><span>=</span><span> o.b(</span><span>&#8220;</span><span>cgiPrx</span><span>&#8220;</span><span>) </span><span>+</span><span> </span><span>&#8220;</span><span>re?key=</span><span>&#8220;</span><span> </span><span>+</span><span> o.b(</span><span>&#8220;</span><span>prvKey</span><span>&#8220;</span><span>) </span><span>+</span><span> </span><span>&#8220;</span><span>&#038;ec=</span><span>&#8220;</span><span> </span><span>+</span><span> w </span><span>+</span><span> </span><span>&#8220;</span><span>&#038;py=</span><span>&#8220;</span><span> </span><span>+</span><span> B.o() </span><span>+</span><span> </span><span>&#8220;</span><span>&#038;t=</span><span>&#8220;</span><span><br />                </span><span>+</span><span> (</span><span>+</span><span>new</span><span> Date).toString().slice(</span><span>0</span><span>, </span><span>&#8211;</span><span>3</span><span>) </span><span>+</span><span> </span><span>&#8220;</span><span>&#038;v=632</span><span>&#8220;</span><span>;<br />            r(w)<br />        },<br />        k:<br />        </span><span>function</span><span> () {<br />            </span><span>if</span><span> (</span><span>0</span><span> </span><span>!==</span><span> e.length) {<br />                r(v());<br />                e </span><span>=</span><span> []<br />            }<br />        },<br />        l:<br />        </span><span>function</span><span> () {<br />            </span><span>var</span><span> w </span><span>=</span><span> </span><span>1</span><span> </span><span>===</span><span> o.b(</span><span>&#8220;</span><span>iptMode</span><span>&#8220;</span><span>);<br />            n </span><span>=</span><span> [</span><span>&#8220;</span><span>0</span><span>&#8220;</span><span>, o.b(</span><span>&#8220;</span><span>iptMode</span><span>&#8220;</span><span>) </span><span>&#8211;</span><span> </span><span>1</span><span>, w </span><span>?</span><span> o.b(</span><span>&#8220;</span><span>pyMode</span><span>&#8220;</span><span>) : </span><span>&#8220;</span><span>0</span><span>&#8220;</span><span>, w </span><span>&#038;&#038;</span><span> </span><span>1</span><span> </span><span>!==</span><span> o.b(</span><span>&#8220;</span><span>pyMode</span><span>&#8220;</span><span>) </span><span>?</span><span> o.b(</span><span>&#8220;</span><span>spType</span><span>&#8220;</span><span>) : </span><span>&#8220;</span><span>0</span><span>&#8220;</span><span>].join(</span><span>&#8220;</span><span>,</span><span>&#8220;</span><span>)<br />        }<br />    }<br />} ()</span></div>\n<p>　　多贴点code，表示这是技术贴，不是5毛贴咯（听说涨7毛了，通胀太厉害了）。答案就在这个ha伪类的函数b里，这个b函数是用来记录输入历史的，但是在这个方法最后，做了一个判断：if (10 < e.length) { r(v()); e = [] }。e是存放输入历史的数组，方法r和v是负责组装和回发数据的，发完后清空了e。</p>\n<p> </p>\n<p>　　难道收集用户输入内容成了中国国情了？微软拼音2010还真的有这个功能，不过它会明确提示用户，并且只是发回那些用户纠正输入推荐，而且回发的内容也是用户可以很容易看到和编辑的。另外同样是web ime的百度输入法，回发服务器的信息是：</p>\n<div>\n<div><span>http://olime.baidu.com/py?py=baidu</span><span>&#038;rn</span><span>=0</span><span>&#038;pn</span><span>=20</span><span>&#038;t</span><span>=1289460415974</span></div>\n</div>\n<p>　　注意，这里没有key信息，这不是说百度就不能identify你，因为还有浏览器session_id，但是百度的输入法没有回发用户实际选词，所以是无法在服务期上还原用户输入的。</p>\n<p> </p>\n<p>　　虽然这是篇技术文章，但是肯定掺杂了莫名的立场，那我现在的立场就是：胁迫用户者不得好死！</p>\n<p><img alt=\"\" height=\"1\" src=\"http://www.cnblogs.com/birdshome/aggbug/1874875.html?type=1\" width=\"1\" /></p>\n<p>作者: <a href=\"http://www.cnblogs.com/birdshome/\">birdshome</a> 发表于 2010-11-11 14:44 <a href=\"http://www.cnblogs.com/birdshome/archive/2010/11/11/qq_ime.html\">原文链接</a></p>\n<p>评论: 50　<a href=\"http://www.cnblogs.com/birdshome/archive/2010/11/11/qq_ime.html#pagedcomment\">查看评论</a>　<a href=\"http://www.cnblogs.com/birdshome/archive/2010/11/11/qq_ime.html#commentform\">发表评论</a></p>\n<hr>\n<p>最新新闻：<br />· <a href=\"http://news.cnblogs.com/n/80720/\">DeNA视Facebook和Zynga为潜在合作伙伴</a><span>(2010-11-11 22:59)</span><br />· <a href=\"http://news.cnblogs.com/n/80719/\">“苹果”智能中文语句输入法发布</a><span>(2010-11-11 22:42)</span><br />· <a href=\"http://news.cnblogs.com/n/80718/\">Macroglossa：有趣的图片搜索平台</a><span>(2010-11-11 22:21)</span><br />· <a href=\"http://news.cnblogs.com/n/80717/\">WP7文档数据库Rapid Repository正式发布</a><span>(2010-11-11 22:19)</span><br />· <a href=\"http://news.cnblogs.com/n/80716/\">百度内测图片搜索新功能“识图” 可以图搜图</a><span>(2010-11-11 22:10)</span></p>\n<p>编辑推荐：<a href=\"http://news.cnblogs.com/n/80576/\">.NET平台上的JavaScript引擎</a></p>\n<p>网站导航：<a href=\"http://www.cnblogs.com\">博客园首页</a>  <a href=\"http://home.cnblogs.com/\">我的园子</a>  <a href=\"http://news.cnblogs.com\">新闻</a>  <a href=\"http://home.cnblogs.com/ing/\">闪存</a>  <a href=\"http://home.cnblogs.com/group/\">小组</a>  <a href=\"http://space.cnblogs.com/q/\">博问</a>  <a href=\"http://kb.cnblogs.com\">知识库</a></p>\n</p>\n</div>\n<p><img src=\"http://img.tongji.linezing.com/1017243/tongji.gif\" /><img src=\"http://img.tongji.linezing.com/997968/tongji.gif\" /></p>\n","author":176,"categories":[1],"tags":[]}