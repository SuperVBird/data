{"id":142804,"link":"https://chinadigitaltimes.net/chinese/2011/04/在android上走出天朝局域网/","date":"2011-04-05T13:00:33Z","modified":"2011-04-05T13:00:33Z","title":"在Android上走出天朝局域网","content":"<p>来源：<a href=\"http://blog.xiping.me/2011/03/break-gfw-on-android.html\">http://blog.xiping.me/2011/03/break-gfw-on-android.html</a></p>\n<p>天朝的防火长城越来越牛逼了，我常用的一些网站如 Gmail, Goolgle Search，Google Docs 都很难访问。买了Android手机以后，一直在考虑如何访问这些网站。经过一番苦战，终于搞定，把相关经验写下来分享。</p>\n<p>文章比较长，比较有价值的内容包括：</p>\n<ul>\n<li>第二部分介绍Opera mini，除了能实现访问抽疯的国外网站外，还能提高访问速度。</li>\n<li>第三部分主要介绍SSH Tunnel，能解决DNS污染的问题，并可实现浏览器以及其他非浏览器应用的翻墙访问。</li>\n</ul>\n<p>我的手机是Huawei C8500, firmware：2.1-update1, kernel： 2.6.29-perf。</p>\n<h3>第一阶段：不给力的http_proxy和VPN</h3>\n<p>最早，我尝试用Android自身的HTTP代理方式。网上有不少帖子读在讨论给Android的一个系统设置表增加http_proxy记录来实 现http代理，主要方式包括通过手动使用sqlite3修改data/data /com.google.android.providers.settings/databases/settings.db表，增加 http_proxy代理记录（详细参考<a href=\"http://openhandsetmagazine.com/2007/11/tips-howto-connect-android-emulator-behind-proxy/\">此文：Tips: Howto Connect Android Emulator behind proxy）</a>，如下所示：</p>\n<div>\n<div>\n<pre><span>./</span>adb shell sqlite3 <span>/</span><span>DATA</span><span>/</span><span>DATA</span><span>/</span>com<span>.</span>google<span>.</span>android<span>.</span>providers<span>.</span>settings<span>/</span><span>DATABASES</span><span>/</span>settings<span>.</span>db<br>  \"\"<span>INSERT</span> <span>INTO</span> system <span>VALUES</span><span>(</span><span>99</span><span>,</span>'http_proxy'<span>,</span>' <span>[</span>host_or_IP<span>]</span>:<span>[</span>port<span>]</span>'<span>)</span>;\"<span>\"</span></pre>\n</p></div>\n</div>\n<p>但经过验证，至少在我的机器上是不行的。</p>\n<p>然后又照着这篇文章（<a href=\"http://alexmogurenko.com/blog/programming/android-how-to-set-proxy-for-android-browser/\">[Android] How to set proxy for android browser</a>），写了一个插件直接设置浏览器代理。这个方法试了试，偶尔能行，偶尔不能行。</p>\n<p>后来再尝试VPN，试验了几个VPN供应商提供的试用账户，都没有成功。</p>\n<h3> 第二阶段：翻墙麻利、访问提速的Opera mini </h3>\n<p><a href=\"http://www.opera.com/mobile/\"> Opera mini </a>是 老资历的翻墙工具了，但自从前段时间出了Opera中国版的事情以后，官方版本不支持翻墙了，必须自己破解，并搭建一个IP位于国外的中转服务器。中转服 务器其实很简单，只是接收请求，然后用CURL去Opera官方服务器去获取实际内容，再将内容发回。虽然弄一个使用自己的中转服务器的破解版Opera mini比较麻烦，但是搭建起来以后觉得速度相当快。尤其是访问国外几个大站如Google, facebook 和 twitter的移动版，那是相当流畅，远比 Andriod 自带的浏览器流畅。从服务器端Squid代理的日志来看，使用Opera mini访问同一个网页，貌似最终只有一个HTTP请求，图片和JS，CSS等都不用再单独请求了。从日志看，请求数明显减少，网页体积也缩小很多，流量 也省不少。</p>\n<p>详细参考：</p>\n<ul>\n<li><a href=\"http://zoomao.info/2010/05/05/opera-mini-over-gfw.html\">opera mini 翻墙大法</a> ：此文提供了现成的文件下载，详细指南。</li>\n<li><a href=\"http://www.p4cpu.net/2010/08/25/android-opm-modify-server/\">修改Android版Opera Mini的服务器实现翻墙</a>：此文主要讲如何制作使用自己的中转服务器的版本。 </li>\n</ul>\n<p>搭建php版的中转服务器十分简单，就一个PHP文件，内容如下（文件内容参考自<a href=\"http://zoomao.info/2010/05/05/opera-mini-over-gfw.html\">opera mini 翻墙大法</a>提供的文件）：</p>\n<div>\n<div>\n<pre><span>if</span> <span>(</span><span>$_SERVER</span><span>[</span><span>'REQUEST_METHOD'</span><span>]</span> <span>==</span> <span>'GET'</span><span>)</span> <span></span><br>        <span>//......</span><br><span></span> <span>else</span> <span></span><br>         <span>$curlInterface</span> <span>=</span> <span>curl_init</span><span>(</span><span>)</span><span>;</span><br>         <span>$headers</span><span>[</span><span>]</span> <span>=</span> <span>'Connection: Keep-Alive'</span><span>;</span><br>         <span>$headers</span><span>[</span><span>]</span> <span>=</span> <span>'content-type: application/xml'</span><span>;</span><br>         <span>$headers</span><span>[</span><span>]</span> <span>=</span> <span>'User-Agent: Java0'</span><span>;</span><br>         <span>curl_setopt_array</span><span>(</span><span>$curlInterface</span><span>,</span> <span>array</span><span>(</span><br>                 CURLOPT_URL <span>=></span> <span>'<a href=\"http://server4.operamini.com\">http://server4.operamini.com</a>'</span><span>,</span><br>                 CURLOPT_HTTPHEADER <span>=></span> <span>$headers</span><span>,</span><br>                CURLOPT_POST <span>=></span> <span>1</span><span>,</span><br>                 CURLOPT_POSTFIELDS <span>=></span> <span>@</span><span>file_get_contents</span><span>(</span><span>'php://input'</span><span>)</span><span>)</span><br>     <span>)</span><span>;</span><br>        <span>$result</span> <span>=</span> <span>curl_exec</span><span>(</span><span>$curlInterface</span><span>)</span><span>;</span><br>         <span>curl_close</span><span>(</span><span>$curlInterface</span><span>)</span><span>;</span><br>         <span>header</span><span>(</span><span>'Content-Type: application/octet-stream'</span><span>)</span><span>;</span><br>         <span>header</span><span>(</span><span>'Cache-Control: priavte, no-cache'</span><span>)</span><span>;</span><br>         <span>echo</span> <span>$result</span><span>;</span><br><span></span></pre>\n</div></div>\n<p>顺带提一句，在你翻墙以后（前提是使用第三部分介绍的方式或者其他方式实现443/80端口翻墙以后），你可以使用最新的<a href=\"https://market.android.com/details?id=com.opera.browser\">Opera Mobile 10</a>翻 墙。Opera Mobile 10支持手动设置代理，可直接使用国外IP的代理服务器。 Opera Mobile 10 有Android的原生版本，并且不经过Opera的中间服务器代理，你不需要担心安全问题。不过相比较经过中间服务器的Opera mini版本而言，速度慢了不少，且体积庞大，安装完成后有二十几兆大。 </p>\n<p>有关<a href=\"https://market.android.com/details?id=com.opera.browser\">Opera Mobile 10</a>的代理设置参考<a href=\"http://bbs.uc.cn/archiver/?tid-722523.html\">这里</a>。</p>\n<h3>第三阶段：使用SSH Tunnel为所有80/443端口的访问翻墙</h3>\n<p> 但还有一个问题，就是GMS里的一部分应用被墙了，如Gmail，这必须使用能全局代理的代理软件才行。在桌面系统上，有很多工具实现全局代理。其中让系 统以socks5代理协议通过SSH隧道就是一种常用方式。SSH隧道在本地服务器与SSH服务器之间建立起一个加密信道，本地系统数据经过这条隧道传递 给目标服务器。 这种代理方式所有的内容都经过了加密，并会对流量进行适度压缩。其需要的资源也比较少，只要拥有一个ssh账户就可以实现。<a href=\"http://www.bitvise.com/port-forwarding\">这篇文章 (A short guide to SSH port forwarding) </a>对通过SSH做端口转发做了详细介绍。</p>\n<p> 不过在Android系统上，因为系统本身不支持代理设置，尤其像Huawei C8500这样的手机，在Wifi/3G网络的设置中都不能设置代理，必须要有一种方式将本地数据包转发到SSH隧道的本地端口。因为Android是基 于Linux的，通常我们可以用iptables来实现数据包的转发。有关iptables的内容，可以参阅一下<a href=\"http://man.chinaunix.net/network/iptables-tutorial-cn-1.1.19.html\">这篇中文指南</a>，了解一些基本知识。</p>\n<p>    除此以外，使用端口转发的方式，还需要在服务器端建立一个http代理服务器监听SSH隧道的另一端，接收请求并将请求转给目标服务器，并将处理结果再通过隧道传回给手机。常用的http代理服务器有 <a href=\"http://www.squid-cache.org/\">squid</a>, <a href=\"http://nginx.org/\">nigix</a> 等。</p>\n<p>   一开始我找到的是<a href=\"http://forum.xda-developers.com/showthread.php?t=766569\">TransparentProxy</a>， 但这个软件需要手机除了需要支持 iptables外， 内核还需支持 iptables 的 REDIRECT 表。我的手机不支持 redirect，只好作罢。</p>\n<p>    然后试了试 <a href=\"http://code.google.com/p/sshtunnel\">SSHTunnel</a>，结果没报告错误，但就是访问不了。 因为这个项目是开源的，翻开代码一看，跟TransparentProxy一样，需要 iptables 的 redirect 支持。 </p>\n<p>    尝试了用<a href=\"http://code.google.com/p/connectbot/\"> connectBot</a> 做动态代理，然后再写了个软件将所有端口的内容转发到这个connectBot。转发通过 <a href=\"http://www.netfilter.org/\">iptables</a> 的 DNAT 来实现。不过这样操作起来还是比较麻烦，要开启这两个软件，而且 connectbot 耗电太厉害了，开了一段时间以后，手机发热。</p>\n<p>    最后，签出 <a href=\"http://code.google.com/p/sshtunnel\">SSHTunnel</a> 的代码，修改成在内核不支持 redirect 的手机上，自动使用 DNAT 实现转发。问题终于搞定。</p>\n<p>    完成后，向该项目提交了这个patch，该项目已经接受<a href=\"http://code.google.com/p/sshtunnel/issues/detail?id=17\">此patch</a>，现在<a href=\"http://code.google.com/p/sshtunnel\">SSHTunnel</a>支持更多的与华为C8500的固件类似的手机了。</p>\n<p>     SSH Tunnel 项目主页：<a href=\"http://code.google.com/p/sshtunnel\"><img alt=\"\" height=\"55\" src=\"http://code.google.com/p/sshtunnel/logo?cct=1299552875\" title=\"SSH Tunnel\" width=\"55\" /></a> 详细使用介绍请去<a href=\"http://code.google.com/p/sshtunnel/wiki/README\">该项目的帮助页面</a>。</p>\n<p></p>\n<h4>―――――――――――――――――――――――――――――――――――――――――</h4>\n<h4>需要翻墙利器赛风? 请<a href=\"https://www.google.com/profiles/112915952962578336480\">阅读和关注中国数字时代</a>。</p>\n<p>推特用户请点击<a href=\"http://qinzhigang.in/login.php\">这里</a>免翻墙上推特</h4>\n<p>请点击<a href=\"https://sesawe.net/-Tools-zh-.html\">这里</a>下载翻墙软件 </p>\n<p>更多翻墙方法请发电邮(最好用Gmail)到：<a href=\"mailto:fanqiang70ma@gmail.com\">fanqiang70ma@gmail.com</a>  </p>\n<p>请阅读和关注<a href=\"https://www.google.com/profiles/112915952962578336480\">中国数字时代</a>、翻墙技术博客<a href=\"https://www.google.com/profiles/chinagfwblog\">GFW BLOG</a>（免翻墙）  </p>\n<p>请使用<a href=\"https://www.google.com/reader/view/\">Google Reader</a><a href=\"https://www.google.com/reader/view/feed/http://chinadigitaltimes.net/chinese/feed\">订阅中国数字时代中文版</a>（<a href=\"http://chinadigitaltimes.net/chinese/feed\">http://chinadigitaltimes.net/chinese/feed</a>），阅读最有价值的中文信息；以及<a href=\"https://www.google.com/reader/view/feed/http://feeds2.feedburner.com/chinagfwblog\">GFW BLOG（功夫网与翻墙）</a><a href=\"http://feeds2.feedburner.com/chinagfwblog\">http://feeds2.feedburner.com/chinagfwblog</a>，获取最新翻墙工具和翻墙技巧信息。</p>\n<p>  </p>\n<div>要翻墙? <a href=\"http://ziyouxinxi.info/\">用赛风</a>.<br />\n推特用户请点击<a href=\"http://edu20.in/login.php\">这里</a>免翻墙上推特<wbr><br />\n点击<a href=\"http://fanqiangsesawe.info\">这里</a>下载翻墙软件<br />\n更多翻墙方法请发电邮(最好用Gmail)到:gongminshehui1@gmail.com<br />\n翻墙技术博客<a href=\"https://www.google.com/profiles/chinagfwblog\">GFW BLOG</a>（免翻墙）<br />\n阅读<a href=\"http://www.google.com/profiles/112915952962578336480\">中国数字时代</a>（免翻墙）<img alt=\"\" height=\"1\" src=\"https://blogger.googleusercontent.com/tracker/5500297126185736776-742323046382279206?l=www.chinagfw.org\" width=\"1\" /></div>\n<div>\n<a href=\"http://feeds.feedburner.com/~ff/chinagfwblog?a=utZf7EiVDRU:o-HaoWXPUts:yIl2AUoC8zA\"><img border=\"0\" src=\"http://feeds.feedburner.com/~ff/chinagfwblog?d=yIl2AUoC8zA\" /></a> <a href=\"http://feeds.feedburner.com/~ff/chinagfwblog?a=utZf7EiVDRU:o-HaoWXPUts:-BTjWOF_DHI\"><img border=\"0\" src=\"http://feeds.feedburner.com/~ff/chinagfwblog?i=utZf7EiVDRU:o-HaoWXPUts:-BTjWOF_DHI\" /></a> <a href=\"http://feeds.feedburner.com/~ff/chinagfwblog?a=utZf7EiVDRU:o-HaoWXPUts:F7zBnMyn0Lo\"><img border=\"0\" src=\"http://feeds.feedburner.com/~ff/chinagfwblog?i=utZf7EiVDRU:o-HaoWXPUts:F7zBnMyn0Lo\" /></a> <a href=\"http://feeds.feedburner.com/~ff/chinagfwblog?a=utZf7EiVDRU:o-HaoWXPUts:V_sGLiPBpWU\"><img border=\"0\" src=\"http://feeds.feedburner.com/~ff/chinagfwblog?i=utZf7EiVDRU:o-HaoWXPUts:V_sGLiPBpWU\" /></a> <a href=\"http://feeds.feedburner.com/~ff/chinagfwblog?a=utZf7EiVDRU:o-HaoWXPUts:qj6IDK7rITs\"><img border=\"0\" src=\"http://feeds.feedburner.com/~ff/chinagfwblog?d=qj6IDK7rITs\" /></a> <a href=\"http://feeds.feedburner.com/~ff/chinagfwblog?a=utZf7EiVDRU:o-HaoWXPUts:l6gmwiTKsz0\"><img border=\"0\" src=\"http://feeds.feedburner.com/~ff/chinagfwblog?d=l6gmwiTKsz0\" /></a> <a href=\"http://feeds.feedburner.com/~ff/chinagfwblog?a=utZf7EiVDRU:o-HaoWXPUts:gIN9vFwOqvQ\"><img border=\"0\" src=\"http://feeds.feedburner.com/~ff/chinagfwblog?i=utZf7EiVDRU:o-HaoWXPUts:gIN9vFwOqvQ\" /></a> <a href=\"http://feeds.feedburner.com/~ff/chinagfwblog?a=utZf7EiVDRU:o-HaoWXPUts:TzevzKxY174\"><img border=\"0\" src=\"http://feeds.feedburner.com/~ff/chinagfwblog?d=TzevzKxY174\" /></a>\n</div>\n<p><img height=\"1\" src=\"http://feeds.feedburner.com/~r/chinagfwblog/~4/utZf7EiVDRU\" width=\"1\" /></p>\n<p><img src=\"http://code.google.com/p/sshtunnel/logo?cct=1299552875\" /></p>\n<p><b>要翻墙？(发邮件到Gmail):CDTcaonimaATgmail.com</b></p>\n","author":802,"categories":[15300],"tags":[8510,8795,8800]}