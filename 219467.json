{"id":219467,"link":"https://chinadigitaltimes.net/chinese/2012/04/翻墙-解决dropbox中国无法及时自动同步的问题/","date":"2012-04-05T22:10:12Z","modified":"2012-04-05T22:10:12Z","title":"翻墙 | 解决Dropbox中国无法及时自动同步的问题","content":"<p>原文：<a rel=\"nofollow\" target=\"_blank\" href=\"http://www.williamlong.info/archives/3050.html\">http://www.williamlong.info/archives/3050.html</a></p>\n<div></div>\n<div>\n<p>最近由于想要使用<a rel=\"nofollow\" target=\"_blank\" href=\"http://www.williamlong.info/archives/2044.html\">Dropbox</a>的多人协作功能，就发现Dropbox不能自动同步其他机器上产生的文件变化，经过一番搜索，发现原来是GFW在作怪（GFW和GD的性质和用心我们心知肚明，就不在这里评价了）。月光博客发布了<a rel=\"nofollow\" target=\"_blank\" href=\"http://www.williamlong.info/archives/2585.html\">解决Dropbox无法实时更新的问题</a>分析了产生这个问题的原因并提出一个有效的解决方案。但是在使用时我发现，我找不到一个优良稳定的代理服务器，也没工夫去学习privoxy软件的配置和使用，而且我要将解决方案提供给我的合伙人，一个复杂的方案是不能接受的。经过一番研究，提出如下比较简单的办法。</p>\n<h3>　　分析</h3>\n<p>　　我发现Dropbox向notify8发出的请求很简单，回应也很简单，一共有两种：<code>\"ret\":\"new\"和\"ret\":\"punt\"</code></p>\n<p>　　分别表示云端有变化和无变化，然后客户端考虑去下载文件列表并同步。</p>\n<p>　　经过一番痛苦的失败，我发现这个请求的其实是一个comet请求，服务器端并不马上回应，而是会挂起，如果有变化，则马上回应，如果一直没有变化，大约一分钟超时回应punt，然后客户端再连接服务器。在我分析Dropbox的过程中一直不解：为什么Dropbox的其他请求都是https，而只有这一个请求是http的。现在找到了答案：因为它是comet请求，长连接，而且连接频率非常高，如果使用https代价太大，而且影响效率。如果这个请求返回new，客户端就会使用https连接服务器端。</p>\n<h3>　　解决</h3>\n<p>　　由此提出一个完美的解决方案，不仅可以解决本机的问题，而且可以解决朋友的问题，只要让朋友修改hosts为我的ip地址：</p>\n<ul>\n<li>修改hosts将notify8对应的ip地址改为本机</li>\n<li>在本机建立一个http服务，代理notify8得到dropbox的返回值，再原封不动地返回给本机dropbox客户端</li>\n</ul>\n<p> 　　具体方法是使用tornado，进行一步http请求，这样只占用很少一部分系统资源。贴出代码。</p>\n<h3>　　代码</h3>\n<p> #!/usr/bin/env python<br /># -*- coding: utf-8 -*-</p>\n<p>import tornado.httpserver<br />import tornado.ioloop<br />import tornado.options<br /> import tornado.web<br />from tornado.options import define, options<br />from tornado import httpclient</p>\n<p>define(&#8220;port&#8221;, default=8888, help=&#8221;run on the given port&#8221;, type=int)</p>\n<p>class Application(tornado.web.Application):</p>\n","author":100,"categories":[15300],"tags":[8795]}