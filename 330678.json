{"id":330678,"link":"https://chinadigitaltimes.net/chinese/2014/01/ovear：2014年1月21日全国dns污染始末以及分析/","date":"2014-01-21T21:29:15Z","modified":"2014-01-21T21:40:38Z","title":"Ovear：2014年1月21日全国DNS污染始末以及分析","content":"<p>=w=大概今天15:30的时候，Ovear正在调试新的服务器，结果发现肿么突然上不去了。。结果ping了以下，结果吓尿了，Ovear的域名都指向到[65.49.2.178]这个IP。Ovear第一反应就是，尼玛DNSPOD又被黑了！ 为什么说DNSPOD被黑了呢，其实以前DNSPOD就出过一次类似的问题=。=，导致所有的域名都跪了，刚好Ovear这个域名还有测试的几个域名都是那里的，然后就到某交流群吐槽。结果管理员说他们的DNS被污染了，Ovear心想不会是全国DNS都被污染了吧。结果乌鸦嘴说中了。。还真的是全国劫持。</p>\n<p>然后Ovear就很好奇，到底是怎么回事呢~有谁能做到这样的事情~于是就有了以下的分析和科普~<br />\n—————–以下内容为Ovear家电脑中病毒所致，跟本人无任何关系，谢绝跨省————————</p>\n<p>balablabala说了这么久，肯定有同学问了，窝又不是学计算机的，(╯‵□′)╯︵┻━┻dns是什么玩意，跟我有什么关系！<br />\n那么DNS是什么呢，Ovear就来科普下┑(￣Д ￣)┍。<br />\n我们访问一般是通过<strong>域名[Domain]</strong>来访问的，咦DNS怎么也是D开头的，难道有关系？说对了！就是有关系:DNS的全称其实是<strong>[Domain Name System]</strong>翻译过来就是<strong>域名系统</strong>。<br />\n在互联网中，是只存在IP的，IP其实就是一串数字，相当于你家里的门牌号，大家在网络中想找到你，必须通过这个，所以IP对于每个人来说是唯一的。但是第四代IP都是XXX.XXX.XXX.XXX这样的，多难记啊，谁会没事记住IP呢，更何况以后天那么长的IPV6，要记住不是得要人命！这时候一个聪明的科学家出来，我们给IP加一个别名，大家通过别名不就可以不记住这个IP，也可以知道这个IP了！于是就有了<strong>域名[Domain]</strong>这个东西.<br />\n当你访问www.ovear.info的时候<br />\n电脑的DNS解析系统就会自动问DNS服务器：尼知道www.ovear.info对应的IP地址是神马么？<br />\nDNS：窝帮你查查，奥，找到了，IP是[122.10.94.169].<br />\nOvear的电脑：谢啦，再见<br />\nDNS：恩<br />\n对应现实就是，问知道张三的人：尼知道张三家在哪里么？ 回答 在南山区 balabalabla。</p>\n<p>当然这样解释还是不怎么恰当的，因为一个DNS服务器是不可能知道所有域名的地址的，因为这需要耗费极大地代价，所以这时候就出现了递归DNS和根DNS。（<strong>由于篇幅原因，Ovear就简单的说一下，其实还是有问题的</strong>。Ovear以后再写一篇文章详细阐述下DNS的工作原理，或者看[http://en.wikipedia.org/wiki/Domain_Name_System] QAQ）<br />\n根DNS是什么呢？大家想想，每个域名都有一个<strong>后缀</strong>,比如说ovear是<strong>[.info]后缀</strong>的。那么就有一个专门记录[.info]后缀的dns服务器，其他后缀也一样。这个DNS就是该域名的根DNS。<br />\n那么<strong>递归DNS</strong>呢？其实递归DNS就是一个代理人，是用来缓解[根DNS]压力的，如果大家都去问[根DNS]，那[根DNS]不早就跪了。毕竟一个人(网站)的地址不是经常变的，所以就有了<strong>TTL</strong>这一说法，根据<strong>DNS</strong>的规定，在一个TTL时间呢，大家就认为你家里(域名所指向的IP)的地址是不会变的，所以代理人[递归DNS]在这个时间内，是只会问一次[根DNS]的，如果你第二次问他，他就会直接告诉你域名所指向的IP地址。这样就可以解决[根DNS]负载过大的问题啦。<br />\n顺便这一张图也可以很准确反映出来之前所说的~ =w=<br />\n<a href=\"http://chinadigitaltimes.net/chinese/files/2014/01/figure_01.gif\"><img class=\"alignnone  wp-image-330681\" alt=\"figure_01\" src=\"http://chinadigitaltimes.net/chinese/files/2014/01/figure_01.gif\" width=\"571\" height=\"402\" /></a></p>\n<p>说了这么久，口水都干了，那么DNS到底跟这次事件有什么关系呢~<br />\n首先来看张图<br />\n<a href=\"http://chinadigitaltimes.net/chinese/files/2014/01/QQ截图20140121154922.png\"><img class=\"alignnone  wp-image-330682\" alt=\"QQ截图20140121154922\" src=\"http://chinadigitaltimes.net/chinese/files/2014/01/QQ截图20140121154922.png\" width=\"600\" height=\"385\" srcset=\"https://chinadigitaltimes.net/chinese/files/2014/01/QQ截图20140121154922.png 667w, https://chinadigitaltimes.net/chinese/files/2014/01/QQ截图20140121154922-300x192.png 300w\" sizes=\"(max-width: 600px) 100vw, 600px\" /></a><br />\n瓦特！肿么这么多域名都指向同一个IP了，这是什么情况0 0。其实这就是典型的<strong>[DNS污染]</strong>了。<br />\n我们知道互联网有两种协议，一种是TCP，一种则是UDP了（知道泥煤啊(╯‵□′)╯︵┻━┻都说我不是学计算机的了）。<br />\nTCP和UDP的主要差别就是：能不能保证传递信息的可靠性。UDP是不管消息是否到达了目标，通过什么途径的，他只管我发出去了就好，所以UDP比TCP快得多，但是可靠性没有TCP好。<br />\n<a href=\"http://chinadigitaltimes.net/chinese/files/2014/01/QQ截图20140121180655.png\"><img class=\"alignnone size-full wp-image-330684\" alt=\"QQ截图20140121180655\" src=\"http://chinadigitaltimes.net/chinese/files/2014/01/QQ截图20140121180655.png\" width=\"429\" height=\"188\" srcset=\"https://chinadigitaltimes.net/chinese/files/2014/01/QQ截图20140121180655.png 429w, https://chinadigitaltimes.net/chinese/files/2014/01/QQ截图20140121180655-300x131.png 300w\" sizes=\"(max-width: 429px) 100vw, 429px\" /></a><br />\n而DNS查询<strong>默认</strong>就是用的是<strong>UDP</strong>，那么就很好劫持啦。在UDP包任何<strong>传输的路途</strong>上，直接拦截，然后返回给接收端就行了。<br />\n啧啧，说道这大家也隐隐约约知道这次事件的问题了吧，范围如此之广的劫持，必须要在各个省市的主干网上进行，而能处理这么大数据，同时能控制这么多主干网的。。啧啧啧。。。没错！就是<strong>GFW</strong>了~至于<strong>GFW</strong>是什么，Ovear在这就不说了，不然可能大家都见不到Ovear了QAQ。<br />\n说道这里，Ovear就准备手动查一下，到底是不是所推测的GFW呢？于是拿到了这个图（From XiaoXin）<br />\n<a href=\"http://chinadigitaltimes.net/chinese/files/2014/01/d2c0c26c8b00a17a01806b3f0c7b163b_r.jpg\"><img class=\"alignnone  wp-image-330680\" alt=\"d2c0c26c8b00a17a01806b3f0c7b163b_r\" src=\"http://chinadigitaltimes.net/chinese/files/2014/01/d2c0c26c8b00a17a01806b3f0c7b163b_r.jpg\" width=\"609\" height=\"398\" srcset=\"https://chinadigitaltimes.net/chinese/files/2014/01/d2c0c26c8b00a17a01806b3f0c7b163b_r.jpg 677w, https://chinadigitaltimes.net/chinese/files/2014/01/d2c0c26c8b00a17a01806b3f0c7b163b_r-300x195.jpg 300w, https://chinadigitaltimes.net/chinese/files/2014/01/d2c0c26c8b00a17a01806b3f0c7b163b_r-230x150.jpg 230w\" sizes=\"(max-width: 609px) 100vw, 609px\" /></a></p>\n<blockquote><p>与此同时运维也在各地的服务器上开始了跟踪查询，发现全国各地解析时间均为25ms左右。这时候结论就出来了。</p></blockquote>\n<p>这样就明显了，肯定是GFW做的了~~于是Ovear又好奇的查了下，这个IP是什么来头，为什么都要指向到这里去，于是Ovear发现了一些好玩的东西~（http://bgp.he.net/net/65.49.2.0/24#_dns）<br />\n<a href=\"http://chinadigitaltimes.net/chinese/files/2014/01/QQ截图20140121181511.png\"><img class=\"alignnone  wp-image-330685\" alt=\"QQ截图20140121181511\" src=\"http://chinadigitaltimes.net/chinese/files/2014/01/QQ截图20140121181511.png\" width=\"626\" height=\"443\" srcset=\"https://chinadigitaltimes.net/chinese/files/2014/01/QQ截图20140121181511.png 966w, https://chinadigitaltimes.net/chinese/files/2014/01/QQ截图20140121181511-300x212.png 300w\" sizes=\"(max-width: 626px) 100vw, 626px\" /></a><br />\n从侧面点出了此次事件的始作俑者。<br />\n<strong>那么某FW为什么要这么做呢</strong>？Ovear在这里做一个无责任的推测，最有可能的就是：某FW的员工本来是想屏蔽这个IP段的，但是呢一不小心点进去了DNS污染这个选项，<del datetime=\"2014-01-21T10:42:17+00:00\">然后又没写污染目标</del>，于是就全局污染了啧啧啧~</p>\n<p>但是有些童鞋会问了(╯‵□′)╯︵┻━┻为什么他们都说用8.8.8.8就没事了~<br />\n其实这样子说是不正确的，因为Ovear之前用的就是8.8.8.8，上面也说了DNS查询默认使用的UDP查询，所以不管你用什么，照样劫持不误。其实8.8.8.8没问题是因为污染事件已经基本结束导致的，那么为什么污染结束后其他国内DNS都不能用，而Goole的DNS确可以正常的使用~于是Ovear就找到了张有趣的图片~<br />\n<a href=\"http://chinadigitaltimes.net/chinese/files/2014/01/QQ截图20140121154959.png\"><img class=\"alignnone size-full wp-image-330683\" alt=\"QQ截图20140121154959\" src=\"http://chinadigitaltimes.net/chinese/files/2014/01/QQ截图20140121154959.png\" width=\"464\" height=\"281\" srcset=\"https://chinadigitaltimes.net/chinese/files/2014/01/QQ截图20140121154959.png 464w, https://chinadigitaltimes.net/chinese/files/2014/01/QQ截图20140121154959-300x181.png 300w, https://chinadigitaltimes.net/chinese/files/2014/01/QQ截图20140121154959-80x48.png 80w\" sizes=\"(max-width: 464px) 100vw, 464px\" /></a><br />\n我先来解释下上面命令的用途吧~这个命令是用来直接向DNS服务器查询域名的~<br />\n其中的<strong>[-vc]</strong>参数是<strong>强制使用TCP</strong>来查询DNS服务器，这样就可以避免UDP污染的地图炮。</p>\n<p>那么为什么污染结束后，DNS还会受到污染呢？其实原因很简单。Ovear之前说了，<strong>[递归DNS]</strong>是需要询问<strong>[根DNS]</strong>的，而默认的询问方式是采用的UDP，所以在国内的DNS服务器，自然就受到污染了。而之前Ovear也提到过<strong>TTL</strong>这件事~<br />\n在TTL周期内，根据协议[递归DNS]是直接吧结果缓存在自己那，是不会再去查询[根DNS]的，所以国内的DNS就把错误的结果缓存起来了~<br />\n而Google的DNS服务器基本都是在国外，所以查询的时候影响并不大，但是国内挺多域名使用DNSPOD啦，DNSLA的DNS，所以Google进国内查，还是会受到一定影响的。<br />\n因此，如果要完全避免这次的影响，有两个条件<br />\n<strong>1、你的域名的DNS必须是在国外<br />\n2、你查询的DNS必须在国外，而且如果在污染期需要通过TCP查询。</strong><br />\n这样就可以避免这个问题了。</p>\n<p>然后Ovear又手贱查了下这次的TTL，啧啧<br />\n<a href=\"http://chinadigitaltimes.net/chinese/files/2014/01/QQ截图20140121183245.png\"><img class=\"alignnone  wp-image-330686\" alt=\"QQ截图20140121183245\" src=\"http://chinadigitaltimes.net/chinese/files/2014/01/QQ截图20140121183245.png\" width=\"542\" height=\"706\" srcset=\"https://chinadigitaltimes.net/chinese/files/2014/01/QQ截图20140121183245.png 677w, https://chinadigitaltimes.net/chinese/files/2014/01/QQ截图20140121183245-230x300.png 230w\" sizes=\"(max-width: 542px) 100vw, 542px\" /></a><br />\n如果没有人员来手动干预，这次的事件还是要持续蛮久的~。</p>\n<p>另外Ovear在这里奉劝一句媒体，不要听风就是风，听雨就是雨。不要一味的把责任推给无关的DNSPOD等厂商。自己要有判断力。<br />\n顺便引用江主席的一句话</p>\n<blockquote><p>媒体啊，还是要提高自己的知识水平，晓得不晓得啊？（装幽默）唉，我也替你们着急啊，真的</p></blockquote>\n<p>&nbsp;</p>\n<p>哎呀先不说了，我去开门收个快递~，双十二买的好东西终于到了~，回来继续说O(∩_∩)O~~</p>\n","author":980,"categories":[18270,18269,9203,10466],"tags":[7775,12264,8817]}