{"id":328780,"link":"https://chinadigitaltimes.net/chinese/2014/01/翻墙-cow：简化穿墙的http代理/","date":"2014-01-08T13:00:47Z","modified":"2014-01-08T13:00:47Z","title":"翻墙 | COW：简化穿墙的HTTP代理","content":"<p>COW是一个简化穿墙的HTTP代理服务器。它能自动检测被墙网站，仅对这些网站使用二级代理。</p>\n<p>当前版本：0.9.1 <a rel=\"nofollow\" target=\"_blank\" href=\"https://github.com/cyfdecyf/cow/blob/master/CHANGELOG\">CHANGELOG</a></p>\n<p>项目地址：<a rel=\"nofollow\" target=\"_blank\" href=\"https://github.com/cyfdecyf/cow\">https://github.com/cyfdecyf/cow</a></p>\n<p>以下为全文引用内容：</p>\n<h2>功能</h2>\n<div>COW 的设计目标是自动化，理想情况下用户无需关心哪些网站无法访问，可直连网站也不会因为使用二级代理而降低访问速度。</div>\n<ul>\n<li>作为 HTTP 代理，可提供给移动设备使用；若部署在国内服务器上，可作为 APN 代理</li>\n<li>支持 HTTP, SOCKS5, <a rel=\"nofollow\" target=\"_blank\" href=\"https://github.com/clowwindy/shadowsocks/wiki/Shadowsocks-%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E\">shadowsocks</a> 和 cow 自身作为二级代理\n<ul>\n<li>可使用多个二级代理，支持简单的负载均衡</li>\n</ul>\n</li>\n<li>自动检测网站是否被墙，仅对被墙网站使用二级代理</li>\n<li>自动生成包含直连网站的 PAC，访问这些网站时可绕过 COW\n<ul>\n<li>内置<a rel=\"nofollow\" target=\"_blank\" href=\"https://github.com/cyfdecyf/cow/blob/master/site_direct.go\">常见可直连网站</a>，如国内社交、视频、银行、电商等网站（可手工添加）</li>\n</ul>\n</li>\n</ul>\n<h1><a rel=\"nofollow\" target=\"_blank\" href=\"https://github.com/cyfdecyf/cow#%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B\"></a>快速开始</h1>\n<div>安装：</div>\n<ul>\n<li>\n<div><strong>OS X, Linux (x86, ARM):</strong> 执行以下命令（也可用于更新）</div>\n<pre><code>curl -L git.io/cow | bash<br></code></pre>\n</li>\n<li>\n<div><strong>Windows:</strong> <a rel=\"nofollow\" target=\"_blank\" href=\"http://dl.chenyufei.info/cow/\">点此下载</a></div>\n</li>\n<li>熟悉 Go 的用户可用 <code>go get github.com/cyfdecyf/cow</code> 从源码安装</li>\n</ul>\n<div>编辑 <code>~/.cow/rc</code> (Linux) 或 <code>rc.txt</code> (Windows)，简单的配置例子如下：</div>\n<pre><code>#开头的行是注释，会被忽略<br># 本地 HTTP 代理地址<br># 配置 HTTP 和 HTTPS 代理时请填入该地址<br># 或者在自动代理配置中填入 http://127.0.0.1:7777/pac<br>listen = http://127.0.0.1:7777<br><br># SOCKS5 二级代理<br>proxy = socks5://127.0.0.1:1080<br># HTTP 二级代理<br>proxy = http://127.0.0.1:8080<br>proxy = http://user:password@127.0.0.1:8080<br># shadowsocks 二级代理<br>proxy = ss://aes-128-cfb:password@1.2.3.4:8388<br># cow 二级代理<br>proxy = cow://aes-128-cfb:password@1.2.3.4:8388<br></code></pre>\n<div>使用 cow 协议的二级代理需要在国外服务器上安装 COW，并使用如下配置：</div>\n<pre><code>listen = cow://aes-128-cfb:password@0.0.0.0:8388<br></code></pre>\n<div>完成配置后启动 COW 并配置好代理即可使用。</div>\n<h1><a rel=\"nofollow\" target=\"_blank\" href=\"https://github.com/cyfdecyf/cow#%E8%AF%A6%E7%BB%86%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E\"></a>详细使用说明</h1>\n<div>配置文件在 Unix 系统上为 <code>~/.cow/rc</code>，Windows 上为 COW 所在目录的 <code>rc.txt</code> 文件。 <strong><a rel=\"nofollow\" target=\"_blank\" href=\"https://github.com/cyfdecyf/cow/blob/master/doc/sample-config/rc\">样例配置</a> 包含了所有选项以及详细的说明</strong>，建议下载然后修改。</div>\n<div>启动 COW：</div>\n<ul>\n<li>Unix 系统在命令行上执行 <code>cow &</code>\n<ul>\n<li><a rel=\"nofollow\" target=\"_blank\" href=\"https://github.com/cyfdecyf/cow/blob/master/doc/init.d/cow\">Linux 启动脚本</a>，如何使用请参考注释（Debian 测试通过，其他 Linux 发行版应该也可使用）</li>\n</ul>\n</li>\n<li>Windows\n<ul>\n<li>双击 <code>cow-taskbar.exe</code>，隐藏到托盘执行</li>\n<li>双击 <code>cow-hide.exe</code>，隐藏为后台程序执行</li>\n<li>以上两者都会启动 <code>cow.exe</code></li>\n</ul>\n</li>\n</ul>\n<div>PAC url 为 <code>http://<listen address>/pac</code>，也可将浏览器的 HTTP/HTTPS 代理设置为 <code>listen address</code> 使所有网站都通过 COW 访问。</div>\n<div><strong>使用 PAC 可获得更好的性能，但若 PAC 中某网站从直连变成被封，浏览器会依然尝试直连。遇到这种情况可以暂时不使用 PAC 而总是走 HTTP 代理，让 COW 学习到新的被封网站。</strong></div>\n<div>命令行选项可以覆盖部分配置文件中的选项、打开 debug/request/reply 日志，执行 <code>cow -h</code> 来获取更多信息。</div>\n<h2></h2>\n<h3><a rel=\"nofollow\" target=\"_blank\" href=\"https://github.com/cyfdecyf/cow#%E6%89%8B%E5%8A%A8%E6%8C%87%E5%AE%9A%E8%A2%AB%E5%A2%99%E5%92%8C%E7%9B%B4%E8%BF%9E%E7%BD%91%E7%AB%99\"></a>手动指定被墙和直连网站</h3>\n<div><strong>一般情况下无需手工指定被墙和直连网站，该功能只是是为了处理特殊情况和性能优化。</strong></div>\n<div><code>~/.cow/blocked</code> 和 <code>~/.cow/direct</code> 可指定被墙和直连网站（<code>direct</code> 中的 host 会添加到 PAC）：</div>\n<ul>\n<li>每行一个域名或者主机名（COW 会先检查主机名是否在列表中，再检查域名）\n<ul>\n<li>二级域名如 <code>google.com</code> 相当于 <code>*.google.com</code></li>\n<li><code>com.hk</code>, <code>edu.cn</code> 等二级域名下的三级域名，作为二级域名处理。如 <code>google.com.hk</code> 相当于<code>*.google.com.hk</code></li>\n<li>其他三级及以上域名/主机名做精确匹配，例如 <code>plus.google.com</code></li>\n</ul>\n</li>\n</ul>\n<div>注意：对私有 IPv4 地址及 simple host name，COW 总是直接连接，生成的 PAC 也让浏览器直接访问。（因此访问 localhost 和局域网内机器会绕过 COW。）</div>\n<h1><a rel=\"nofollow\" target=\"_blank\" href=\"https://github.com/cyfdecyf/cow#%E6%8A%80%E6%9C%AF%E7%BB%86%E8%8A%82\"></a>技术细节</h1>\n<h2><a rel=\"nofollow\" target=\"_blank\" href=\"https://github.com/cyfdecyf/cow#%E8%AE%BF%E9%97%AE%E7%BD%91%E7%AB%99%E8%AE%B0%E5%BD%95\"></a>访问网站记录</h2>\n<div>COW 在 <code>~/.cow/stat</code> json 文件中记录经常访问网站被墙和直连访问的次数。</div>\n<ul>\n<li><strong>对未知网站，先尝试直接连接，失败后使用二级代理重试请求，2 分钟后再尝试直接</strong>\n<ul>\n<li>内置<a rel=\"nofollow\" target=\"_blank\" href=\"https://github.com/cyfdecyf/cow/blob/master/site_blocked.go\">常见被墙网站</a>，减少检测被墙所需时间（可手工添加）</li>\n</ul>\n</li>\n<li>直连访问成功一定次数后相应的 host 会添加到 PAC</li>\n<li>host 被墙一定次数后会直接用二级代理访问\n<ul>\n<li>为避免误判，会以一定概率再次尝试直连访问</li>\n</ul>\n</li>\n<li>host 若一段时间没有访问会自动被删除（避免 <code>stat</code> 文件无限增长）</li>\n<li>内置网站列表和用户指定的网站不会出现在统计文件中</li>\n</ul>\n<h2><a rel=\"nofollow\" target=\"_blank\" href=\"https://github.com/cyfdecyf/cow#cow-%E5%A6%82%E4%BD%95%E6%A3%80%E6%B5%8B%E8%A2%AB%E5%A2%99%E7%BD%91%E7%AB%99\"></a>COW 如何检测被墙网站</h2>\n<div>COW 将以下错误认为是墙在作怪：</div>\n<ul>\n<li>服务器连接被重置 (connection reset)</li>\n<li>创建连接超时</li>\n<li>服务器读操作超时</li>\n</ul>\n<div>无论是普通的 HTTP GET 等请求还是 CONNECT 请求，失败后 COW 都会自动重试请求。（如果已经有内容发送回 client 则不会重试而是直接断开连接。）</div>\n<div>用连接被重置来判断被墙通常来说比较可靠，超时则不可靠。COW 每隔半分钟会尝试估算合适的超时间隔，避免在网络连接差的情况下把直连网站由于超时也当成被墙。 COW 默认配置下检测到被墙后，过两分钟再次尝试直连也是为了避免误判。</div>\n<div>如果超时自动重试给你造成了问题，请参考<a rel=\"nofollow\" target=\"_blank\" href=\"https://github.com/cyfdecyf/cow/blob/master/doc/sample-config/rc\">样例配置</a>高级选项中的 <code>readTimeout</code>, <code>dialTimeout</code> 选项。</div>\n<h2><a rel=\"nofollow\" target=\"_blank\" href=\"https://github.com/cyfdecyf/cow#%E9%99%90%E5%88%B6\"><span></span></a>限制</h2>\n<ul>\n<li>不提供 cache</li>\n<li>不支持 HTTP pipeline（Chrome, Firefox 默认都没开启 pipeline，支持这个功能容易增加问题而好处并不明显）</li>\n</ul>\n<h1><a rel=\"nofollow\" target=\"_blank\" href=\"https://github.com/cyfdecyf/cow#%E8%87%B4%E8%B0%A2\"></a>致谢</h1>\n<div>贡献代码：</div>\n<ul>\n<li>@tevino: http parent proxy basic authentication</li>\n<li>@xupefei: 提供 cow-hide.exe 以在 windows 上在后台执行 cow.exe</li>\n<li>@sunteya: 改进启动和安装脚本</li>\n</ul>\n<div>Bug reporter:</div>\n<ul>\n<li>GitHub users: glacjay, trawor, Blaskyy, lucifer9, zellux, xream, hieixu, fantasticfears, perrywky, JayXon, graminc, WingGao, polong, dallascao</li>\n<li>Twitter users: 特别感谢 @shao222 多次帮助测试新版并报告了不少 bug, @xixitalk</li>\n</ul>\n<div>\n<div>@glacjay 对 0.3 版本的 COW 提出了让它更加自动化的建议，使我重新考虑 COW 的设计目标并且改进成 0.5 版本之后的工作方式。</div>\n<div></div>\n<div><a rel=\"nofollow\" target=\"_blank\" href=\"http://goagent.biz/thread-1327-1-1.html\">http://goagent.biz/thread-1327-1-1.html</a></div>\n</div>\n<p>另附作者提供的“福利”</p>\n<p><a rel=\"nofollow\" target=\"_blank\" href=\"http://goagent.biz/thread-1328-1-1.html\">https://gist.github.com/lexrus/8120938</a></p>\n<div>翻墙技术博客<a rel=\"nofollow\" target=\"_blank\" href=\"http://www.chinagfw.org/2013/09/blog-post.html\">订阅地址及社交帐号</a></div>\n</p>\n<p><small>本文由自动聚合程序取自网络，内容和观点不代表数字时代立场</small></p>\n<p><iframe src=\"https://docs.google.com/spreadsheet/embeddedform?hl=zh-CN&#038;formkey=dGRpN3FrVThuMFFsZHBZcmNGLW94dEE6MQ\" width=\"510\" height=\"328\" frameborder=\"0\" marginheight=\"0\" marginwidth=\"0\">Loading&#8230;</iframe></p>\n<form method=\"POST\" action=\"http://chinadigitaltimes.us4.list-manage.com/subscribe/post?u=17daa75df533f6c6ff72e51ab&#038;id=b4fd4ae247\">\n<a href=\"http://eepurl.com/mstlf\">墙外新闻实时更新 欢迎订阅数字时代</a><br />\n <br /><input type=\"email\" value=\"\" name=\"EMAIL\" id=\"mce-EMAIL_in_post\" size=\"25\" style=\"display:block;\" placeholder=\"请输入您的邮件地址\" required><br />\n\t<input type=\"submit\" value=\"点击订阅\" name=\"subscribe\" style=\"height: 20px;\" id=\"in_post_subscribe\"><br />\n</form>\n","author":1005,"categories":[18270,18269,15300],"tags":[8795]}