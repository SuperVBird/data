{"id":287508,"link":"https://chinadigitaltimes.net/chinese/2013/04/翻墙-dd-wrt-集体翻墙实现分流/","date":"2013-04-04T02:15:30Z","modified":"2013-04-04T02:15:30Z","title":"翻墙 | dd-wrt 集体翻墙(实现分流)","content":"<p><span></p>\n<p>你妹这篇文章写好了突然不再了, fuck 又得重新写,真的不知道什么原因；</p>\n<p>前两天以前的一个大学同学突然qq问到我有没有弄过dd-wrt,这个路由器固件也听说过很久,但是一直也没空去关注</p>\n<p>于是就决定弄一下,起初远程进去看了一下同学路由器的配置都和网上标准一个样,就是看不到连接上了pptpvpn了没有</p>\n<p>于是我就登录telnet 进入命令终端去看看, 毕竟做为一个中级以上的Linux运维,linux的日常调试这些没任何问题,刚好</p>\n<p>dd-wrt也是基于linux开发的命令这些差不多都有, 发现日志没有出什么问题,于是就手动pptp /tmp/pptpclient/pptp.conf 这个配置文件</p>\n<p>发现也没反应,在进去一看配置文件貌似有问题,于是叫同学又去弄了一个版本换上去,这个版本对了,直接按照网上的标注配置上去就能ok</p>\n<p>,但是还是不能上twitter, 于是又登录进去,发现在网络接口出现了ppp0 这个接口,</p>\n<p>在route 看一下原来是路由没有加, 在跑到web界面的管理->命令中去看 ,发现粘帖网上的shell启动脚本有问题, 空格很多都变成了乱码</p>\n<p>,终于发现问题了, 这个启动脚本有问题, 可能是粘帖时候编码之类的原因到处出现乱码, 所以修改一下配置脚本 重启动路由器,等了90秒</p>\n<p>终于能上twitter了</p>\n<div>\n<table>\n<tbody>\n<tr>\n<td>\n<pre>sleep <span>90</span>  OLDGW<span>=</span>$<span>(</span>nvram get wan_gateway<span>)</span>  VPNSRV<span>=</span>$<span>(</span>nvram get pptpd_client_srvip<span>)</span>  VPNSRVSUB<span>=</span>$<span>(</span>nvram get pptpd_client_srvsub<span>)</span>  PPTPDEV<span>=</span>$<span>(</span>route <span>-</span>n <span>|</span> grep <span>^</span>$<span></span>VPNSRVSUB<span>%</span>.<span>[</span><span>0</span><span>-</span><span>9</span><span>]</span><span>*</span><span></span> <span>|</span> awk <span>'print $NF'</span><span>|</span> head <span>-</span>n <span>1</span><span>)</span>  VPNGW<span>=</span>$<span>(</span>ifconfig $PPTPDEV <span>|</span> grep <span>-</span>Eo <span>\"P-t-P:([0-9.]+)\"</span> <span>|</span> cut <span>-</span>d<span>:</span> <span>-</span>f2<span>)</span>  route add <span>-</span>host $VPNSRV gw $OLDGW  route del <span>default</span> gw $OLDGW  route add <span>default</span> gw $VPNGW</pre>\n</td>\n</tr>\n</tbody>\n</table>\n</div>\n<p>启动后等90秒主要是那个sleep 90 决定,其实可以修改为sleep 20 ,因为这个脚本貌似是在路由器启动好了后才开始运行;</p>\n<p>忙活了将近一天终于搞定了,能帮到同学忙,感觉也不错, 由于昨天说了下 说现在国内的流量其实可以走国内线路,没必要走vpn速度慢死了<br />,其实原理和网上的chnroutes 项目差不多,就是指定路由表的方式, 让国内线路走default gateway 出去,其它的流量全部走vpn出去, 导入的路由表也是<br />国内所有的地址和网段,<br />其实Google上也有个项目autoaddvpn ,地址如下:<br />svn checkout <a rel=\"nofollow\" target=\"_blank\" href=\"http://autoddvpn.googlecode.com/svn/trunk/\">http://autoddvpn.googlecode.com/svn/trunk/</a> autoddvpn-read-only</p>\n<p>svn下来之后,我们只需要根目录的vpnup.sh 这个文件从里面提取出</p>\n<div>\n<table>\n<tbody>\n<tr>\n<td>\n<pre>route add <span>-</span>net <span>*</span>.<span>*</span>.<span>*</span>.<span>*</span><span>/*</span></pre>\n</td>\n</tr>\n</tbody>\n</table>\n</div>\n<p>的条目,有将近3k条,于是马上就想通过web界面的管理保存到启动脚本里面,无奈,可能是太多了吧,直接保存卡死了,保存不完 ,然后上网一查,才知道<br />要打开挂载jffs2 这个 ,但是进入管理也没看没有开启jffs2 这个选项,原来是路由器不支持,这样没办法 ,没法直接保存到路由器上面了<br />难道只有手动的每次断电后去粘帖这个路由表麽,这样肯定不行, 于是在网上看到一篇文章:</p>\n<p><a rel=\"nofollow\" target=\"_blank\" href=\"http://2955941.blog.51cto.com/2945941/910748\">http://2955941.blog.51cto.com/2945941/910748</a></p>\n<p>这文章说的就是,我们可以把路由表文件写成一个启动脚本类型,然后放到远程的一台路由器能够访问到的服务器上面, 这样在路由器启动时候 ,我们保存<br />一个启动指令自动下载远程服务器的文件,并运行就ok了, 这让我想到了思科交换机路由器也有这个功能, 开源的东西就是自定义操作强,命令如下:</p>\n<div>\n<table>\n<tbody>\n<tr>\n<td>\n<pre> <span>if</span>  <span>[</span> <span>!</span> <span>-</span>e  <span>\"/tmp/startup.sh\"</span> <span>]</span><span>;</span>then   cd <span>/</span>tmp<span>/;</span> wget https<span>:</span><span>//blog.4u45.com/startup.sh </span>   .<span>/</span>startup.<span>sh</span>   fi</pre>\n</td>\n</tr>\n</tbody>\n</table>\n</div>\n<p>这样就ok了,每次启动了自动执行,忙活了将近2天,这下可以解决一套东西 也挺不错,以后自己有公司了 ,全部选择开源的路由软件,节约成本 ,哈哈,开源的东西<br />很稳定的;</p>\n<p>原文：<a rel=\"nofollow\" target=\"_blank\" href=\"https://blog.4u45.com/?p=641\">https://blog.4u45.com/?p=641</a></span></p>\n<div>获取最新穿墙软件？请发电邮（最好用gmail）到：cdtcaonima@gmail.com。《中国数字时代》开通IPv6，欢迎穿墙阅读。翻越防火长城，你可以到达世界上的每一个角落。（Across the Great Firewall, you can reach every corner in the world.）翻墙利器赛风3下载地址：<a rel=\"nofollow\" target=\"_blank\" href=\"http://dld.bz/caonima326\n\n\"> http://dld.bz/caonima326</p>\n<p></a>，<a rel=\"nofollow\" target=\"_blank\" href=\"http://dld.bz/caonima745\">http://dld.bz/caonima745</a></div>\n</p>\n<p><small>本文由自动聚合程序取自网络，内容和观点不代表数字时代立场</small></p>\n<p><iframe src=\"https://docs.google.com/spreadsheet/embeddedform?hl=zh-CN&#038;formkey=dGRpN3FrVThuMFFsZHBZcmNGLW94dEE6MQ\" width=\"510\" height=\"328\" frameborder=\"0\" marginheight=\"0\" marginwidth=\"0\">Loading&#8230;</iframe></p>\n<form method=\"POST\" action=\"http://chinadigitaltimes.us4.list-manage.com/subscribe/post?u=17daa75df533f6c6ff72e51ab&#038;id=2ea93c5b7b\">\n<a href=\"http://eepurl.com/msuvD\">墙外新闻实时更新 欢迎订阅数字时代</a><br />\n <br /><input type=\"email\" value=\"\" name=\"EMAIL\" id=\"mce-EMAIL_in_post\" size=\"25\" style=\"display:block;\" placeholder=\"请输入您的邮件地址\" required><br />\n\t<input type=\"submit\" value=\"点击订阅\" name=\"subscribe\" style=\"height: 20px;\" id=\"in_post_subscribe\"><br />\n</form>\n","author":1005,"categories":[18269,15300],"tags":[7775]}