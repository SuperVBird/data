{"id":159717,"link":"https://chinadigitaltimes.net/chinese/2011/06/通过autossh和证书实现ssh断线自动重连/","date":"2011-06-10T00:30:28Z","modified":"2011-06-10T00:30:28Z","title":"通过autossh和证书实现SSH断线自动重连","content":"<p><p> 来源：<a href=\"http://redsan.info/2011/06/%E9%80%9A%E8%BF%87autossh%E5%92%8C%E8%AF%81%E4%B9%A6%E5%AE%9E%E7%8E%B0ssh%E6%96%AD%E7%BA%BF%E8%87%AA%E5%8A%A8%E9%87%8D%E8%BF%9E/\">http://redsan.info/2011/06/%E9%80%9A%E8%BF%87autossh%E5%92%8C%E8%AF%81%E4%B9%A6%E5%AE%9E%E7%8E%B0ssh%E6%96%AD%E7%BA%BF%E8%87%AA%E5%8A%A8%E9%87%8D%E8%BF%9E/</a>    </p>\n<p>以前一直使用GSTM管理翻墙的SSH连接，因为比较简单好用，可是当升到GNOME3之后，GSTM一直没有更新，于是选择使用了autossh。</p>\n<p><p>autossh其实就是在ssh的基础上增加了自动重连的功能，它基本适用各种ssh的参数（除了-f被autossh用作后台运行，并不会传送给 ssh）。但是当autossh 使用-f参数在后台运行时，有个缺点是无法输入密码，而且并没有像plink一样提供-pw参数，所以ssh在-f参数下无法连接至服务器。</p>\n<p><p>这就需要让ssh通过证书免密码登录了。</p>\n<p><p>在本地终端执行ssh-keygen指令，生成rsa密钥和公钥。</p>\n<div>\n<table cellpadding=\"0\" cellspacing=\"0\">\n<tbody>\n<tr>\n<td>\n<div>1               </div>\n</td>\n<td>\n<div><span>[</span><span>red</span><span>@</span>blade ~<span>]</span>$ <span>ssh-keygen</span></div>\n</td>\n</tr>\n</tbody>\n</table>\n</div>\n<p><p>将生成的rsa公钥上传给服务器</p>\n<div>\n<table cellpadding=\"0\" cellspacing=\"0\">\n<tbody>\n<tr>\n<td>\n<div>1               </div>\n</td>\n<td>\n<div><span>[</span><span>red</span><span>@</span>blade ~<span>]</span>$ ssh-copy-id <span>-i</span> ~<span>/</span>.ssh<span>/</span>id_rsa.pub user<span>@</span>server</div>\n</td>\n</tr>\n</tbody>\n</table>\n</div>\n<p><p>通过ssh登录服务器，在服务器上修改/etc/ssh/sshd_config文件，取消以下2行的注释</p>\n<div>\n<table cellpadding=\"0\" cellspacing=\"0\">\n<tbody>\n<tr>\n<td>\n<div>1               <br />2                </div>\n</td>\n<td>\n<div><span>#PubkeyAuthentication yes</span>                <br /><span>#AuthorizedKeysFile .ssh/authorized_keys</span> </div>\n</td>\n</tr>\n</tbody>\n</table>\n</div>\n<p><p>最后在服务器上重启ssh服务</p>\n<div>\n<table cellpadding=\"0\" cellspacing=\"0\">\n<tbody>\n<tr>\n<td>\n<div>1               </div>\n</td>\n<td>\n<div><span>[</span><span>red</span><span>@</span>bass ~<span>]</span>$ <span>sudo</span> service <span>ssh</span> restart</div>\n</td>\n</tr>\n</tbody>\n</table>\n</div>\n<p><p>之后就可以通过autossh自动后台登录ssh并实现自动重连了</p>\n<div>\n<table cellpadding=\"0\" cellspacing=\"0\">\n<tbody>\n<tr>\n<td>\n<div>1               </div>\n</td>\n<td>\n<div><span>[</span><span>red</span><span>@</span>blade ~<span>]</span>$ autossh  <span>-f</span>  <span>-ND</span> <span>7070</span> user<span>@</span>server</div>\n</td>\n</tr>\n</tbody>\n</table>\n</div>\n<p><p>可以将命令保存成脚本，那样就更加方便了。</p>\n<p><p>以上在本人机器上亲自测试通过</p>\n<p><p>本地 Arch Linux @ Dell 1420</p>\n<p><p>服务器 Debian Squeeze @ Linode VPS</p>\n<p>  <a href=\"http://feeds.wordpress.com/1.0/gocomments/xijie.wordpress.com/4598/\" rel=\"nofollow\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/comments/xijie.wordpress.com/4598/\" /></a> <a href=\"http://feeds.wordpress.com/1.0/godelicious/xijie.wordpress.com/4598/\" rel=\"nofollow\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/delicious/xijie.wordpress.com/4598/\" /></a> <a href=\"http://feeds.wordpress.com/1.0/gofacebook/xijie.wordpress.com/4598/\" rel=\"nofollow\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/facebook/xijie.wordpress.com/4598/\" /></a> <a href=\"http://feeds.wordpress.com/1.0/gotwitter/xijie.wordpress.com/4598/\" rel=\"nofollow\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/twitter/xijie.wordpress.com/4598/\" /></a> <a href=\"http://feeds.wordpress.com/1.0/gostumble/xijie.wordpress.com/4598/\" rel=\"nofollow\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/stumble/xijie.wordpress.com/4598/\" /></a> <a href=\"http://feeds.wordpress.com/1.0/godigg/xijie.wordpress.com/4598/\" rel=\"nofollow\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/digg/xijie.wordpress.com/4598/\" /></a> <a href=\"http://feeds.wordpress.com/1.0/goreddit/xijie.wordpress.com/4598/\" rel=\"nofollow\"><img alt=\"\" border=\"0\" src=\"http://feeds.wordpress.com/1.0/reddit/xijie.wordpress.com/4598/\" /></a> <img alt=\"\" border=\"0\" height=\"1\" src=\"http://stats.wordpress.com/b.gif?host=xijie.wordpress.com&#038;blog=10068099&#038;post=4598&#038;subd=xijie&#038;ref=&#038;feed=1\" width=\"1\" /></p>\n</p>\n</p>\n</p>\n</p>\n</p>\n</p>\n</p>\n</p>\n</p>\n<p><img src=\"http://feeds.wordpress.com/1.0/comments/xijie.wordpress.com/4598/\" /></p>\n<p><small>本文由自动聚合程序取自网络，内容和观点不代表数字时代立场</small></p>\n<form method=\"POST\" action=\"http://www.feedblitz.com/f/f.fbz?AddNewUserDirect\">\n定期获得翻墙信息？<a href=\"http://www.feedblitz.com/f/?Sub=738338\">请电邮订阅数字时代</a> <br /><input name=\"EMAIL\" maxlength=\"64\" type=\"text\" size=\"25\" value=\"\"><br />\n<input name=\"FEEDID\" type=\"hidden\" value=\"738338\"><br />\n<input name=\"PUBLISHER\" type=\"hidden\" value=\"7485568\"><br />\n<input type=\"submit\" value=\"订阅!\"><br />\n</form>\n","author":133,"categories":[15300],"tags":[8795]}