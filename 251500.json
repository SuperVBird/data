{"id":251500,"link":"https://chinadigitaltimes.net/chinese/2012/09/翻墙-使用ipfilter过滤gfw滴dns污染喵/","date":"2012-09-14T00:30:24Z","modified":"2012-09-14T00:30:24Z","title":"翻墙 | 使用ipfilter过滤GFW滴DNS污染喵~","content":"<p><p>嗯嗯，最原始文档请参考AutoVPN上滴 <a rel=\"nofollow\" target=\"_blank\" href=\"http://code.google.com/p/autoddvpn/issues/detail?id=120\">这篇文章</a> 喵~</p>\n<p>咱将其原始脚本修订了一些，并添加了 OpenWRT滴正确使用姿势喵~</p>\n<p>一、OpenWRT的准备工作</p>\n<p>普通Linux用户可以直接跳过这一节，因为大多数发行版已经安装了这些必要的软件包了喵~</p>\n<pre lang=\"sh\">opkg update opkg install iptables-mod-filter bind-dig </pre>\n<p>二、脚本本体及注释</p>\n<pre lang=\"bash\">#!/bin/ash  #这行是用一个不存在的域名解析来钓出强制跳转地址  NONEXISTDOMAIN=\"<a rel=\"nofollow\" target=\"_blank\" href=\"http://non.exist.domain.cn\">non.exist.domain.cn</a>\"  #这行写入一些会被污染的域名 POSIONEDDOMAIN=\"<a rel=\"nofollow\" target=\"_blank\" href=\"http://www.twitter.com\">www.twitter.com</a> <a rel=\"nofollow\" target=\"_blank\" href=\"http://www.facebook.com\">www.facebook.com</a> <a rel=\"nofollow\" target=\"_blank\" href=\"http://www.youtube.com\">www.youtube.com</a> <a rel=\"nofollow\" target=\"_blank\" href=\"http://plus.google.com\">plus.google.com</a>\"  #下面这行写入本地的DNS地址，即被污染的DNS服务地址 WALLSERVER=\"61.139.2.69\" LOOPTIMES=9  badip=\"\"  #钓出非法域名强制跳转地址  for DOMAIN in $NONEXISTDOMAIN ; do for IP in $(dig $DOMAIN +time=1 +tries=1 +retry=0 | grep ^$DOMAIN | grep -o -E \"([0-9]+.)3[0-9]+\") ; do if [ -z \"$(echo $badip | grep $IP)\" ] ; then badip=\"$badip $IP\" fi done done  echo First Step: $badip  #钓出污染的IP地址(GFW反馈的)  for i in $(seq $LOOPTIMES) ; do for DOMAIN in $POSIONEDDOMAIN ; do for IP in $(dig @$WALLSERVER $DOMAIN +time=1 +tries=1 +retry=0 | grep ^$DOMAIN | grep -o -E \"([0-9]+.)3[0-9]+\") ; do if [ -z \"$(echo $badip | grep $IP)\" ] ; then badip=\"$badip $IP\" echo $IP $DOMAIN fi done done done  echo Second Step: $badip  #将这些地址在 Firewall里面过滤掉 for IP in $badip do hexip=$(printf &#39;%02X &#39; $IP//./ ; echo) # echo $hexip iptables -I INPUT -p udp --sport 53 -m string --algo bm --hex-string \"|$hexip|\" --from 60 --to 180 -j DROP iptables -I FORWARD -p udp --sport 53 -m string --algo bm --hex-string \"|$hexip|\" --from 60 --to 180 -j DROP done </pre>\n<p>三、原理介绍</p>\n<p>因为DNS是使用UDP数据包进行发送的，正常的查询如下：</p>\n<p>PC 查询域名 -查询UDP包-> 网关 -查询UDP包-> DNS服务器 -返回UDP包-> 网关 -返回UDP包-> PC结束查询</p>\n<p> 被GFW污染之后，GFW抢先在DNS服务器正确包到达之前返回被污染结果：</p>\n<p>PC 查询域名 -查询UDP包-> 网关(路由旁路触发GFW) -查询UDP包-> DNS服务器 -返回UDP包-> (GFW抢先返回)网关 -GFW返回UDP包-> PC结束查询 -正确的UDP包-> 被遗弃</p>\n<p>但是GFW只能固定返回几个IP(返回正确IP风险很高，比如暴风上次导致的故障),所以只要找到这几个IP，加以过滤，则能够将GFW抢答的包在防火墙上设置无效丢包即可，正确的包就会在稍加等待后返回。</p>\n<p> 原文：<a rel=\"nofollow\" target=\"_blank\" href=\"http://kouga.us/?p=642724\">http://kouga.us/?p=642724</a></p>\n<div>获取最新穿墙软件？请发电邮（最好用gmail）到：cdtcaonima@gmail.com。《中国数字时代》开通IPv6，欢迎穿墙阅读。翻越防火长城，你可以到达世界上的每一个角落。（Across the Great Firewall, you can reach every corner in the world.）翻墙利器赛风3下载地址：<a rel=\"nofollow\" target=\"_blank\" href=\"http://dld.bz/caonima326\n\n\"> http://dld.bz/caonima326</p>\n<p></a>，<a rel=\"nofollow\" target=\"_blank\" href=\"http://dld.bz/caonima745\">http://dld.bz/caonima745</a><img width=\"1\" height=\"1\" src=\"https://blogger.googleusercontent.com/tracker/5500297126185736776-7003082204571983126?l=www.chinagfw.org\" alt=\"\" /></div>\n</p>\n<p><small>本文由自动聚合程序取自网络，内容和观点不代表数字时代立场</small></p>\n<p><iframe src=\"https://docs.google.com/spreadsheet/embeddedform?hl=zh-CN&#038;formkey=dGRpN3FrVThuMFFsZHBZcmNGLW94dEE6MQ\" width=\"510\" height=\"328\" frameborder=\"0\" marginheight=\"0\" marginwidth=\"0\">Loading&#8230;</iframe></p>\n<form method=\"POST\" action=\"http://chinadigitaltimes.us4.list-manage.com/subscribe/post?u=17daa75df533f6c6ff72e51ab&#038;id=b4fd4ae247\">\n<a href=\"http://eepurl.com/mstlf\">墙外新闻实时更新 欢迎订阅数字时代</a><br />\n <br /><input type=\"email\" value=\"\" name=\"EMAIL\" id=\"mce-EMAIL_in_post\" size=\"25\" style=\"display:block;\" placeholder=\"请输入您的邮件地址\" required><br />\n\t<input type=\"submit\" value=\"点击订阅\" name=\"subscribe\" style=\"height: 20px;\" id=\"in_post_subscribe\"><br />\n</form>\n","author":1005,"categories":[18269,15300],"tags":[7775,8795]}