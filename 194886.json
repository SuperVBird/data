{"id":194886,"link":"https://chinadigitaltimes.net/chinese/2011/11/翻墙-pptpl2tpfreeradiusmysql搭建vpn认证和流量控制/","date":"2011-11-09T08:30:35Z","modified":"2011-11-09T08:30:35Z","title":"翻墙 | PPTP/L2TP+FreeRADIUS+MySQL搭建VPN认证和流量控制","content":"<p><p><strong>PPTP+FreeRADIUS+MySQL搭建VPN认证和流量控制</strong></p>\n<p>最近帮论坛上朋友建了个OpenVPN+PPTP的VPN服务器，记下来过程以备不时之需。</p>\n<p>系统环境是CentOS 5.6 xen，所有过程中软件均从源码编译。</p>\n<p>需要软件：</p>\n<p><span></span></p>\n<p>PopTop: <a rel=\"nofollow\" title=\"http://poptop.sourceforge.net/\" target=\"_blank\" href=\"http://poptop.sourceforge.net/\">http://poptop.sourceforge.net/</a></p>\n<p>PPPd: <a rel=\"nofollow\" title=\"http://ppp.samba.org/\" target=\"_blank\" href=\"http://ppp.samba.org/\">http://ppp.samba.org/</a></p>\n<p>FreeRADIUS: <a rel=\"nofollow\" title=\"http://freeradius.org/\" target=\"_blank\" href=\"http://freeradius.org/\">http://freeradius.org/</a></p>\n<p>RADIUSClient: <a rel=\"nofollow\" title=\"http://wiki.freeradius.org/Radiusclient\" target=\"_blank\" href=\"http://wiki.freeradius.org/Radiusclient\">http://wiki.freeradius.org/Radiusclient</a></p>\n<p>MySQL: <a rel=\"nofollow\" title=\"http://www.mysql.com/\" target=\"_blank\" href=\"http://www.mysql.com/\">http://www.mysql.com/</a></p>\n<p>同时为了方便管理数据库，最好再装个php，使用phpmyadmin来管理。</p>\n<p>编译过程很简单，pptpd、pppd和freeradius都是</p>\n<div>\n<div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>1</code></td>\n<td><code>./configure && </code><code>make</code> <code>&& </code><code>make</code> <code>install</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n</div>\n<p>就可以了。</p>\n<p>完成之后freeradius的启动脚本在redhat/里面，pptpd需要自己写一个，很简单：</p>\n<div>\n<div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>1</code></td>\n<td><code>#!/bin/sh</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>2</code></td>\n<td><code>#</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>3</code></td>\n<td><code># Startup script for pptpd</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>4</code></td>\n<td><code>#</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>5</code></td>\n<td><code># chkconfig: 345 40 70</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>6</code></td>\n<td><code># description: PPTP server</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>7</code></td>\n<td><code># processname: pptpd</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>8</code></td>\n<td><code># config: /etc/pptpd.conf</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>9</code></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>10</code></td>\n<td><code># Source function library.</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>11</code></td>\n<td><code>. /etc/rc.d/init.d/functions</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>12</code></td>\n<td><code># See how we were called.</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>13</code></td>\n<td><code>case</code> <code>\"$1\"</code> <code>in</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>14</code></td>\n<td><code>  </code><code>start)</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>15</code></td>\n<td><code>        </code><code>echo</code> <code>-n </code><code>\"Starting pptpd: \"</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>16</code></td>\n<td><code>        </code><code>if</code> <code>[ -f /var/lock/subsys/pptpd ] ; </code><code>then</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>17</code></td>\n<td><code>                </code><code>echo</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>18</code></td>\n<td><code>                </code><code>exit</code> <code>1</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>19</code></td>\n<td><code>        </code><code>fi</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>20</code></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>21</code></td>\n<td><code>        </code><code>/usr/</code><code>local</code><code>/sbin/pptpd -d</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>22</code></td>\n<td><code>        </code><code>echo</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>23</code></td>\n<td><code>        </code><code>touch</code> <code>/var/lock/subsys/pptpd</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>24</code></td>\n<td><code>        </code><code>;;</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>25</code></td>\n<td><code>  </code><code>stop)</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>26</code></td>\n<td><code>        </code><code>echo</code> <code>-n </code><code>\"Shutting down pptpd: \"</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>27</code></td>\n<td><code>        </code><code>killproc pptpd</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>28</code></td>\n<td><code>        </code><code>echo</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>29</code></td>\n<td><code>        </code><code>rm</code> <code>-f /var/lock/subsys/pptpd</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>30</code></td>\n<td><code>        </code><code>;;</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>31</code></td>\n<td><code>  </code><code>status)</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>32</code></td>\n<td><code>        </code><code>status pptpd</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>33</code></td>\n<td><code>        </code><code>;;</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>34</code></td>\n<td><code>  </code><code>restart)</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>35</code></td>\n<td><code>        </code><code>$0 stop</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>36</code></td>\n<td><code>        </code><code>$0 start</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>37</code></td>\n<td><code>        </code><code>;;</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>38</code></td>\n<td><code>  </code><code>*)</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>39</code></td>\n<td><code>        </code><code>echo</code> <code>\"Usage: $0 start\"</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>40</code></td>\n<td><code>        </code><code>exit</code> <code>1</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>41</code></td>\n<td><code>esac</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>42</code></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>43</code></td>\n<td><code>exit</code> <code>0</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n</div>\n<p>——————————————————————————–</p>\n<p>然后修改一些FreeRADIUS的配置文件，位于/usr/local/etc/raddb/</p>\n<p>sites-enabled/default</p>\n<p>在所有的unix和files前面加上注释，并去掉所有sql前面的注释。</p>\n<p>radiusd.conf</p>\n<p>去掉include sql.conf前面的注释。</p>\n<p>clients.conf<br />\n这个文件控制连接的客户端的地址以及secret code。<br />\nsecret要记下来，测试和写配置文件的时候要用。默认是testing123</p>\n<p>sql.conf<br />\n这个文件控制连接到sql的参数。<br />\n改成实际数据库的用户名和密码。</p>\n<p>sql/mysql/dialup.conf<br />\n取消</p>\n<div>\n<div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>1</code></td>\n<td><code>sql_user_name = </code><code>\"%%Stripped-User-Name:-%%User-Name:-none}}\"</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n</div>\n<p>前面的注释，把下一行注释掉。<br />\n同时如果需要打开simultanoues-use（控制同时在线用户数）的话需要把simul_query_check取消注释。</p>\n<p>——————————————————————————–</p>\n<p>然后建立基本数据库：</p>\n<div>\n<div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>1</code></td>\n<td><code>/usr/</code><code>local</code><code>/mysql/bin/mysql -uroot -p</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n</div>\n<div>\n<div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>1</code></td>\n<td><code>create</code> <code>database</code> <code>radius;</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>2</code></td>\n<td><code>grant</code> <code>all</code> <code>privileges</code> <code>on</code> <code>radius.* </code><code>to</code> <code>radius@localhost identified </code><code>by</code> <code>\"radiuspassword\"</code><code>;</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>3</code></td>\n<td><code>flush </code><code>privileges</code><code>;</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>4</code></td>\n<td><code>exit;</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n</div>\n<div>\n<div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>1</code></td>\n<td><code>/usr/</code><code>local</code><code>/mysql/bin/mysql -uradius -p radius < /usr/</code><code>local</code><code>/etc/raddb/sql/mysql/schema.sql</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n</div>\n<p>建立表格：</p>\n<div>\n<div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>1</code></td>\n<td><code>INSERT</code> <code>INTO</code> <code>radgroupreply (groupname,attribute,op,VALUE) </code><code>VALUES</code> <code>(</code><code>'user'</code><code>,</code><code>'Auth-Type'</code><code>,</code><code>':='</code><code>,</code><code>'Local'</code><code>);</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>2</code></td>\n<td><code>INSERT</code> <code>INTO</code> <code>radgroupreply (groupname,attribute,op,VALUE) </code><code>VALUES</code> <code>(</code><code>'user'</code><code>,</code><code>'Service-Type'</code><code>,</code><code>':='</code><code>,</code><code>'Framed-User'</code><code>);</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>3</code></td>\n<td><code>INSERT</code> <code>INTO</code> <code>radgroupreply (groupname,attribute,op,VALUE) </code><code>VALUES</code> <code>(</code><code>'user'</code><code>,</code><code>'Framed-IP-Address'</code><code>,</code><code>':='</code><code>,</code><code>'255.255.255.255'</code><code>);</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>4</code></td>\n<td><code>INSERT</code> <code>INTO</code> <code>radgroupreply (groupname,attribute,op,VALUE) </code><code>VALUES</code> <code>(</code><code>'user'</code><code>,</code><code>'Framed-IP-Netmask'</code><code>,</code><code>':='</code><code>,</code><code>'255.255.255.0'</code><code>);</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>5</code></td>\n<td><code>INSERT</code> <code>INTO</code> <code>radgroupreply (groupname,attribute,op,VALUE) </code><code>VALUES</code> <code>(</code><code>'user'</code><code>,</code><code>'Acct-Interim-Interval'</code><code>,</code><code>':='</code><code>,</code><code>'600'</code><code>);</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>6</code></td>\n<td><code>INSERT</code> <code>INTO</code> <code>radgroupreply (groupname,attribute,op,VALUE) </code><code>VALUES</code> <code>(</code><code>'user'</code><code>,</code><code>'Max-Monthly-Traffic'</code><code>,</code><code>':='</code><code>,</code><code>'5368709120'</code><code>);</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>7</code></td>\n<td><code>INSERT</code> <code>INTO</code> <code>radgroupcheck (groupname,attribute,op,VALUE) </code><code>VALUES</code> <code>(</code><code>'user'</code><code>,</code><code>'Simultaneous-Use'</code><code>,</code><code>':='</code><code>,</code><code>'1'</code><code>);</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n</div>\n<p>以上前四行不用改动，acct-interim-interval是计算流量的间隔（600秒），意味着每隔10分钟记录当前流量。倒数第二行是每月最大流量，这里是5G（单位是字节）。最后一行是允许同时连接数目。</p>\n<p>——————————————————————————–</p>\n<p>输入测试用户信息：</p>\n<div>\n<div>\n<div><a rel=\"nofollow\" title=\"view source\" target=\"_blank\" href=\"http://tomem.info/blog/2011/04/562#viewSource\">view source</a><a rel=\"nofollow\" title=\"print\" target=\"_blank\" href=\"http://tomem.info/blog/2011/04/562#printSource\">print</a><a rel=\"nofollow\" title=\"?\" target=\"_blank\" href=\"http://tomem.info/blog/2011/04/562#about\">?</a></div>\n</div>\n<div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>1</code></td>\n<td><code>INSERT</code> <code>INTO</code> <code>radcheck (username,attribute,op,VALUE) </code><code>VALUES</code> <code>(</code><code>'test'</code><code>,</code><code>'Cleartext-Password'</code><code>,</code><code>':='</code><code>,</code><code>'test'</code><code>);</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>2</code></td>\n<td><code>INSERT</code> <code>INTO</code> <code>radusergroup (username,groupname) </code><code>VALUES</code> <code>(</code><code>'test'</code><code>,</code><code>'user'</code><code>);</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n</div>\n<p>用户名与密码必须以明文/NTLM Crypt形式保存，因为MS-CHAPv2不支持MD5保存的密码。</p>\n<p>——————————————————————————–</p>\n<p>由于上步中有非内置的attribute Max-Monthly-Traffic，所以需要在/usr/local/etc/raddb/dictionary里面定义：</p>\n<p>ATTRIBUTE Max-Monthly-Traffic 3003 integer</p>\n<p>——————————————————————————–</p>\n<p>初步测试：</p>\n<div>\n<div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>1</code></td>\n<td><code>/etc/init.d/freeradius stop</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>2</code></td>\n<td><code>radiusd -X &</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>3</code></td>\n<td><code>radtest </code><code>test</code> <code>test</code> <code>localhost 1649 testing123</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n</div>\n<p>如果结果中有Access-Accept就代表成功了，否则退回去检查设置。</p>\n<p>测试成功的话添加在认证时检测流量的语句，打开/usr/local/etc/raddb/sites-enabled/default，找到authorize一节插入：</p>\n<div>\n<div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>1</code></td>\n<td><code>update request </code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>2</code></td>\n<td><code>Group-Name := </code><code>\"%sql:SELECT groupname FROM radusergroup WHERE username='%User-Name' ORDER BY priority}\"</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>3</code></td>\n<td><code>}</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>4</code></td>\n<td><code>if</code> <code>(</code><code>\"%sql: SELECT SUM(acctinputoctets+acctoutputoctets) FROM radacct WHERE username=&#39;%User-Name&#39; AND date_format(acctstarttime, &#39;%Y-%m-%d&#39;) >= date_format(now(),&#39;%Y-%m-01&#39;) AND date_format(acctstoptime, &#39;%Y-%m-%d&#39;) < = last_day(now());}\"</code> <code>>= </code><code>\"%sql: SELECT value FROM radgroupreply WHERE groupname='%Group-Name' AND attribute='Max-Monthly-Traffic';}\"</code><code>) </code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>5</code></td>\n<td><code>reject</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>6</code></td>\n<td><code></code></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n</div>\n<p>——————————————————————————–</p>\n<p>设置radiusclient：</p>\n<p>打开/usr/local/etc/radiusclient/radiusclient.conf，修改</p>\n<p>authserver localhost:1812</p>\n<p>acctserver localhost:1813</p>\n<p>修改server：</p>\n<p>最后加上localhost secret（就是FreeRadius的client.conf里面定义的secret）</p>\n<p>修改dictionary：</p>\n<p>最后加上</p>\n<p>INCLUDE /usr/local/etc/radiusclient/dictionary.merit<br />\nINCLUDE /usr/local/etc/radiusclient/dictionary.microsoft</p>\n<p>如果没有dicitionary.microsoft的话看这里：<a rel=\"nofollow\" title=\"http://wiki.freeradius.org/PopTop\" target=\"_blank\" href=\"http://wiki.freeradius.org/PopTop\">http://wiki.freeradius.org/PopTop</a></p>\n<p>——————————————————————————–</p>\n<p>一切正常后设置pptp：</p>\n<p>把源码包里面的options.pptpd和pptpd.conf拷到/etc/</p>\n<p>修改options.pptpd：</p>\n<p>取消ms-dns前面的注释，后面的ip改为8.8.8.8</p>\n<p>加入一行noaccomp，以提供对iOS 4.3+的支持（否则连上就断）。</p>\n<p>最后加上插件：</p>\n<p>plugin /usr/local/lib/pppd/2.4.5/radius.so<br />\nplugin /usr/local/lib/pppd/2.4.5/radattr.so<br />\nradius-config-file /usr/local/etc/radiusclient/radiusclient.conf</p>\n<p>修改pptpd.conf：</p>\n<p>ppp路径改为/usr/local/sbin/pppd</p>\n<p>option路径为/etc/options.pptpd</p>\n<p>注释掉logwtmp避免619错误</p>\n<p>最后的localip根据需要设置</p>\n<p>示例：localip 192.168.100.1</p>\n<p>remoteip 192.168.100.100-150</p>\n<p>重要的一点：一定要注释掉delegate，之前没有注释结果连接的时候log显示LCP terminated by peer跟着一堆乱码直接掉线，客户端则显示720，注释掉就好了。（虽然个人认为不应该注释，因为delegate的作用是让radius来处理ip分 配）</p>\n<p>启动服务测试下是否能连接，多用radiusd -X看输出信息。</p>\n<p>——————————————————————————–</p>\n<p>最后是相应的iptables设置：/etc/sysconfig/iptables</p>\n<p>nat里面加入：</p>\n<p>-A POSTROUTING -s 192.168.100.0/255.255.255.0 -o eth0 -j MASQUERADE</p>\n<p>filter里面加入：</p>\n<p>-A INPUT -i lo -j ACCEPT<br />\n-A INPUT -i ! lo -d 127.0.0.0/8 -j REJECT<br />\n-A INPUT -m state –state ESTABLISHED,RELATED -j ACCEPT<br />\n-A OUTPUT -j ACCEPT<br />\n-A INPUT -p gre -j ACCEPT<br />\n-A INPUT -p tcp -m state –state NEW –dport 1723 -j ACCEPT<br />\n-A INPUT -p icmp -m icmp –icmp-type 8 -j ACCEPT<br />\n-A INPUT -j REJECT<br />\n-A FORWARD -i ppp+ -p tcp -m tcp –tcp-flags FIN,SYN,RST,ACK SYN -j TCPMSS –set-mss 1356</p>\n<p>设置mss以防止过大的包被丢弃，从而造成无法载入。</p>\n<p>大功告成！</p>\n<p>本文参考：</p>\n<p><a rel=\"nofollow\" title=\"http://wiki.freeradius.org/PopTop\" target=\"_blank\" href=\"http://wiki.freeradius.org/PopTop\">http://wiki.freeradius.org/PopTop</a></p>\n<p><a rel=\"nofollow\" title=\"http://freeradius.1045715.n5.nabble.com/group-variable-td2776238.html\" target=\"_blank\" href=\"http://freeradius.1045715.n5.nabble.com/group-variable-td2776238.html\">http://freeradius.1045715.n5.nabble.com/group-variable-td2776238.html</a></p>\n<p><a rel=\"nofollow\" title=\"http://hi.baidu.com/ox188/blog/item/4ae1373f33d90fe455e723a4.html\" target=\"_blank\" href=\"http://hi.baidu.com/ox188/blog/item/4ae1373f33d90fe455e723a4.html\">http://hi.baidu.com/ox188/blog/item/4ae1373f33d90fe455e723a4.html</a></p>\n<p><a rel=\"nofollow\" title=\"http://www.accountingenhancements.com/filetree/pptp-HOWTO-linux-2.6.9.txt\" target=\"_blank\" href=\"http://www.accountingenhancements.com/filetree/pptp-HOWTO-linux-2.6.9.txt\">http://www.accountingenhancements.com/filetree/pptp-HOWTO-linux-2.6.9.txt</a></p>\n<p><a rel=\"nofollow\" title=\"http://discussions.apple.com/thread.jspa?threadID=2778039&#038;start=60&#038;tstart=0\" target=\"_blank\" href=\"http://discussions.apple.com/thread.jspa?threadID=2778039&#038;start=60&#038;tstart=0\">http://discussions.apple.com/thread.jspa?threadID=2778039&start=60&tstart=0</a></p>\n<p><strong>原文</strong>：<a rel=\"nofollow\" target=\"_blank\" href=\"http://tomem.info/blog/2011/04/562\">http://tomem.info/blog/2011/04/562</a></p>\n<p>==========</p>\n<p><strong>架设L2TP/IPSec + MySQL + FreeRADIUS认证VPN</strong></p>\n<div>\n<p>接上次那篇PPTP的文(<a rel=\"nofollow\" title=\"https://tomem.info/blog/2011/04/562\" target=\"_blank\" href=\"https://tomem.info/blog/2011/04/562\">https://tomem.info/blog/2011/04/562</a>)，这篇讲下如何搭建L2TP VPN。平台依然是CentOS 5.6 x86，源码方式安装。</p>\n<p>说实在的搭建L2TP over IPSec VPN让人头痛不少，主要是因为需要好几个内核模块支持。因而如果你使用的是OpenVZ的VM的话基本上可以忽略这篇文章-2.6.32以下的内核不支持IPSec虚拟化。</p>\n<p>如果是Xen的话，在确定能用PPTP的基础上（包括IP转发，etc），执行以下命令确认必需的模块都存在（xfrm_user可能编入了内核，所以没有检测）：</p>\n<p> </p>\n<div>\n<div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>1</code></td>\n<td><code>modprobe af_key && modprobe ah4 && modprobe esp4 && modprobe ipcomp && modprobe xfrm4_tunnel && </code><code>echo</code> <code>\"All IPSec modules are loaded\"</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n</div>\n<p>如果出现All IPSec modules are loaded则该VM有所有需要的内核模块，否则不能建L2TP over IPSec。</p>\n<p>6月21日更新：最近搞了个日本的VPS，执行上面命令发现模块都存在但是都没加载，而且连ppp的也没有（lsmod | grep -w ‘af_key|ah4|esp4|ipcomp|xfrm4_tunnel|ppp_generic|ppp_mppe |ppp_deflate’） <img src=\"http://tomem.info/blog/wp-includes/images/smilies/icon_eek.gif\" alt=\":shock:\" /> 结果在/etc/sysconfig/modules里面手工添加了。</p>\n<p>———————————————————————————————————-</p>\n<p>成功之后下载需要的软件包：</p>\n<p>首先安装一些编译需要的软件包：</p>\n<p>yum install bison flex lsof gmp gmp-devel libpcap libpcap-devel</p>\n<p>然后下载OpenSwan、xl2tpd和rp-l2tp。</p>\n<p>OpenSwan: <a rel=\"nofollow\" title=\"http://www.openswan.org/code/\" target=\"_blank\" href=\"http://www.openswan.org/code/\">http://www.openswan.org/code/</a></p>\n<p>xl2tpd: <a rel=\"nofollow\" title=\"http://www.xelerance.com/services/software/xl2tpd/\" target=\"_blank\" href=\"http://www.xelerance.com/services/software/xl2tpd/\">http://www.xelerance.com/services/software/xl2tpd/</a></p>\n<p>rp-l2tp: <a rel=\"nofollow\" title=\"http://sourceforge.net/projects/rp-l2tp\" target=\"_blank\" href=\"http://sourceforge.net/projects/rp-l2tp\">http://sourceforge.net/projects/rp-l2tp</a></p>\n<p>OpenSwan编译安装：make programs && make install</p>\n<p>xl2tpd：make && make install</p>\n<p>rp-l2tp我们只需要其中的l2tp-control，执行以下命令：</p>\n<div>\n<div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>1</code></td>\n<td><code>make</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>2</code></td>\n<td><code>cp</code> <code>handlers/l2tp-control /usr/</code><code>local</code><code>/sbin/</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>3</code></td>\n<td><code>mkdir</code> <code>/var/run/xl2tpd</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>4</code></td>\n<td><code>ln</code> <code>-s /usr/</code><code>local</code><code>/sbin/l2tp-control /var/run/xl2tpd/l2tp-control</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n</div>\n<p>———————————————————————————————————-</p>\n<p>写IPSec的配置文件：</p>\n<p>需要修改的地方：</p>\n<p>protostack=auto改成protostack=netkey</p>\n<p>最后加上</p>\n<div>\n<div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>1</code></td>\n<td><code># sample VPN connections, see /etc/ipsec.d/examples/</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>2</code></td>\n<td><code>include /etc/ipsec.d/l2tp-psk.conf </code><code>#添加l2tp配置</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>3</code></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>4</code></td>\n<td><code>#Disable Opportunistic Encryption</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>5</code></td>\n<td><code>include /etc/ipsec.d/no_oe.conf </code><code>#添加oe配置</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n</div>\n<p>注意缩进！上面添加的几行必须是紧靠左边（左边不能有空格）。</p>\n<p>然后新建l2tp-psk.conf和no_oe.conf（来自https://suoluo.org/2010/04/4/）</p>\n<p> </p>\n<div>\n<div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>1</code></td>\n<td><code>nano /etc/ipsec.d/no_oe.conf</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n</div>\n<div>\n<div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>1</code></td>\n<td><code>conn block</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>2</code></td>\n<td><code>auto=ignore</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>3</code></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>4</code></td>\n<td><code>conn private</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>5</code></td>\n<td><code>auto=ignore</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>6</code></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>7</code></td>\n<td><code>conn private-or-</code><code>clear</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>8</code></td>\n<td><code>auto=ignore</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>9</code></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>10</code></td>\n<td><code>conn </code><code>clear</code><code>-or-private</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>11</code></td>\n<td><code>auto=ignore</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>12</code></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>13</code></td>\n<td><code>conn </code><code>clear</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>14</code></td>\n<td><code>auto=ignore</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>15</code></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>16</code></td>\n<td><code>conn packetdefault</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>17</code></td>\n<td><code>auto=ignore</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n</div>\n<div>\n<div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>1</code></td>\n<td><code>nano /etc/ipsec.d/l2tp-psk.conf</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n</div>\n<div>\n<div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>1</code></td>\n<td><code>conn L2TP-PSK-NAT</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>2</code></td>\n<td><code>rightsubnet=vhost:%no,%priv</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>3</code></td>\n<td><code>#forceencaps=yes #这个参数默认是启用的，但如果连接失败抓包分析看到不停的循环在和500端口交换PSK的话就去掉它</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>4</code></td>\n<td><code>also=L2TP-PSK-noNAT</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>5</code></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>6</code></td>\n<td><code>conn L2TP-PSK-noNAT</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>7</code></td>\n<td><code>#</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>8</code></td>\n<td><code># Configuration for one user with any type of IPsec/L2TP client</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>9</code></td>\n<td><code># including the updated Windows 2000/XP (MS KB Q818043), but</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>10</code></td>\n<td><code># excluding the non-updated Windows 2000/XP.</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>11</code></td>\n<td><code>#</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>12</code></td>\n<td><code>#</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>13</code></td>\n<td><code># Use a Preshared Key. Disable Perfect Forward Secrecy.</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>14</code></td>\n<td><code>#</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>15</code></td>\n<td><code># PreSharedSecret needs to be specified in /etc/ipsec.secrets as</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>16</code></td>\n<td><code># YourIPAddress  %any: \"sharedsecret\"</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>17</code></td>\n<td><code>authby=secret</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>18</code></td>\n<td><code>pfs=no</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>19</code></td>\n<td><code>auto=add</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>20</code></td>\n<td><code>keyingtries=3</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>21</code></td>\n<td><code># we cannot rekey for %any, let client rekey</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>22</code></td>\n<td><code>rekey=no</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>23</code></td>\n<td><code>#type=transport</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>24</code></td>\n<td><code>#</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>25</code></td>\n<td><code>left=1.2.3.4 </code><code>#VPS的IP地址</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>26</code></td>\n<td><code>leftnexthop=1.2.3.5 </code><code>#网关地址，通过route -n 可以查看 gateway地址</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>27</code></td>\n<td><code># or you can use: left=YourIPAddress</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>28</code></td>\n<td><code>#</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>29</code></td>\n<td><code># For updated Windows 2000/XP clients,</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>30</code></td>\n<td><code># to support old clients as well, use leftprotoport=17/%any</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>31</code></td>\n<td><code>leftprotoport=17/1701</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>32</code></td>\n<td><code>#</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>33</code></td>\n<td><code># The remote user.</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>34</code></td>\n<td><code>#</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>35</code></td>\n<td><code>right=%any</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>36</code></td>\n<td><code># Using the magic port of \"0\" means \"any one single port\". This is</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>37</code></td>\n<td><code># a work around required for Apple OSX clients that use a randomly</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>38</code></td>\n<td><code># high port, but propose \"0\" instead of their port.</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>39</code></td>\n<td><code>rightprotoport=17/%any</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n</div>\n<p>同样的要注意缩进。在两个conn之间的语句要向右缩进一格。</p>\n<p>设置预置密钥：</p>\n<div>\n<div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>1</code></td>\n<td><code>nano /etc/ipsec.secrets:</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n</div>\n<div>\n<div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>1</code></td>\n<td><code>YOUR.SERVER.IP.ADDRESS %any: PSK </code><code>\"YourSharedSecret\"</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n</div>\n<p> </p>\n<p>最后修改/etc/sysctl.conf：</p>\n<div>\n<div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>1</code></td>\n<td><code># Settings for OpenSwan IPSec implementation</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>2</code></td>\n<td><code>net.ipv4.conf.all.send_redirects = 0</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>3</code></td>\n<td><code>net.ipv4.conf.default.send_redirects = 0</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>4</code></td>\n<td><code>net.ipv4.conf.all.accept_redirects = 0</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>5</code></td>\n<td><code>net.ipv4.conf.default.accept_redirects = 0</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>6</code></td>\n<td><code>net.core.xfrm_larval_drop = 1</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n</div>\n<p>———————————————————————————————————-</p>\n<p>测试下IPSec：</p>\n<div>\n<div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>1</code></td>\n<td><code>/etc/init.d/ipsec start</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n</div>\n<div>\n<div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>1</code></td>\n<td><code>ipsec verify</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n</div>\n<p>如果是类似如下结果就可以继续了（不能有Failed，N/A可以）。</p>\n<p>Checking your system to see if IPsec got installed and started correctly:<br />\nVersion check and ipsec on-path                                 [OK]<br />\nLinux Openswan U2.6.33/K2.6.18-194.11.4.el5xen (netkey)<br />\nChecking for IPsec support in kernel                            [OK]<br />\nSAref kernel support                                           [N/A]<br />\nNETKEY:  Testing XFRM related proc values                      [OK]<br />\n[OK]<br />\n[OK]<br />\nTesting against enforced SElinux mode                           [OK]<br />\nChecking that pluto is running                                  [OK]<br />\nPluto listening for IKE on udp 500                             [OK]<br />\nPluto listening for NAT-T on udp 4500                          [OK]<br />\nTwo or more interfaces found, checking IP forwarding            [OK]<br />\nChecking NAT and MASQUERADEing<br />\nChecking for ‘ip’ command                                       [OK]<br />\nChecking /bin/sh is not /bin/dash                               [OK]<br />\nChecking for ‘iptables’ command                                 [OK]<br />\nOpportunistic Encryption Support                                [DISABLED]</p>\n<p>pluto listening那个与lsof有关，如果显示failed检查是否装了lsof。</p>\n<p>———————————————————————————————————-</p>\n<p>测试通过后修改xl2tpd的配置：</p>\n<p>如果你的ipsec verify结果中间也有SAref kernel support [N/A]的话，在xl2tpd里面就必须关掉saref，否则tail /var/log/secure会出现ERROR: netlink_get_spi for comp.0@server ip failed with errno 22: Invalid argument。</p>\n<div>\n<div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>1</code></td>\n<td><code>[global]</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>2</code></td>\n<td><code>listen-addr = your.server.ip.address</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>3</code></td>\n<td><code>;</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>4</code></td>\n<td><code>; requires openswan-2.5.18 or higher - Also does not yet work </code><code>in</code> <code>combination</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>5</code></td>\n<td><code>; with kernel mode l2tp as present </code><code>in</code> <code>linux 2.6.23+</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>6</code></td>\n<td><code>ipsec saref = no</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>7</code></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>8</code></td>\n<td><code>[lns default]</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>9</code></td>\n<td><code>ip range = 192.168.100.101-192.168.100.151</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>10</code></td>\n<td><code>local</code> <code>ip = 192.168.100.1</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>11</code></td>\n<td><code>refuse chap = </code><code>yes</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>12</code></td>\n<td><code>refuse pap = </code><code>yes</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>13</code></td>\n<td><code>require authentication = </code><code>yes</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>14</code></td>\n<td><code>name = l2tpd</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>15</code></td>\n<td><code>ppp debug = </code><code>yes</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>16</code></td>\n<td><code>pppoptfile = /etc/ppp/options.xl2tpd</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>17</code></td>\n<td><code>length bit = </code><code>yes</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n</div>\n<p>修改ppp配置：</p>\n<div>\n<div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>1</code></td>\n<td><code>require-mschap-v2</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>2</code></td>\n<td><code>ms-dns 8.8.8.8</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>3</code></td>\n<td><code>ms-dns 208.67.222.222</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>4</code></td>\n<td><code>asyncmap 0</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>5</code></td>\n<td><code>auth</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>6</code></td>\n<td><code>crtscts</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>7</code></td>\n<td><code>lock</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>8</code></td>\n<td><code>hide-password</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>9</code></td>\n<td><code>modem</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>10</code></td>\n<td><code>debug</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>11</code></td>\n<td><code>name l2tpd</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>12</code></td>\n<td><code>proxyarp</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>13</code></td>\n<td><code>lcp-</code><code>echo</code><code>-interval 30</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>14</code></td>\n<td><code>lcp-</code><code>echo</code><code>-failure 4</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>15</code></td>\n<td><code>plugin /usr/</code><code>local</code><code>/lib/pppd/2.4.5/radius.so</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>16</code></td>\n<td><code>plugin /usr/</code><code>local</code><code>/lib/pppd/2.4.5/radattr.so</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>17</code></td>\n<td><code>radius-config-</code><code>file</code> <code>/usr/</code><code>local</code><code>/etc/radiusclient/radiusclient.conf</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n</div>\n<p>建立xl2tpd的init script：</p>\n<div>\n<div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>1</code></td>\n<td><code>#!/bin/sh</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>2</code></td>\n<td><code>#</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>3</code></td>\n<td><code># xl2tpd        This shell script takes care of starting and stopping l2tpd.</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>4</code></td>\n<td><code>#</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>5</code></td>\n<td><code># chkconfig: - 80 30</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>6</code></td>\n<td><code># description:  Layer 2 Tunnelling Protocol Daemon (RFC 2661)</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>7</code></td>\n<td><code>#</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>8</code></td>\n<td><code># processname:  /usr/sbin/xl2tpd</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>9</code></td>\n<td><code># config:       /etc/xl2tpd/xl2tpd.conf</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>10</code></td>\n<td><code># pidfile:      /var/run/xl2tpd.pid</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>11</code></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>12</code></td>\n<td><code>### BEGIN INIT INFO</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>13</code></td>\n<td><code># Provides: xl2tpd</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>14</code></td>\n<td><code># Required-Start: $local_fs $network $syslog</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>15</code></td>\n<td><code># Required-Stop: $local_fs $network $syslog</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>16</code></td>\n<td><code># Default-Start:</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>17</code></td>\n<td><code># Short-Description: start|stop|status|restart|try-restart|reload|force-reload xl2tpd server</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>18</code></td>\n<td><code># Description: control xl2tpd server</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>19</code></td>\n<td><code>### END INIT INFO</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>20</code></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>21</code></td>\n<td><code>#Servicename</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>22</code></td>\n<td><code>SERVICE=xl2tpd</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>23</code></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>24</code></td>\n<td><code># Source function library.</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>25</code></td>\n<td><code>. /etc/rc.d/init.d/functions</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>26</code></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>27</code></td>\n<td><code># Source networking configuration.</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>28</code></td>\n<td><code>. /etc/sysconfig/network</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>29</code></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>30</code></td>\n<td><code>if</code> <code>[ $NETWORKING = </code><code>\"no\"</code> <code>]</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>31</code></td>\n<td><code>then</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>32</code></td>\n<td><code>exit</code> <code>0</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>33</code></td>\n<td><code>fi</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>34</code></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>35</code></td>\n<td><code>[ -x /usr/</code><code>local</code><code>/sbin/$SERVICE ] || </code><code>exit</code> <code>0</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>36</code></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>37</code></td>\n<td><code>RETVAL=0</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>38</code></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>39</code></td>\n<td><code>start() </code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>40</code></td>\n<td><code>echo</code> <code>-n </code><code>\"Starting $SERVICE: \"</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>41</code></td>\n<td><code>if</code> <code>[ ! -d /var/run/xl2tpd ]</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>42</code></td>\n<td><code>then</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>43</code></td>\n<td><code>mkdir</code> <code>/var/run/xl2tpd</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>44</code></td>\n<td><code>fi</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>45</code></td>\n<td><code>daemon /usr/</code><code>local</code><code>/sbin/$SERVICE</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>46</code></td>\n<td><code>RETVAL=$?</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>47</code></td>\n<td><code>echo</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>48</code></td>\n<td><code>if</code> <code>[ $RETVAL -</code><code>eq</code> <code>0 ];</code><code>then</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>49</code></td>\n<td><code>touch</code> <code>/var/lock/subsys/$SERVICE</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>50</code></td>\n<td><code>else</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>51</code></td>\n<td><code>exit</code> <code>7;</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>52</code></td>\n<td><code>fi</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>53</code></td>\n<td><code>return</code> <code>0;</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>54</code></td>\n<td><code></code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>55</code></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>56</code></td>\n<td><code>stop() </code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>57</code></td>\n<td><code>echo</code> <code>-n </code><code>\"Stopping $SERVICE: \"</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>58</code></td>\n<td><code>killproc $SERVICE</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>59</code></td>\n<td><code>RETVAL=$?</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>60</code></td>\n<td><code>if</code> <code>[ $RETVAL -</code><code>eq</code> <code>0 ]; </code><code>then</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>61</code></td>\n<td><code>rm</code> <code>-f /var/run/xl2tpd/$SERVICE</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>62</code></td>\n<td><code>rm</code> <code>-f /var/lock/subsys/$SERVICE</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>63</code></td>\n<td><code>fi</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>64</code></td>\n<td><code>echo</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>65</code></td>\n<td><code>return</code> <code>$RETVAL</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>66</code></td>\n<td><code></code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>67</code></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>68</code></td>\n<td><code>restart() </code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>69</code></td>\n<td><code>stop</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>70</code></td>\n<td><code>start</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>71</code></td>\n<td><code></code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>72</code></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>73</code></td>\n<td><code># See how we were called.</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>74</code></td>\n<td><code>case</code> <code>\"$1\"</code> <code>in</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>75</code></td>\n<td><code>start)</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>76</code></td>\n<td><code>start</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>77</code></td>\n<td><code>;;</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>78</code></td>\n<td><code>stop)</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>79</code></td>\n<td><code>stop</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>80</code></td>\n<td><code>;;</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>81</code></td>\n<td><code>status)</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>82</code></td>\n<td><code>status $SERVICE</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>83</code></td>\n<td><code>RETVAL=$?</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>84</code></td>\n<td><code>;;</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>85</code></td>\n<td><code>restart|reload)</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>86</code></td>\n<td><code>restart</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>87</code></td>\n<td><code>;;</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>88</code></td>\n<td><code>condrestart)</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>89</code></td>\n<td><code>[ -f /var/lock/subsys/$SERVICE ] &amp;&amp; restart || :</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>90</code></td>\n<td><code>;;</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>91</code></td>\n<td><code>*)</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>92</code></td>\n<td><code>echo</code> <code>\"Usage: $SERVICE start\"</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>93</code></td>\n<td><code>exit</code> <code>1</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>94</code></td>\n<td><code>esac</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n</div>\n<p>———————————————————————————————————-</p>\n<p>最后对应的iptables的配置：</p>\n<div>\n<div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>1</code></td>\n<td><code>-A INPUT -p udp -m state --state NEW -m udp --dport 500 -j ACCEPT</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>2</code></td>\n<td><code>-A INPUT -p udp -m state --state NEW -m udp --dport 1701 -j ACCEPT</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>3</code></td>\n<td><code>-A INPUT -p udp -m state --state NEW -m udp --dport 4500 -j ACCEPT</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n</div>\n<p>大功告成！</p>\n<p>参考：</p>\n<p><a rel=\"nofollow\" title=\"http://b.gkp.cc/2010/06/19/setup-ipsec-l2tp-on-centos-55/\" target=\"_blank\" href=\"http://b.gkp.cc/2010/06/19/setup-ipsec-l2tp-on-centos-55/\">http://b.gkp.cc/2010/06/19/setup-ipsec-l2tp-on-centos-55/</a></p>\n<p><a rel=\"nofollow\" title=\"https://suoluo.org/2010/04/4/\" target=\"_blank\" href=\"https://suoluo.org/2010/04/4/\">https://suoluo.org/2010/04/4/</a></p>\n<p><strong>原文</strong>：<a rel=\"nofollow\" target=\"_blank\" href=\"http://tomem.info/blog/2011/04/577\">http://tomem.info/blog/2011/04/577</a></p>\n<p>==========</p>\n<p><strong>FreeRADIUS+PostgreSQL+OpenVPN搭建VPN认证系统</strong></p>\n<p>最近从Ramhost上又订了一个Nano plan，用来搭建认证VPN的系统<br />\n环境：Ubuntu 9.10 x86, 128M RAM<br />\nFreeradius 2.1.0, RADIUS for OpenVPN 2.1beta9, OpenVPN 2.1, PostgreSQL 8.4.4</p>\n<p>OpenVPN是什么应该不用解释了。<br />\nFreeRADIUS是一个开源的RADIUS系统，目前是最为广泛使用的RADIUS，至于什么是RADIUS可以看<a rel=\"nofollow\" target=\"_blank\" href=\"http://en.wikipedia.org/wiki/RADIUS\">这里</a>：</p>\n<p> </p>\n<p>1、安装组件</p>\n<p>所需要的组件基本上都在Ubuntu的package source里面，用apt-get就可以装。</p>\n<pre lang=\"bash\">sudo apt-get install freeradius freeradius-postgresql postgresql openvpn build-essential libgcrypt11-dev</pre>\n<p> </p>\n<p>2、修改配置文件</p>\n<p>Freeradius的配置文件位于/etc/freeradius</p>\n<p>/etc/freeradius/clients.conf<br />\n这个文件控制连接的客户端的地址以及secret code。<br />\n地址不需要改变，因为我们是本地访问（openvpn到freeradius）。<br />\nsecret要记下来，测试和写配置文件的时候要用。默认是testing123</p>\n<p>/etc/freeradius/sql.conf<br />\n这个文件控制连接到sql的参数。<br />\n要改的地方：<br />\ndatabase=”sql” 改成 database=”postgresql”<br />\nConnection info那里一般来说改密码就可以了。</p>\n<p>/etc/freeradius/sql/postgresql/dialup.conf<br />\n取消sql_user_name = “%%Stripped-User-Name:-%%User-Name:-none}}”前面的注释，把下一行注释掉。</p>\n<p>/etc/freeradius/sites-enabled/default<br />\n取消掉authorize、preacct和accounting段中sql前面的注释<br />\n注释掉所有的files和unix。</p>\n<p>————————————————————-</p>\n<p>Postgresql的配置文件做如下修改：</p>\n<p>/etc/postgresql/8.4/main/postgresql.conf</p>\n<p>找到listen_addresses，把引号里面的地址改成*</p>\n<p>/etc/postgresql/8.4/main/pg_hba.conf</p>\n<p>把local all all那里的ident改成md5<br />\n加入一行<br />\nhost all all 0.0.0.0/0 md5</p>\n<p> </p>\n<p>3、建立数据库</p>\n<pre lang=\"bash\">sudo -u postgres createuser radius --no-superuser --no-createdb --no-createrole -P</pre>\n<p>密码与sql.conf中connection info的密码一致。</p>\n<p> </p>\n<pre lang=\"bash\">sudo -u postgres createdb radius --owner=radius</pre>\n<p> </p>\n<p>然后</p>\n<pre lang=\"bash\">sudo cp /etc/freeradius/sql/postgresql/schema.sql ~/</pre>\n<p> </p>\n<pre lang=\"bash\">psql -U radius radius < ~/schema.sql</pre>\n<p>然后连到sql上面，用psql或者pgadmin都可以。</p>\n<p>psql里面输入如下命令：</p>\n<pre lang=\"sql\">insert into radgroupreply (groupname,attribute,op,value) values ('user','Auth-Type',':=','Local');\ninsert into radgroupreply (groupname,attribute,op,value) values ('user','Service-Type',':=','Dialout-Framed-User');\ninsert into radgroupreply (groupname,attribute,op,value) values ('user','Framed-IP-Address',':=','255.255.255.255');\ninsert into radgroupreply (groupname,attribute,op,value) values ('user','Framed-IP-Netmask',':=','255.255.255.0');\ninsert into radgroupreply (groupname,attribute,op,value) values ('user','Acct-Interim-Interval',':=','600');\ninsert into radcheck (username,attribute,op,value) values ('test','Cleartext-Password',':=','test');\ninsert into radusergroup (username,groupname) values ('test','user');</pre>\n<p>最后q退出。</p>\n<p> </p>\n<p>4、初步测试</p>\n<pre lang=\"bash\">sudo /etc/init.d/freeradius stop\nsudo freeradius -X &\nradtest test test localhost 1649 testing123</pre>\n<p>如果出现类似如下信息：</p>\n<pre> Sending Access-Request of id 204 to 127.0.0.1 port 1812\n User-Name = \"test\"\n User-Password = \"test\"\n NAS-IP-Address = 255.255.255.255\n NAS-Port = 0\n rad_recv: Access-Accept packet from host 127.0.0.1:1812, id=204, length=38\n Service-Type = Framed-User\n Framed-IP-Address = 255.255.255.255\n Framed-IP-Netmask = 255.255.255.0</pre>\n<p>即Access-Accept时，则说明freeradius和postgresql已经成功地连接起来了，否则要退回去检查配置。</p>\n<p> </p>\n<p>5、配置OpenVPN</p>\n<p>首先要把OpenVPN和Freeradius连接起来，这里是通过OpenVPN的插件Radiusplugin for OpenVPN。</p>\n<p> </p>\n<pre lang=\"bash\">wget http://www.nongnu.org/radiusplugin/radiusplugin_v2.1_beta9.tar.gz\ntar zxvf radiusplugin_v2.1_beta9.tar.gz\ncd radiusplugin/\nmake</pre>\n<p> </p>\n<p>应该会在当前目录下生成radiusplugin.so和radiusplugin.cnf，拷到/etc/openvpn。<br />\n修改/etc/openvpn/radiusplugin.cnf：</p>\n<p>OpenVPNConfig=/etc/openvpn/openvpn.conf<br />\nsharedsecret= testing123<br />\n这里secret要与clients.conf中间的一致。<br />\n同时后面server段中的name要改成FreeRadius服务器的IP（本例中是本机localhost）</p>\n<p>然后生成OpenVPN的key：</p>\n<pre lang=\"bash\">sudo su\ncp -R /usr/share/doc/openvpn/examples/easy-rsa /etc/openvpn\ncd /etc/openvpn/easy-rsa/2.0\n. ./vars\n./clean-all\n./build-ca\n./build-key-server server\n./build-key client1\n./build-dh</pre>\n<p>然后把生成的ca.crt拖到客户端上，用winscp连到ssh就可以。</p>\n<p>配置OpenVPN服务端：</p>\n<pre lang=\"bash\">sudo nano /etc/openvpn/openvpn.conf</pre>\n<pre>dev tun\nproto tcp\nport xxxx\n\nca /etc/openvpn/easy-rsa/2.0/keys/ca.crt\ncert /etc/openvpn/easy-rsa/2.0/keys/server.crt\nkey /etc/openvpn/easy-rsa/2.0/keys/server.key\ndh /etc/openvpn/easy-rsa/2.0/keys/dh1024.pem\n\nuser nobody\ngroup nogroup\nserver 10.8.0.0 255.255.255.0\n\nclient-cert-not-required\nusername-as-common-name\nplugin /etc/openvpn/radiusplugin.so /etc/openvpn/radiusplugin.cnf\nstatus /var/log/openvpn/status.log 1\nlog /var/log/openvpn/openvpn.log\n\npersist-key\npersist-tun\n\npush \"redirect-gateway def1\"\npush \"dhcp-option DNS 8.8.8.8\"\npush \"dhcp-option DNS 208.67.222.222\"\n\nauth RSA-SHA512\ncipher AES-256-CBC\n\ncomp-lzo</pre>\n<p>客户端：</p>\n<p> </p>\n<pre>client\ndev tun\nproto tcp\n\nremote your-server-address xxxx\n\nresolv-retry infinite\nnobind\n\npersist-key\npersist-tun\n\nscript-security 2\nauth RSA-SHA512\ncipher AES-256-CBC\n\nca ca.crt\nauth-user-pass\n\nverb 3\n\nns-cert-type server\n\ncomp-lzo</pre>\n<p> </p>\n<p>再向/etc/rc.local中加入如下内容：</p>\n<pre lang=\"bash\"># add iptables rule for openvpn\niptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o venet0 -j SNAT --to-source your-server-ip-address\n\n# restart openvpn after 1 hour in case tun device got broken on reboot\nsleep 3600\n/etc/init.d/openvpn stop\nsleep 10\n/etc/init.d/openvpn start</pre>\n<p>加到exit 0前面。</p>\n<p>重启等一个小时之后连接服务器应该会提示输入用户名密码，之后看到OpenVPN变绿就表示成功了。可以连到whatsmyip.org检查。</p>\n<p>用户名密码可以通过pgadmin连到sql上面去修改，在radcheck里面。</p>\n<p> </p>\n<p>本文参考了如下资料，在此表示感谢：</p>\n<p>http://blog.chinaunix.net/u1/36506/showart_457803.html</p>\n<p>https://forum.ramhost.us/bbs/viewtopic.php?id=4</p>\n<p>http://wiki.freeradius.org/SQL_HOWTO</p>\n<p>http://wiki.freeradius.org/Postgres_DDL_script</p>\n<p>http://www.linuxsir.org/main/node/275</p>\n<p><strong>原文</strong>：<a rel=\"nofollow\" target=\"_blank\" href=\"http://tomem.info/blog/2010/06/207\">http://tomem.info/blog/2010/06/207</a></p>\n<p>==========</p>\n<p><strong>FreeRADIUS+Postgresql+OpenVPN续：流量控制</strong></p>\n<div>\n<p>实质上很简单，就是求和＋if判断，枉自研究了半天的rlm_sql_counter</p>\n<p>示例的是每月限制流量，针对用户组</p>\n<p>1. 设定限制</p>\n<p>radgroupreply组里面插入一行，命令如下：</p>\n<pre lang=\"SQL\">insert into radgroupreply (groupname, attribute, op, value) values ('user','Max-Monthly-Traffic', ':=', '5368709120');</pre>\n<p>以上命令表示对用户组user限制流量为5G，单位是bytes</p>\n<p>同时还要加入Acct-Interim-Interval，该参数是定义让OpenVPN plugin更新流量记录的间隔，必须是为300-3600秒之间的一个值</p>\n<p>2. 判断命令</p>\n<p>修改/etc/freeradius/sites-enabled/default的authorize一节，插入：</p>\n<pre lang=\"SQL\">update request \n                Group-Name := \"%sql:SELECT groupname FROM radusergroup WHERE username=&#39;%User-Name&#39; ORDER BY priority}\"\n}\nif (\"%sql: SELECT SUM(acctinputoctets+acctoutputoctets) FROM radacct WHERE username=&#39;%User-Name&#39; AND date_trunc(&#39;day&#39;, acctstarttime) >= date_trunc (&#39;month&#39;, current_date) AND date_trunc(&#39;day&#39;, acctstoptime) < = last_day(current_date);}\" >= \"%sql: SELECT value FROM radgroupreply WHERE groupname=&#39;%Group-Name&#39; AND attribute=&#39;Max-Monthly-Traffic&#39;;}\") \n\nreject\n\n</pre>\n<p>该行作用是用户连接时检查本月内上下行流量之和（1日-月末，acctinputoctet+acctoutputoctet），与限制相比较，如果相同或超过则拒绝认证。</p>\n<p>中间使用了自定义函数last_day，所以需要在pgsql中定义。</p>\n<p>3. 定义日期函数</p>\n<p>来自<a rel=\"nofollow\" title=\"http://wiki.postgresql.org/wiki/Date_LastDay\" target=\"_blank\" href=\"http://wiki.postgresql.org/wiki/Date_LastDay\">http://wiki.postgresql.org/wiki/Date_LastDay</a></p>\n<pre lang=\"SQL\">CREATE OR REPLACE FUNCTION last_day(date) RETURNS date AS $$\n\nSELECT (date_trunc('MONTH', $1) + INTERVAL '1 MONTH - 1 day')::date; $$ LANGUAGE 'sql' IMMUTABLE STRICT;</pre>\n<p>4. 定义Max-Monthly-Traffic</p>\n<p>由于这不是Freeradius自带的属性，所以需要在dictionary中定义，否则freeradius不会去读这个属性</p>\n<div>修改/etc/freeradius/dictionary</div>\n<div>\n<p>加入</p>\n<p> </p>\n<pre>Attribute Max-Monthly-Traffic 3003 integer</pre>\n<p> </p>\n<p>重启大功告成。试验的话把流量限制改成1，应该会被拒绝连接。</p>\n<p> </p>\n<p>bug：如果用户一直不断开连接的话就无法拒绝认证了……FreeRADIUS不能踢人下线的。OpenVPN plugin的作者建议在openvpn.conf里加入reneg-sec xx让用户定时重新验证，同时在radiusplugin.cnf中使用useauthcontrolfile=true让用户在验证时不掉线。不过在实 验中useauthcontrolfile=true这条始终没成功过，不知道是什么原因。</p>\n<p><strong>原文</strong>：<a rel=\"nofollow\" target=\"_blank\" href=\"http://tomem.info/blog/2010/07/272\">http://tomem.info/blog/2010/07/272</a></p>\n<p>===========</p>\n<p><strong>Strongswan-IKEv2+FreeRADIUS VPN配置</strong></p>\n<div>\n<p>前一篇文章里面提到了用Strongswan替换Openswan的最大理由就是IKEv2和对于Radius的支持，这篇文章继续介绍如何使用Strongswan和Freeradius建立IKEv2 VPN。</p>\n<p>目前支持IKEv2的客户端貌似只有Openswan/Strongswan，Windows的话只有Windows 7和Windows Server 2008 R2完全支持（Vista只支持IKEv1），因而这篇文章主要介绍如何建立Win7客户端能够使用的IKEv2 VPN。</p>\n<p>之所以使用IKEv2而非IKEv1是因为IKEv1目前没有开源的能与Radius连接的插件/客户端，最接近的方案应该是XAuth- PAM+pam_radius。不过pam对于DoS攻击的抵抗很弱，因而不是特别好的一个solution。加上Openswan默认编译是不包含 xauthpam的，在使用二进制包管理的服务器上布置的复杂度会更高。</p>\n<p>IKEv2要求服务器必须以证书证明身份，即使客户端采用MSCHAPv2认证（用户名+密码）。所以第一步是产生服务器使用的证书：<br />\n以下内容来自<a rel=\"nofollow\" title=\"http://wiki.strongswan.org/projects/strongswan/wiki/IOS_%28Apple%29\" target=\"_blank\" href=\"http://wiki.strongswan.org/projects/strongswan/wiki/IOS_%28Apple%29\">http://wiki.strongswan.org/projects/strongswan/wiki/IOS_%28Apple%29</a>：</p>\n<div>\n<div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>1</code></td>\n<td><code>ipsec pki --gen --outform pem > caKey.pem</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>2</code></td>\n<td><code>ipsec pki --self --</code><code>in</code> <code>caKey.pem --dn </code><code>\"C=CH, O=strongSwan, CN=strongSwan CA\"</code> <code>--ca --outform pem > caCert.pem</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n</div>\n<p>这一步产生CA证书，也是稍后会安装到客户端里面的证书，其中CN（Common Name）的值很重要，必须是服务器的域名/IP地址并且跟给客户的值一样。比如说让客户连接1.2.3.4，那么CN=1.2.3.4。不能是一边是域名而另外一边是IP地址。</p>\n<div>\n<div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>1</code></td>\n<td><code>ipsec pki --gen --outform pem > serverKey.pem</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>2</code></td>\n<td><code>ipsec pki --pub --</code><code>in</code> <code>serverKey.pem | ipsec pki --issue --cacert caCert.pem --cakey caKey.pem </code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>3</code></td>\n<td><code>          </code><code>--dn </code><code>\"C=CH, O=strongSwan, CN=vpn.strongswan.org\"</code> <code>--flag serverAuth --outform pem > serverCert.pem</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n</div>\n<p>这一步里面产生的服务器证书的CN值必须和上一步里面的一样，至于–flag serverAuth是Windows客户端必需的，作用是表示出这个证书的用途（认证）。</p>\n<p>把生成的证书拷到ipsec.d/里面：</p>\n<div>\n<div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>1</code></td>\n<td><code>cp</code> <code>caCert.pem /etc/ipsec.d/cacerts/</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>2</code></td>\n<td><code>cp</code> <code>serverCert.pem /etc/ipsec.d/certs</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>3</code></td>\n<td><code>cp</code> <code>serverKey.pem /etc/ipsec.d/private/</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n</div>\n<p>最后在/etc/ipsec.secrets里面添加：</p>\n<div>\n<div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>1</code></td>\n<td><code>: RSA serverKey.pem</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n</div>\n<p>这样服务器端的证书准备工作就完成了。</p>\n<p>客户端需要添加这个证书，否则认证时会出现Error 13801。添加证书的方法见这里：<a rel=\"nofollow\" target=\"_blank\" href=\"http://wiki.strongswan.org/projects/strongswan/wiki/Win7EapCert\">http://wiki.strongswan.org/projects/strongswan/wiki/Win7EapCert</a>，注意必须是Local Computer（本地计算机）而非Current User（当前用户），否则添加的证书不会起效。</p>\n<p>然后配置/etc/strongswan.conf：</p>\n<p>在charon段里面加上：</p>\n<div>\n<div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>1</code></td>\n<td><code>dns1 = 8.8.8.8</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>2</code></td>\n<td><code>dns2 = 208.67.222.222</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n</div>\n<p>然后在plugin段（charon段内部）里面加上：</p>\n<div>\n<div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>1</code></td>\n<td><code>eap-radius </code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>2</code></td>\n<td><code>                    </code><code>servers </code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>3</code></td>\n<td><code>                                 </code><code>vpnserver </code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>4</code></td>\n<td><code>                                                    </code><code>secret = yourfreeradiussecret</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>5</code></td>\n<td><code>                                                    </code><code>address = radius.server.address</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>6</code></td>\n<td><code>                                  </code><code></code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>7</code></td>\n<td><code>                      </code><code>}</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>8</code></td>\n<td><code>}</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n</div>\n<p>这样让Strongswan了解Radius服务器地址和暗码。</p>\n<p>接下来修改/etc/ipsec.conf：</p>\n<div>\n<div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>1</code></td>\n<td><code>conn IPSec-IKEv2</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>2</code></td>\n<td><code>           </code><code>keyexchange=ikev2</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>3</code></td>\n<td><code>           </code><code>auto=add</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>4</code></td>\n<td><code>           </code><code>left=server.ip.address</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>5</code></td>\n<td><code>           </code><code>leftsubnet=0.0.0.0/0</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>6</code></td>\n<td><code>           </code><code>leftauth=pubkey</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>7</code></td>\n<td><code>           </code><code>leftcert=serverCert.pem</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>8</code></td>\n<td><code>           </code><code>right=%any</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>9</code></td>\n<td><code>           </code><code>rightsourceip=vpn.ip.address.range</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>10</code></td>\n<td><code>           </code><code>rightauth=eap-radius</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>11</code></td>\n<td><code>           </code><code>rightsendcert=never</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>12</code></td>\n<td><code>           </code><code>eap_identity=%any</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n</div>\n<p>解释下上面几项的含义：leftsubnet是决定要通过tunnel的ip的范围，0.0.0.0/0是代表所有的IP通讯都通过VPN。 rightsourceip是VPN分配的虚拟地址的范围，也就是客户端登录后得到的IP范围，例如192.168.1.0/24意味着 192.168.0.1-192.168.1.255为VPN客户端可能的地址范围。rightauth=eap-radius是把客户端的EAP认证请 求转发至radius来处理，%any意味着接受任何类型的eap请求。</p>\n<p>配置完成了吗？这样启动后Windows的客户端会提示812错误，因为Windows默认使用的是EAP-MSCHAPv2，而 Freeradius的默认配置是EAP-md5，这可能是Windows的一个bug，目前我的解决方法是直接把Freeradius的 eap.conf里面的default_eap_type修改为mschapv2，如有更好的方法望不吝告知。</p>\n<p>这样就建立了一个IKEv2 IPSec隧道。默认情况下加密方法使用3DES，如有需要的话可以在IPSec的配置段里面加上ike=和esp=来修改加密算法。</p>\n<p>参考：</p>\n<p><a rel=\"nofollow\" target=\"_blank\" href=\"http://wiki.strongswan.org/projects/strongswan/wiki/Win7EapCert\">http://wiki.strongswan.org/projects/strongswan/wiki/Win7EapCert</a></p>\n<p><a rel=\"nofollow\" target=\"_blank\" href=\"http://wiki.strongswan.org/projects/strongswan/wiki/IOS_%28Apple%29\">http://wiki.strongswan.org/projects/strongswan/wiki/IOS_%28Apple%29</a></p>\n<p><a rel=\"nofollow\" target=\"_blank\" href=\"http://wiki.strongswan.org/projects/strongswan/wiki/Win7EapMultipleConfig\">http://wiki.strongswan.org/projects/strongswan/wiki/Win7EapMultipleConfig</a></p>\n<p>还有Strongswan的Mailing list。</p>\n<p><strong>原文</strong>：<a rel=\"nofollow\" target=\"_blank\" href=\"http://tomem.info/blog/2011/10/724\">http://tomem.info/blog/2011/10/724</a></p>\n<p>===========</p>\n<p><strong>Strongswan+L2TP配置</strong></p>\n<div>\n<p>由于需要给VPN添加IKEv2，而OpenSwan对于IKEv2的支持只有最基本的部分，更重要的是OpenSwan没有像 Strongswan一样的EAP-RADIUS插件可以实现Stongswan和Freeradius之间的直接通信（IKEv2必须），所以将服务器 上面的OpenSwan换成了Strongswan。</p>\n<p>平台是Debian Squeeze，Strongswan的软件包安装自Debian Squeeze Backports，其余的来自于Debian stable。Debian Backports的作用是给稳定版本的Debian提供一些只有在Tesing/sid里面才有的新版本的软件包，而这些软件又是在stable的环境 下编译的，所以不用担心包依赖方面的问题。</p>\n<p>从Backports安装软件的方法参照这里：<a rel=\"nofollow\" target=\"_blank\" href=\"http://backports-master.debian.org/Instructions/\">http://backports-master.debian.org/Instructions/</a></p>\n<p>Strongswan需要使用新版本的原因是Stable（Squeeze）里面的版本编译时没有–enable-nat-transport参数，这样的话Strongswan由于默认的安全特性（<a rel=\"nofollow\" target=\"_blank\" href=\"http://wiki.strongswan.org/projects/strongswan/wiki/FAQ\">http://wiki.strongswan.org/projects/strongswan/wiki/FAQ</a>）不允许进行NAT转发，从而无公网IP的客户端是无法与服务器建立连接的。</p>\n<p>服务器结构依然是xl2tpd+swan，只是把OpenSwan换成了Strongswan。xl2tpd的配置跟上一篇 （http://tomem.info/blog/2011/04/577）是一样的，但是Strongswan的配置稍有不同，而错误信息又不是很 informative，花了几个小时才调试成功，所以写下来为后面的作参考。</p>\n<p>几个常见的错误：</p>\n<p>1.</p>\n<p>client.ip.address:4500 #8: NAT-Traversal: Transport mode disabled due to security concerns<br />\npluto[21315]: “l2tp”[3] client.ip.address:4500 #8: sending encrypted notification BAD_PROPOSAL_SYNTAX to client.ip.address:4500</p>\n<p>这个是由于Strongswan没有编译–enable-nat-transport，因而无法进行NAT传输。</p>\n<p>解决方法：重新编译，加上–enable-nat-transport。</p>\n<p>2.</p>\n<p>pluto[30735]: packet from client.ip.address:500: initial Main Mode message received on server.ip.address:500 but no connection has been authorized with policy=PSK</p>\n<p>这个一般来说是IPSec的secrets错误，但是我在确认Secrets无误的情况下也遇到了这个，<a rel=\"nofollow\" target=\"_blank\" href=\"http://b.gkp.cc/2010/06/19/setup-ipsec-l2tp-on-centos-55/\">http://b.gkp.cc/2010/06/19/setup-ipsec-l2tp-on-centos-55/</a>评论里面的某位仁兄也遇到了这个问题。在几番折腾无果的情况下注意到log里面有这么一行：</p>\n<p>pluto[8384]: packet from client.ip.address:500: ignoring Vendor ID payload [IKE CGA version 1]</p>\n<p>突然意识到Windows的L2TP使用的是IKEv1，而Strongswan默认使用的是IKEv2，会不会是这个问题？试之果然。</p>\n<p>解决：在Strongswan的L2TP的配置段里面加上keyexchange=ikev1。</p>\n<p>3.</p>\n<p>pluto[1243]: “L2TP-PSK-noNAT”[2] client.ip.address:4500 #1: cannot respond to IPsec SA request because no connection is known for server.ip.address:4500[server.ip.address]:17/1701…client.ip.address:4500[client.ip.nat.address]:17/%any===client.ip.nat.address/32<br />\npluto[1243]: “L2TP-PSK-noNAT”[2] client.ip.address:4500 #1: sending encrypted notification INVALID_ID_INFORMATION to client.ip.address:4500</p>\n<p>这个乍看之下也像是PSK的设置错误，实际上不是。问题出在virtual_network的设置上面。</p>\n<p>解决：Strongswan的setup段里面加上virtual_private=%v4:10.0.0.0/8,%v4:192.168.0.0/16,%v4:172.16.0.0/12。</p>\n<p>配置文件范例：</p>\n<p> </p>\n<div>\n<div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>1</code></td>\n<td><code># ipsec.conf - strongSwan IPsec configuration file</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>2</code></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>3</code></td>\n<td><code># basic configuration</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>4</code></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>5</code></td>\n<td><code>config setup</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>6</code></td>\n<td><code>        </code><code># plutodebug=all</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>7</code></td>\n<td><code>        </code><code># crlcheckinterval=600</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>8</code></td>\n<td><code>        </code><code># strictcrlpolicy=yes</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>9</code></td>\n<td><code>        </code><code># cachecrls=yes</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>10</code></td>\n<td><code>        </code><code>nat_traversal=</code><code>yes</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>11</code></td>\n<td><code>        </code><code>charonstart=</code><code>yes</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>12</code></td>\n<td><code>        </code><code>plutostart=</code><code>yes</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>13</code></td>\n<td><code>        </code><code>virtual_private=%v4:10.0.0.0/8,%v4:192.168.0.0/16,%v4:172.16.0.0/12</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>14</code></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>15</code></td>\n<td><code># Add connections here.</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>16</code></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>17</code></td>\n<td><code>conn L2TP-PSK-NAT</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>18</code></td>\n<td><code>        </code><code>rightsubnet=vhost:%priv</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>19</code></td>\n<td><code>        </code><code>also=L2TP-PSK-noNAT</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>20</code></td>\n<td></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>21</code></td>\n<td><code>conn L2TP-PSK-noNAT</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>22</code></td>\n<td><code>        </code><code>keyexchange=ikev1</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>23</code></td>\n<td><code>        </code><code>authby=secret</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>24</code></td>\n<td><code>        </code><code>pfs=no</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>25</code></td>\n<td><code>        </code><code>auto=add</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>26</code></td>\n<td><code>        </code><code>rekey=no</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>27</code></td>\n<td><code>        </code><code>type</code><code>=tunnel</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>28</code></td>\n<td><code>        </code><code>keyingtries=3</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>29</code></td>\n<td><code>        </code><code>left=server.ip.address</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>30</code></td>\n<td><code>        </code><code>leftnexthop=%defaultroute</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>31</code></td>\n<td><code>        </code><code>leftprotoport=17/1701</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>32</code></td>\n<td><code>        </code><code>right=%any</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n<div>\n<table>\n<tbody>\n<tr>\n<td><code>33</code></td>\n<td><code>        </code><code>rightprotoport=17/%any</code></td>\n</tr>\n</tbody>\n</table>\n</div>\n</div>\n</div>\n<p><strong>原文</strong>：<a rel=\"nofollow\" target=\"_blank\" href=\"http://tomem.info/blog/2011/10/721\">http://tomem.info/blog/2011/10/721</a></p>\n</div>\n</div>\n</div>\n</div>\n</div>\n<p><img src=\"http://tomem.info/blog/wp-includes/images/smilies/icon_eek.gif\" /></p>\n<p><small>本文由自动聚合程序取自网络，内容和观点不代表数字时代立场</small></p>\n<form method=\"POST\" action=\"http://www.feedblitz.com/f/f.fbz?AddNewUserDirect\">\n定期获得翻墙信息？<a href=\"http://www.feedblitz.com/f/?Sub=738338\">请电邮订阅数字时代</a> <br /><input name=\"EMAIL\" maxlength=\"64\" type=\"text\" size=\"25\" value=\"\"><br />\n<input name=\"FEEDID\" type=\"hidden\" value=\"738338\"><br />\n<input name=\"PUBLISHER\" type=\"hidden\" value=\"7485568\"><br />\n<input type=\"submit\" value=\"订阅!\"><br />\n</form>\n","author":983,"categories":[15300],"tags":[7775,8510,8795,8817]}