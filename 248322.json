{"id":248322,"link":"https://chinadigitaltimes.net/chinese/2012/08/翻墙-gfw封锁网络的途径分析/","date":"2012-08-22T15:30:18Z","modified":"2012-08-22T15:30:18Z","title":"翻墙 | GFW封锁网络的途径分析","content":"<p><span>注：这是一篇旧文章，原文作者Twitter：@davidsky2012，题目为&#8221;如何区分国内上网环境中不同的人为网络故障&#8221;。美博园转载时根据内容将标题改为：GFW封锁网络的几种常用方法。相关内容文章还可参考：维基百科之&#8221;长城防火墙&#8221;（GFW）。分析的很详细保存下来作资料参考。原文如下：</span></p>\n<p><span>众所周知，在国内上网会遇到各种各样不同的人为网络故障，使得我们无法正常访问很多网站。但由于很多人并不熟悉网络，很多时候会无法区分不同的网络故障，导致明明是网络故障，却认为是服务器故障；或明明是服务器故障，却认为是网络故障的情况。我觉得有必要说明一下不同网络故障的特征，以及区分它们并解决它们的方法。</span></p>\n<p><span>在国内上网环境中，我们经常遇到的网络故障有：DNS劫持、DNS污染、IP封锁、服务器防火墙IP过滤、服务器宕机、基于关键词的TCP连接重置、无状态的TCP连接重置、SSL证书过滤、SSL劫持、HTTP会话劫持等网络故障。下面我就依次进行说明：</span></p>\n<p><b>1、DNS劫持</b></p>\n<p><span>DNS劫持会导致我们访问了一些不存在的或不稳定的网站的时候，访问到的却是电信114搜索（详见月光博客《断网后互联星空的浏览器劫持》）或访问Google却显示了Baidu的主页（详见月光博客《Google博客搜索摇身一变成百度》）。</span></p>\n<p><span>如果需要确认自己是否处在DNS劫持的环境中，我们可以在Windows命令行cmd中使用Windows自带的网络诊断工具nslookup查找一个不存在或不稳定的域名进行一下网络诊断：</span></p>\n<p><span>C:>nslookup <a rel=\"nofollow\" target=\"_blank\" href=\"http://www.somerandomdomainname.com\">www.SomeRandomDomainName.com</a></span></p>\n<p><span>Server: <a rel=\"nofollow\" target=\"_blank\" href=\"http://ns-pd.online.sh.cn\">ns-pd.online.sh.cn</a></span></p>\n<p><span>Address: 202.96.209.133</span></p>\n<p><span>Non-authoritative answer:</span></p>\n<p><span>Name: <a rel=\"nofollow\" target=\"_blank\" href=\"http://www.somerandomdomainname.com\">www.SomeRandomDomainName.com</a></span></p>\n<p><span>Address: 218.83.175.155</span></p>\n<p><span>我们看到，<a rel=\"nofollow\" target=\"_blank\" href=\"http://www.somerandomdomainname.com\">www.SomeRandomDomainName.com</a>本应该是一个不存在的域名，DNS服务器应该告诉我们这个域名不存在，但我们却看到DNS服务器告诉我们这个域名的IP为218.83.175.155（不同地区的114搜索的IP都不同，可能得到的IP并不是218.83.175.155，而是自己所在地区的114搜索的服务器IP地址），而这个IP却是114搜索的IP，导致我们在浏览器中访问这个网站时看到的是114搜索的网页。</span></p>\n<p><span>如果需要解决DNS劫持的问题，可以把自己的域名解析服务器换乘国外的，比如OpenDNS（详见月光博客《使用OpenDNS解决DNS域名劫持》）或Google DNS（详见月光博客《Google推出免费DNS服务》）。</span></p>\n<p><span>解决之后我们再次使用nslookup查找一下这个网站：</span></p>\n<p><span>C:>nslookup <a rel=\"nofollow\" target=\"_blank\" href=\"http://www.somerandomdomainname.com\">www.SomeRandomDomainName.com</a></span></p>\n<p><span>Server: <a rel=\"nofollow\" target=\"_blank\" href=\"http://google-public-dns-a.google.com\">google-public-dns-a.google.com</a></span></p>\n<p><span>Address: 8.8.8.8</span></p>\n<p><span>*** <a rel=\"nofollow\" target=\"_blank\" href=\"http://google-public-dns-a.google.com\">google-public-dns-a.google.com</a> can&#39;t find <a rel=\"nofollow\" target=\"_blank\" href=\"http://www.somerandomdomainname.com\">www.SomeRandomDomainName.com</a>: Non-existent domain</span></p>\n<p><span>我们看到DNS服务器正确的告诉了我们这个域名不存在，我们不会被劫持到114搜索了。</span></p>\n<p><span>不过，正如《使用OpenDNS解决DNS域名劫持》中最后一段所说的那样，&#8221;但是对于DNS污染的劫持，使用OpenDNS也无法解决问题&#8221;。那么接下来，我就介绍一下DNS污染。</span></p>\n<p><b>2、DNS污染</b></p>\n<p><span>由于DNS劫持可以通过把域名解析服务器更换为国外的来解决问题，所以系统需要使用DNS污染来封锁一些域名。这样，即使使用国外的域名服务器也得不到服务器的正确IP，所以也就无法访问这些服务器了。比如现在著名的微博客始祖twitter主页就遭到了DNS污染。</span></p>\n<p><span>如果需要确认域名遭到了DNS污染而不是其他的故障，首先要了解，DNS劫持是由国内的域名服务器完成的，所以我们把域名服务器换成国外的就可以解决问题；而DNS污染是由系统完成的，所以即使更换了域名服务器，系统仍旧可以发送伪造的域名解析结果替换正确的解析结果。所以我们可以通过使用一个不存在的国外IP作为我们的域名服务器进行诊断究竟是DNS劫持还是DNS污染。我们仍旧通过使用nslookup进行网络诊断，选一个不存在的国外IP为144.223.234.234：</span></p>\n<p><span>C:>nslookup <a rel=\"nofollow\" target=\"_blank\" href=\"http://twitter.com\">twitter.com</a> 144.223.234.234</span></p>\n<p><span>DNS request timed out.</span></p>\n<p><span>timeout was 2 seconds.</span></p>\n<p><span>*** Can&#39;t find server name for address <a rel=\"nofollow\" target=\"_blank\" href=\"http://144.223.234.234\">144.223.234.234</a>: Timed out</span></p>\n<p><span>Server: UnKnown</span></p>\n<p><span>Address: 144.223.234.234</span></p>\n<p><span>Name: <a rel=\"nofollow\" target=\"_blank\" href=\"http://twitter.com\">twitter.com</a></span></p>\n<p><span>Address: 93.46.8.89</span></p>\n<p><span>我们看到，由于144.223.234.234不存在，理应没有任何返回。但我们却得到了一个错误的IP：93.46.8.89。我们再测试一下刚才被DNS劫持的IP的情况：</span></p>\n<p><span>C:>nslookup <a rel=\"nofollow\" target=\"_blank\" href=\"http://www.somerandomdomainname.com\">www.SomeRandomDomainName.com</a> 144.223.234.234</span></p>\n<p><span>DNS request timed out.</span></p>\n<p><span>timeout was 2 seconds.</span></p>\n<p><span>*** Can&#39;t find server name for address <a rel=\"nofollow\" target=\"_blank\" href=\"http://144.223.234.234\">144.223.234.234</a>: Timed out</span></p>\n<p><span>Server: UnKnown</span></p>\n<p><span>Address: 144.223.234.234</span></p>\n<p><span>DNS request timed out.</span></p>\n<p><span>timeout was 2 seconds.</span></p>\n<p><span>DNS request timed out.</span></p>\n<p><span>timeout was 2 seconds.</span></p>\n<p><span>*** Request to UnKnown timed-out</span></p>\n<p><span>我们看到，<a rel=\"nofollow\" target=\"_blank\" href=\"http://www.somerandomdomainname.com\">www.SomeRandomDomainName.com</a> 没有返回结果，那么它没有被DNS污染。</span></p>\n<p><span>如果要解决DNS污染，我们只能使用各种加密代理进行远程DNS解析、VPN或利用系统的漏洞了。</span><br />  <b><br /></b><br /><b>　　3、IP封锁</b></p>\n<p><span>这里IP封锁指的是国内把国外服务器的IP加入了系统的黑名单，导致大部分地区甚至全国无法直接访问服务器。由于系统是分布式的，所以有可能出现部分地区可以访问，部分地区不能访问的情况。比如现在知名的云存储服务Dropbox的主页，就是遭到了IP封锁。</span></p>\n<p><span>首先我们把域名服务器设置为国外的，排除了DNS劫持的问题。之后我们诊断一下dropbox的域名是否遭到了DNS污染：</span></p>\n<p><span>C:>nslookup <a rel=\"nofollow\" target=\"_blank\" href=\"http://www.dropbox.com\">www.dropbox.com</a> 144.223.234.234</span></p>\n<p><span>DNS request timed out.</span></p>\n<p><span>timeout was 2 seconds.</span></p>\n<p><span>*** Can&#39;t find server name for address <a rel=\"nofollow\" target=\"_blank\" href=\"http://144.223.234.234\">144.223.234.234</a>: Timed out</span></p>\n<p><span>Server: UnKnown</span></p>\n<p><span>Address: 144.223.234.234</span></p>\n<p><span>DNS request timed out.</span></p>\n<p><span>timeout was 2 seconds.</span></p>\n<p><span>DNS request timed out.</span></p>\n<p><span>timeout was 2 seconds.</span></p>\n<p><span>*** Request to UnKnown timed-out</span></p>\n<p><span>显然也没有遭到DNS污染。那么接下去我们可以在没有过滤ICMP协议的网络环境中（有些小区宽带和有些公司的内部网络过滤了ICMP协议，无法使用tracert），我们可以在Windows命令行cmd中使用Windows自带的网络诊断工具tracert进行一下网络诊断是网站遭到了IP封锁还是其他的故障：</span></p>\n<p><span>C:>tracert -d <a rel=\"nofollow\" target=\"_blank\" href=\"http://www.dropbox.com\">www.dropbox.com</a></span></p>\n<p><span>Tracing route to <a rel=\"nofollow\" target=\"_blank\" href=\"http://www.dropbox.com\">www.dropbox.com</a> [174.36.30.70]</span></p>\n<p><span>over a maximum of 30 hops:</span></p>\n<p><span>1 18 ms 19 ms 26 ms 58.35.240.1</span></p>\n<p><span>2 15 ms 20 ms 29 ms 58.35.240.1</span></p>\n<p><span>3 13 ms 10 ms 14 ms 124.74.20.45</span></p>\n<p><span>4 14 ms 14 ms 15 ms 124.74.209.137</span></p>\n<p><span>5 10 ms 15 ms 14 ms 61.152.86.58</span></p>\n<p><span>6 * * * Request timed out.</span></p>\n<p><span>7 * * * Request timed out.</span></p>\n<p><span>8 * * * Request timed out.</span></p>\n<p><span>……</span></p>\n<p><span>我们看到，最后一个IP为61.152.86.58（不同地区的IP不一样），之后就不通了，显然在61.152.86.58附近遭到了IP封锁。那么我们打开ip138查一下61.152.86.58是谁在掌控：</span></p>\n<p><span>您查询的IP:61.152.86.58</span></p>\n<p><span>* 本站主数据：上海市 电信</span></p>\n<p><span>* 参考数据一：上海市 电信</span></p>\n<p><span>* 参考数据二：上海市 电信</span></p>\n<p><span>显然，问题在上海电信这里（其他地区可能是地区的本地电信），而不是dropbox服务器的问题。</span></p>\n<p><b>4、服务器防火墙IP过滤和服务器宕机</b></p>\n<p><span>把这两点放在一起写是因为这两种情况的对外表现是一样的。但和IP封锁却有很大区别。IP封锁的最后一个可达IP是中国的，而服务器防火墙IP过滤和服务器当机时的最后一个可达IP却是国外的。比如我们拿75.101.142.137做试验，之前在上面部署过alexa的网站，现在这个IP上暂时没有服务器（可以看成服务器宕机）：</span></p>\n<p><span>C:>tracert -d 75.101.142.237</span></p>\n<p><span>Tracing route to 75.101.142.237 over a maximum of 30 hops</span></p>\n<p><span>1 25 ms 18 ms 18 ms 58.35.240.1</span></p>\n<p><span>2 25 ms 42 ms 27 ms 58.35.240.1</span></p>\n<p><span>3 10 ms 15 ms 14 ms 124.74.37.9</span></p>\n<p><span>4 49 ms 59 ms 12 ms 124.74.209.129</span></p>\n<p><span>5 14 ms 14 ms 14 ms 61.152.86.142</span></p>\n<p><span>6 10 ms 14 ms 15 ms 202.97.35.154</span></p>\n<p><span>7 14 ms 15 ms 14 ms 202.97.34.126</span></p>\n<p><span>8 194 ms 195 ms 194 ms 202.97.51.138</span></p>\n<p><span>9 171 ms 170 ms 173 ms 202.97.50.54</span></p>\n<p><span>10 215 ms 179 ms 175 ms 63.146.27.133</span></p>\n<p><span>11 279 ms 280 ms 278 ms 67.14.36.6</span></p>\n<p><span>12 * * * Request timed out.</span></p>\n<p><span>13 249 ms 249 ms 244 ms 72.21.199.40</span></p>\n<p><span>14 254 ms 254 ms 254 ms 72.21.222.157</span></p>\n<p><span>15 250 ms 250 ms 249 ms 216.182.232.53</span></p>\n<p><span>16 270 ms 270 ms 273 ms 216.182.224.22</span></p>\n<p><span>17 272 ms 269 ms 289 ms 75.101.160.35</span></p>\n<p><span>18 * * * Request timed out.</span></p>\n<p><span>19 * * * Request timed out.</span></p>\n<p><span>20 * * * Request timed out.</span></p>\n<p><span>我们看到最后一个可达IP为75.101.160.35，然后我们查一下这个IP是谁的呢：</span></p>\n<p><span>您查询的IP:75.101.160.35</span></p>\n<p><span>* 本站主数据：美国</span></p>\n<p><span>* 参考数据一：美国</span></p>\n<p><span>* 参考数据二：美国 华盛顿州金县西雅图市亚马逊公司</span></p>\n<p><span>显然，这个是服务器故障。</span></p>\n<p><span>如果要解决IP封锁，我们只能通过加密代理、VPN或利用系统的漏洞进行访问这些网站了。</span></p>\n<p><b>5、基于关键词的TCP连接重置</b></p>\n<p><span>国内的系统在人们通过http协议访问国外网站时会记录所有的内容，一旦出现某些比较&#8221;敏感&#8221;的关键词时，就会强制断开TCP连接，记录双方IP并保留一段时间 （1分钟左右），我们的浏览器也就会显示&#8221;连接被重置&#8221;。之后在这一段时间内（1分钟左右），由于我们和服务器的IP被摄查系统记录，我们就无法再次访问这个网站了。我们必须停止访问这个网站，过了这段时间再次访问没有这些关键词的网页，就又能访问这个网站了。</span></p>\n<p><span>由于这些特征，我们判断是否遭到了基于关键词的TCP连接重置的情况也比较容易。如果浏览器显示&#8221;连接被重置&#8221;，并且在一段时间内无法再次访问这个网站，之后过了这段时间访问这个网站上没有这些关键词的网页又能访问的时候，我们就是遭到了基于关键词的TCP连接重置的故障。</span></p>\n<p><span>正是因为http协议是明文传输的，所以才能基于关键词进行TCP连接重置。所以如果网站支持https加密访问，我们可以通过https方式访问网站，从而解决这个问题。但如果网站不支持https方式访问，我们只能通过加密代理、VPN或利用系统的漏洞进行访问了。而且国内的系统对付https也不是没有其他手段了。除了IP封锁外，还有无状态的TCP连接重置、SSL证书过滤、SSL劫持等手段，下面进行依次介绍。</span></p>\n<p><b>　6、无状态的TCP连接重置</b></p>\n<p><span>由于https是加密传输数据的协议，系统无法知道通过https协议传输了什么内容，但又不允许民众使用https访问&#8221;有害信息&#8221;，所以系统只要监测到（系统只是知道访问了这个网站的https协议，并不知道其中传输的内容）访问了指定网站的https协议（比如Google Docs的https访问方式），就会强制断开TCP连接。这样，这些网站的https协议在国内就无法直接使用了，很多人被迫使用http协议，从而传输的所有内容被系统所记录。</span></p>\n<p><span>无状态的TCP连接重置的结果也是浏览器显示&#8221;连接被重置&#8221;，只不过无论访问这个服务器上的任何网页都会被重置。如果要解决这个问题，也只能依靠加密代理、VPN或利用系统的漏洞了。</span></p>\n<p><b>7、SSL证书过滤</b></p>\n<p><span>和无状态的TCP连接重置一样，由于https是加密传输数据的协议，系统无法知道通过https协议传输了什么内容，但又不允许民众使用https访问&#8221;有害信息&#8221;，除了域名污染和无状态的TCP连接重置防止无法审查内容外，还有SSL证书过滤的审查手段。由于https传输过程中，SSL证书却是明文传输的，所以可以监测SSL证书是否掰发给指定域名的。如果确实如此，那么就强制断开TCP连接，浏览器也会显示&#8221;连接被重置&#8221;。SSL证书过滤只发生在使用https访问网站的时候。</span></p>\n<p><span>SSL证书过滤的情况比较少。如果需要解决这个问题，也只能依靠加密代理、VPN或利用系统的漏洞了。</span></p>\n<p><b>　8、SSL劫持</b></p>\n<p><span>断开https连接虽然能阻止民众访问&#8221;有害信息&#8221;，但并不知道访问了什么有害信息。基于这一点，针对https的弱点（信任所有证书颁发机构CA），CNNIC申请成为了顶级证书颁发机构（Root CA），从而可以发假证书进行中间人攻击，从而破解https传输的内容。详见月光博客《破解Google Gmail的https新思路》。</span></p>\n<p><span>如果遭到了SSL劫持，很难发现。我们通过https访问国外网站的时候必须每次检查一下证书是否为国内的证书颁发机构颁发。如果为国内的证书颁发机构颁发，那么很可能遭到了SSL劫持，必须马上停止继续访问。</span></p>\n<p><span>如果要解决SSL劫持，我们可以去浏览器中禁止比如CNNIC那样的国内证书颁发机构的证书（比如《CNNIC，我不信任你》）。但这并不能完全解决问题，如果某一天一个不知名的国内证书颁发机构参与了SSL劫持就很难发现。最终我们还需要依赖加密代理或VPN。</span></p>\n<p><b>　9、HTTP会话劫持</b></p>\n<p><span>HTTP会话劫持是修改正常的http返回结果，可以在其中加入广告，甚至是病毒木马。而一般上网被http会话劫持加入广告，很有可能认为是网站自己的广告。由于http协议是明文传输的，http会话劫持也就可以做到。月光博客中《电信级的网络弹出广告》、《获取了电信恶意弹出广告的罪证》和《谁控制了我们的浏览器？》也有详细介绍http会话劫持。HTTP会话劫持通常是ISP为了推送广告而实施的，但并不排除这一手段今后会被系统所利用。</span></p>\n<p><span>要解决HTTP会话劫持，月光博客中也提供了一种解决思路��《解除ADSL弹出广告的方法》。使用浏览器插件屏蔽广告能解决部分问题，也不能完全解决问题。如果要从技术手段解决HTTP会话劫持，一种办法是使用加密代理和VPN访问所有的网站，包括国内的，但也不能完全解决问题，如果HTTP会话劫持是在服务器附近的路由器上设置的，这种方法也无法解决；另一种办法是针对不同的HTTP会话劫持，我们通过刷路由器固件的方式再劫持回来（dd-wrt和tomato路由器固件支持自定义，可能可以把HTTP会话再劫持回原来的数据），或者针对不同的HTTP会话劫持，使用不同的本地应用层代理服务器进行广告过滤。</span></p>\n<p><span>在国内常见的人为网络故障都介绍完了，同学们都可以区分不同的故障了并加以解决吗？</span>  </p>\n<div><span><br /></span></div>\n<div><span>原文：</span><a rel=\"nofollow\" target=\"_blank\" href=\"http://www.jieyujing.info/2012/03/gfw.html\">http://www.jieyujing.info/2012/03/gfw.html</a></div>\n<div>获取最新穿墙软件？请发电邮（最好用gmail）到：cdtcaonima@gmail.com。《中国数字时代》开通IPv6，欢迎穿墙阅读。翻越防火长城，你可以到达世界上的每一个角落。（Across the Great Firewall, you can reach every corner in the world.）翻墙利器赛风3下载地址：<a rel=\"nofollow\" target=\"_blank\" href=\"http://dld.bz/caonima326\n\n\"> http://dld.bz/caonima326</p>\n<p></a>，<a rel=\"nofollow\" target=\"_blank\" href=\"http://dld.bz/caonima745\">http://dld.bz/caonima745</a><img width=\"1\" height=\"1\" src=\"https://blogger.googleusercontent.com/tracker/5500297126185736776-2435507220352856385?l=www.chinagfw.org\" alt=\"\" /></div>\n</p>\n<p><small>本文由自动聚合程序取自网络，内容和观点不代表数字时代立场</small></p>\n<p><iframe src=\"https://docs.google.com/spreadsheet/embeddedform?hl=zh-CN&#038;formkey=dGRpN3FrVThuMFFsZHBZcmNGLW94dEE6MQ\" width=\"510\" height=\"328\" frameborder=\"0\" marginheight=\"0\" marginwidth=\"0\">Loading&#8230;</iframe></p>\n<form method=\"POST\" action=\"http://chinadigitaltimes.us4.list-manage.com/subscribe/post?u=17daa75df533f6c6ff72e51ab&#038;id=b4fd4ae247\">\n定期获得翻墙信息？<a href=\"http://eepurl.com/mstlf\">请电邮订阅数字时代</a><br />\n <br /><input type=\"email\" value=\"\" name=\"EMAIL\" id=\"mce-EMAIL_in_post\" size=\"25\" style=\"display:block;\" placeholder=\"请输入您的邮件地址\" required><br />\n\t<input type=\"submit\" value=\"点击订阅\" name=\"subscribe\" style=\"height: 20px;\" id=\"in_post_subscribe\"><br />\n</form>\n","author":1005,"categories":[18269,15300],"tags":[7775,8795]}