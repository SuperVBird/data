{"id":187866,"link":"https://chinadigitaltimes.net/chinese/2011/10/网络科技-tuning-linode-vps－小规模低性能低流量网站优化实践/","date":"2011-10-11T15:00:30Z","modified":"2011-10-11T15:00:30Z","title":"网络科技 | Tuning Linode VPS－小规模低性能低流量网站优化实践","content":"<p><p>by <a rel=\"nofollow\" target=\"_blank\" href=\"http://www.dbanotes.net\">Fenng</a>@<a rel=\"nofollow\" target=\"_blank\" href=\"http://www.dbanotes.net/\">dbanotes.net</a> </p>\n<p>偶然看到以前写过的这篇帖子 <a rel=\"nofollow\" target=\"_blank\" href=\"http://www.dbanotes.net/arch/small_site_arch.html\">『小规模低性能低流量网站设计原则』</a>，重新发到微博上引起了一点反响，觉得有必要以 <a rel=\"nofollow\" target=\"_blank\" href=\"http://www.linode.com/?r=92405a6e282a712f7a1270e98d16eba13efb1b68\">Linode</a> VPS 为例再做个简单的优化实践说明，免得总有人问我，也顺便赚点点击量 :) </p>\n<p>假定现在你已经有了一个基本的 VPS 可用，基本内存 512MB 。参考官方提供的各种<a rel=\"nofollow\" target=\"_blank\" href=\"http://library.linode.com/\">安装指导</a>将 LAMP 这个组合运行了起来，操作系统一般 Ubuntu ，Web 服务器 Apache ，数据库 MySQL ，然后是 PHP ，以及需要安装的应用软件，WordPress 、Drupal 或是 OpenCart 什么的，一步一步配置好，能够正常的浏览页面。按照官方指导文档操作的一个好处是会包括一些基本的优化一点的配置。不至于出现太大的错误。</p>\n<p>一旦应用就绪后，登录到操作系统中，通过 top / iostat / free 等基本操作系统命令收集基准数据，做记录。</p>\n<p><strong>1.内存相关的调整</strong></p>\n<p>内部测试或是较小范围使用，可能这样也不会遇到太大问题。一旦访问人数多了一点，机器响应可能就有点慢了。对于 VPS ，第一步着手调整的就是各个组件对内存的使用。因为内存受限，对内存的使用一定要精打细算一点。</p>\n<p>一般来说，对于 LAMP 环境，以下几个地方要注意：</p>\n<p><strong>PHP 程序的内存相关的调整</strong></p>\n<p>PHP5 配置文件 php.ini 中 memory_limit 定义的值默认情况是16MB，该参数定义单个 PHP 脚本消耗最大的内存大小(大意)。如果程序某个页面需要的内存超过这个限制，访问者最可能遇到一个 HTTP 500 错误，查看 Web 服务器错误日志也可以看到。多数情况下，这个值需要做相应调整。比如设置为32MB，是否合适，需要做观察。有一个经验方法是观察 top 命令的输出，看相应进程的 SHR 字段的值，实际上总是尽量大一点点。但不能过大，一旦有个别程序写的不好调用的时候占用过多资源，会导致 VPS 挂掉。</p>\n<p>经常有人问，这个服务器跑某某 Web 应用，能支持多少并发? 一个大致的思路是估算单个进程占用的内存，看系统能分配多少内存给应用程序，并发的量大致可以估算得到。但实际上，这个提问基本没多大价值。</p>\n<p>另外，还有一个比较重要的参数需要修改 output_buffering 需要修改为 On 或是具体数值(eg, 4096)。修改配置后，检查是否生效(如何检查?)。另外，记住error_log的位置，随时查看。</p>\n<p><strong>MySQL 数据库内存占用 </strong></p>\n<p>如果不确定 MySQL 内存使用情况，可以利用 <a rel=\"nofollow\" target=\"_blank\" href=\"http://hackmysql.com/mysqlreport\">MySQLReport</a> 这个工具收集一下 MySQL 实例的信息报告，不同时间段多收集几次作为对比。然后相应的调整 key_buffer/query_cache_size 等参数的大小, 一次调整一个参数，重启动 MySQL ，继续抽取报告，分析数据，然后调整下一个参数。既然需要编辑配置文件 my.cnf , 建议顺手加大一点 max_connections 这个参数(为什么?)。</p>\n<p>多数内存问题都是由数据库 I/O 引起，导致 I/O 问题多由不合理数据库调用有关(这么说严谨么?)，解决不合理调用要么修改应用，要么通过查询缓存或是 Key-Value Cache 等办法缓解。这地方说来话长，假定 VPS 上基本不会有这么复杂的环境。</p>\n<p><strong>2. 影响 CPU 利用率的调整</strong></p>\n<p>这个主要针对 PHP 的 Opcode(Accelerator) 而言，解析、编译PHP代码是相当消耗CPU的操作。常见的要么是 <a rel=\"nofollow\" target=\"_blank\" href=\"http://pecl.php.net/package/APC\">APC</a>, 要么是 <a rel=\"nofollow\" target=\"_blank\" href=\"http://eaccelerator.net/\">eAccelerator</a> 或是 XCache，在 Ubuntu 下安装配置都相对简单，参数调整简单搜索一下就知晓了。如果是 PHP 环境，那么一定要用 Opcode 减少 CPU 的负荷(为什么?)。至于用哪一个关系倒是不大，但前提是必须要有一个。</p>\n<p>另外，张磊同学这篇 <a rel=\"nofollow\" target=\"_blank\" href=\"http://www.blogkid.net/archives/2670.html\">让进程运行在指定的CPU</a> 对于特定需求的应用，很有借鉴意义。</p>\n<p><strong>3. 网络参数控制</strong></p>\n<p>修改 /etc/sysctl.conf 文件，增加如下几行：</p>\n<pre>net.ipv4.tcp_syncookies = 1<br>net.ipv4.tcp_tw_reuse = 1<br>net.ipv4.tcp_tw_recycle = 1</pre>\n<p>然后 sudo sysctl -p 使修改生效。使用如下一行命令观察半连接数量：</p>\n<pre>$ netstat -n | awk '/^tcp/ ++S[$NF] END for(a in S) print a, S[a]'</pre>\n<p>其实一般来说，网络连接数不会成为最明显的瓶颈。但顺手调整一下也好，「不费电」。有人问，如果遇到 DDoS  怎么办？忍着。</p>\n<p><strong>4. 应用程序相关的调整</strong></p>\n<p>比较流行的开源程序，不安装第三方插件的情况下，性能多少过得去。建议如果没有必要，不要启用过多的第三方插件，尤其是一些带有统计或是「智能」显示内容之类的插件能不用就不用。</p>\n<p>这些开源程序也基本上都有面向前端优化的静态化解决方案，比如 WordPress 的 Cache 相关的插件，强烈推荐启用。有时间看看<a rel=\"nofollow\" target=\"_blank\" href=\"http://www.dbanotes.net/web-performance.html\">前端优化</a>的实践建议。</p>\n<p><img alt=\"Tuning_LAMP.jpg\" height=\"259\" src=\"http://www.dbanotes.net/Images/Tuning_LAMP.jpg\" width=\"480\" /><br />\n(图片<a rel=\"nofollow\" target=\"_blank\" href=\"http://www.linuxjournal.com/article/10842\">来源</a>)</p>\n<p>优化最重要的是找到瓶颈，对症下药。前面已经说到了内存、CPU、网络，大致提了一点 I/O 问题，基本也就够了。PHP 的 Log , MySQL 的慢查询 Log ，Apache 的 Error Log ，常过滤看一下有没有新情况。</p>\n<p>补充一点，别忘了修改 OS 的 ulimit 限制：</p>\n<p>编辑 /etc/security/limits.conf 增加如下两行(具体数值大点小点问题不大)：</p>\n<pre>* user  soft  nofile 40960<br>* user  hard  nofile 40960</pre>\n<p>编辑 /etc/pam.d/common-session ，增加如下一行：</p>\n<pre>session required pam_limits.so</pre>\n<p>编辑 /etc/profile  ，增加如下一行：</p>\n<pre>ulimit -SHn 40960</pre>\n<p>重新启动 OS 即可生效。</p>\n<p>Linode 后台提供了几个基本的统计图，基本够用。可以设置磁盘 I/O 过高的时候报警，系统会发邮件给你。注意看一下网络流量的使用。不要因为个别文件被盗链而将带宽消耗殆尽。</p>\n<p>上面提到的不少修改建议不要照葫芦画瓢，<strong>知其然，还要知其所以然</strong>。每一步的调整多阅读系统手册，尤其是涉及到具体的参数数值，一定要针对实际情况修改。对基本的配置足够掌握之后，可以根据具体情况尝试性能效率的组件，比如用 Nginx/Lighttpd 替换 Apache ，但是要记住，如果 Apache 不是瓶颈的话，用传说中性能更好的 Web 服务器来替换无疑是折腾。</p>\n<p>再次提醒不要过度优化，足够满足需求就行了。有更多的精力完全可以放在其他环节上。另外，如果基本的调整做过之后，想用最省事的办法改善性能，那么，直接向服务商购买额外的内存吧。</p>\n<p>好吧，最后我想说的是其实这个优化思路并不局限于 VPS ，这个最小实践套路对于复杂的服务器环境也是基本试用的。</p>\n<p>&#8211;EOF&#8211;\n</p>\n<hr>\n<p><strong>最近文章|Recent Articles</strong></p>\n<ul>\n<li><a rel=\"nofollow\" target=\"_blank\" href=\"http://www.dbanotes.net/startup/Zen_of_Recruitment_4_DXY.html\">丁香园技术团队是怎么招人的</a></li>\n<li><a rel=\"nofollow\" target=\"_blank\" href=\"http://www.dbanotes.net/opensource/oracle_ksplice_linux.html\">Linux Ksplice，MySQL and Oracle</a></li>\n<li><a rel=\"nofollow\" target=\"_blank\" href=\"http://www.dbanotes.net/sitelog/linode_vps_tokyo_idc.html\">Linode VPS 迁移到日本 Tokyo IDC</a></li>\n<li><a rel=\"nofollow\" target=\"_blank\" href=\"http://www.dbanotes.net/startup/Users_is_God.html\">用户是上帝</a></li>\n</ul>\n<p>本站赞助商：<a rel=\"nofollow\" target=\"_blank\" href=\"http://www.douban.com/\">豆瓣网(Douban.com)</a></p>\n<p><strong> 评论数(0)|<a rel=\"nofollow\" target=\"_blank\" href=\"http://www.dbanotes.net/techmemo/tuning_linode_vps.html#comments\" title=\"Comment on: Tuning Linode VPS－小规模低性能低流量网站优化实践\">添加评论</a></strong> | 最近作者还说了什么? Follow <a rel=\"nofollow\" target=\"_blank\" href=\"http://www.twitter.com/fenng\">Fenng@Twitter</a></p>\n<p>DBA Notes 理念: 用简约的技术取得最大的收益&#8230;</p>\n<div></div>\n<div>\n<a rel=\"nofollow\" target=\"_blank\" href=\"http://feeds.feedburner.com/~ff/webarch?a=keSNk8DQsm0:S24NFXgF8pk:yIl2AUoC8zA\"><img border=\"0\" src=\"http://feeds.feedburner.com/~ff/webarch?d=yIl2AUoC8zA\" /></a> <a rel=\"nofollow\" target=\"_blank\" href=\"http://feeds.feedburner.com/~ff/webarch?a=keSNk8DQsm0:S24NFXgF8pk:qj6IDK7rITs\"><img border=\"0\" src=\"http://feeds.feedburner.com/~ff/webarch?d=qj6IDK7rITs\" /></a> <a rel=\"nofollow\" target=\"_blank\" href=\"http://feeds.feedburner.com/~ff/webarch?a=keSNk8DQsm0:S24NFXgF8pk:F7zBnMyn0Lo\"><img border=\"0\" src=\"http://feeds.feedburner.com/~ff/webarch?i=keSNk8DQsm0:S24NFXgF8pk:F7zBnMyn0Lo\" /></a> <a rel=\"nofollow\" target=\"_blank\" href=\"http://feeds.feedburner.com/~ff/webarch?a=keSNk8DQsm0:S24NFXgF8pk:V_sGLiPBpWU\"><img border=\"0\" src=\"http://feeds.feedburner.com/~ff/webarch?i=keSNk8DQsm0:S24NFXgF8pk:V_sGLiPBpWU\" /></a> <a rel=\"nofollow\" target=\"_blank\" href=\"http://feeds.feedburner.com/~ff/webarch?a=keSNk8DQsm0:S24NFXgF8pk:mqyYa2mfVbY\"><img border=\"0\" src=\"http://feeds.feedburner.com/~ff/webarch?d=mqyYa2mfVbY\" /></a> <a rel=\"nofollow\" target=\"_blank\" href=\"http://feeds.feedburner.com/~ff/webarch?a=keSNk8DQsm0:S24NFXgF8pk:I9og5sOYxJI\"><img border=\"0\" src=\"http://feeds.feedburner.com/~ff/webarch?d=I9og5sOYxJI\" /></a> <a rel=\"nofollow\" target=\"_blank\" href=\"http://feeds.feedburner.com/~ff/webarch?a=keSNk8DQsm0:S24NFXgF8pk:bcOpcFrp8Mo\"><img border=\"0\" src=\"http://feeds.feedburner.com/~ff/webarch?d=bcOpcFrp8Mo\" /></a>\n</div>\n</p>\n<p><small>本文由自动聚合程序取自网络，内容和观点不代表数字时代立场</small></p>\n<form method=\"POST\" action=\"http://www.feedblitz.com/f/f.fbz?AddNewUserDirect\">\n定期获得翻墙信息？<a href=\"http://www.feedblitz.com/f/?Sub=750556\">请电邮订阅数字时代</a> <br /><input name=\"EMAIL\" maxlength=\"64\" type=\"text\" size=\"25\" value=\"\"><br />\n<input name=\"FEEDID\" type=\"hidden\" value=\"750556\"><br />\n<input name=\"PUBLISHER\" type=\"hidden\" value=\"7485568\"><br />\n<input type=\"submit\" value=\"订阅!\"><br />\n</form>\n","author":984,"categories":[9203],"tags":[]}