{"id":330668,"link":"https://chinadigitaltimes.net/chinese/2014/01/黄祺：2014年1月21日全国dns故障分析/","date":"2014-01-21T21:18:46Z","modified":"2014-01-21T21:18:46Z","title":"黄祺：2014年1月21日全国DNS故障分析","content":"<p>来源：<a href=\"http://www.zhihu.com/question/22572025\">知乎</a></p>\n<p>网上各种谣言纷飞啊，目睹整个过程必需来说说。</p>\n<p><a href=\"http://chinadigitaltimes.net/chinese/files/2014/01/658ef0cb5ed67ba29c277f69acdbd31e_m.jpg\"><img class=\"alignnone  wp-image-330669\" alt=\"658ef0cb5ed67ba29c277f69acdbd31e_m\" src=\"http://chinadigitaltimes.net/chinese/files/2014/01/658ef0cb5ed67ba29c277f69acdbd31e_m.jpg\" width=\"495\" height=\"1395\" srcset=\"https://chinadigitaltimes.net/chinese/files/2014/01/658ef0cb5ed67ba29c277f69acdbd31e_m.jpg 550w, https://chinadigitaltimes.net/chinese/files/2014/01/658ef0cb5ed67ba29c277f69acdbd31e_m-106x300.jpg 106w, https://chinadigitaltimes.net/chinese/files/2014/01/658ef0cb5ed67ba29c277f69acdbd31e_m-363x1024.jpg 363w\" sizes=\"(max-width: 495px) 100vw, 495px\" /></a></p>\n<p>=================================================================<br />\n上面补充了一张图给不了解DNS工作原理的读者~~</p>\n<p>15:20 接到一个CDN用户询问，只有一句话：节点挂了？我第一反应是curl测一下节点，咦连不上？再进行dig +trace，吓尿了……看图</p>\n<p><a href=\"http://chinadigitaltimes.net/chinese/files/2014/01/d2c0c26c8b00a17a01806b3f0c7b163b_m.jpg\"><img class=\"alignnone  wp-image-330674\" alt=\"d2c0c26c8b00a17a01806b3f0c7b163b_m\" src=\"http://chinadigitaltimes.net/chinese/files/2014/01/d2c0c26c8b00a17a01806b3f0c7b163b_m.jpg\" width=\"540\" height=\"352\" srcset=\"https://chinadigitaltimes.net/chinese/files/2014/01/d2c0c26c8b00a17a01806b3f0c7b163b_m.jpg 600w, https://chinadigitaltimes.net/chinese/files/2014/01/d2c0c26c8b00a17a01806b3f0c7b163b_m-300x195.jpg 300w, https://chinadigitaltimes.net/chinese/files/2014/01/d2c0c26c8b00a17a01806b3f0c7b163b_m-230x150.jpg 230w\" sizes=\"(max-width: 540px) 100vw, 540px\" /></a></p>\n<p>w(ﾟДﾟ)w这是典型的墙啊……我就回了句卧槽你被墙照顾了？仔细一想，他就一个动漫论坛，不可能有这照顾啊，顺便下面放一张被墙照顾的域名的DNS跟踪图，像这样就肯定是墙干的好事了：</p>\n<p><a href=\"http://chinadigitaltimes.net/chinese/files/2014/01/bae8fae46b839a86d1cb3ff990d3d9a4_m.jpg\"><img class=\"alignnone  wp-image-330673\" alt=\"bae8fae46b839a86d1cb3ff990d3d9a4_m\" src=\"http://chinadigitaltimes.net/chinese/files/2014/01/bae8fae46b839a86d1cb3ff990d3d9a4_m.jpg\" width=\"540\" height=\"352\" srcset=\"https://chinadigitaltimes.net/chinese/files/2014/01/bae8fae46b839a86d1cb3ff990d3d9a4_m.jpg 600w, https://chinadigitaltimes.net/chinese/files/2014/01/bae8fae46b839a86d1cb3ff990d3d9a4_m-300x195.jpg 300w, https://chinadigitaltimes.net/chinese/files/2014/01/bae8fae46b839a86d1cb3ff990d3d9a4_m-230x150.jpg 230w\" sizes=\"(max-width: 540px) 100vw, 540px\" /></a><br />\n于是我联系了运维帮助协查，运维这一查艾玛吓尿了好吗，托管在我们DNS上的域名全部解析出来都是这鸟样……这不科学(╯‵□′)╯︵┻━┻难道我们被*照顾了？小心脏心跳速度骤增，这时候Q群消息变的多起来，咦百度打不开，QQ空间又挂了blablabla&#8230;</p>\n<p>我再继续跟一下几个域名，我大概这辈子只能见到一次这样的trace图了：<br />\n百度和我自己的博客<br />\n<a href=\"http://chinadigitaltimes.net/chinese/files/2014/01/2be3bf7c3740169ae357583181ce3ffd_m.jpg\"><img class=\"alignnone  wp-image-330671\" alt=\"2be3bf7c3740169ae357583181ce3ffd_m\" src=\"http://chinadigitaltimes.net/chinese/files/2014/01/2be3bf7c3740169ae357583181ce3ffd_m.jpg\" width=\"540\" height=\"403\" srcset=\"https://chinadigitaltimes.net/chinese/files/2014/01/2be3bf7c3740169ae357583181ce3ffd_m.jpg 600w, https://chinadigitaltimes.net/chinese/files/2014/01/2be3bf7c3740169ae357583181ce3ffd_m-300x224.jpg 300w\" sizes=\"(max-width: 540px) 100vw, 540px\" /></a><br />\n我居然能和度娘在同机房！爽不爽！【群众：滚(╯—﹏—)╯（ ┷━━━┷</p>\n<p>ovear君的截图，他使用的是TCP查询，TCP也被污染的话，你猜除了*还有谁能干？然后发现google家dns貌似是正常的~_~<br />\n<a href=\"http://chinadigitaltimes.net/chinese/files/2014/01/3cb40e61cfc48a0eda4cbcfd73caf173_m.jpg\"><img class=\"alignnone size-full wp-image-330672\" alt=\"3cb40e61cfc48a0eda4cbcfd73caf173_m\" src=\"http://chinadigitaltimes.net/chinese/files/2014/01/3cb40e61cfc48a0eda4cbcfd73caf173_m.jpg\" width=\"450\" height=\"306\" srcset=\"https://chinadigitaltimes.net/chinese/files/2014/01/3cb40e61cfc48a0eda4cbcfd73caf173_m.jpg 450w, https://chinadigitaltimes.net/chinese/files/2014/01/3cb40e61cfc48a0eda4cbcfd73caf173_m-300x204.jpg 300w\" sizes=\"(max-width: 450px) 100vw, 450px\" /></a></p>\n<p>与此同时运维也在各地的服务器上开始了跟踪查询，发现全国各地解析时间均为25ms左右。这时候结论就出来了。但是也许有人会说我的证据不够充分，那么我们再继续查查这个65.49.2.178是什么来头。</p>\n<p>于是呢，我们在同C段的65.49.2.0/24查到了下面的网站：<br />\n<img alt=\"\" src=\"http://p2.zhimg.com/19/26/19260f35b182a7bfa6626a2d5d66adb4_m.jpg\" width=\"600\" height=\"369\" data-rawwidth=\"902\" data-rawheight=\"556\" data-original=\"http://p2.zhimg.com/19/26/19260f35b182a7bfa6626a2d5d66adb4_r.jpg\" data-actualsrc=\"http://p2.zhimg.com/19/26/19260f35b182a7bfa6626a2d5d66adb4_m.jpg\" /></p>\n<p><strong>关键词自己图里找</strong></p>\n<p>整理一下：<br />\n低延迟说明全国各地（至少在省内或者附近，不会南方跨到北方）直接返回被劫持的IP；<br />\nTCP查询同样中枪，排除黑阔采用全国发UDP包方式进行劫持；<br />\n同网段有那啥网站。</p>\n<p>结论不写了。</p>\n<p>================================================================<br />\n更新一下，有人问啥时候会恢复什么的。</p>\n<p>劫持的影响大约只有15分钟。当时我查到的TTL是几万，也就是说，在电信运营商没对递归DNS手工刷新缓存的情况下，可能还需要间断受影响几个小时。不正常的可以试试更换DNS为8.8.8.8，或者等几小时再看看，后继影响略严重的样子=_=</p>\n","author":980,"categories":[18270,18269,9203,10466],"tags":[7775,12264,9250,15083,8817]}