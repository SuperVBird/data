{"id":160410,"link":"https://chinadigitaltimes.net/chinese/2011/06/阮一峰-bookmarklet编写指南/","date":"2011-06-12T13:30:30Z","modified":"2011-06-12T13:30:30Z","title":"阮一峰 | Bookmarklet编写指南","content":"<p><p>前一段日子，我写了两个Bookmarklet&#8212;-&#8220;<a rel=\"nofollow\" href=\"http://www.ruanyifeng.com/blog/2011/01/api_for_google_s_url_shortener.html\">短网址生成</a>&#8220;和&#8221;<a rel=\"nofollow\" href=\"http://www.ruanyifeng.com/blog/2011/05/bookmarklet_of_unshortening_url.html\">短网址还原</a>&#8220;。</p>\n<p>它们用起来很方便，除了我本人之外，其他朋友也在用。第一次发布Bookmarklet，就能有用户，我挺满意的。</p>\n<p><a rel=\"nofollow\" href=\"http://www.ruanyifeng.com/blog/2011/05/bookmarklet_of_unshortening_url.html\"><img src=\"http://image.beekka.com/blog/201105/bg2011052704.png\" /></a></p>\n<p>下面就是我整理的《Bookmarklet编写指南》，供自己和需要的朋友参考。</p>\n<p>====================================================</p>\n<p><strong>Bookmarklet编写指南</strong></p>\n<p>阮一峰 编写</p>\n<p>\n<strong>一、什么是Bookmarklet？</strong></p>\n<p>Bookmarklet是一个复合词，由Bookmark（书签）和-let（小的）构成，中文可以译成&#8221;书签工具&#8221;。</p>\n<p>它在形式上与&#8221;书签&#8221;一样，都保存在浏览器收藏夹里。但是，它不是一个以&#8221;http://&#8221;开头的网址，而是一段Javascript代码，以&#8221;javascript:&#8221;开头。点击之后，会对当前页面执行某种操作。</p>\n<p>它通常在网页中以链接的形式出现，就像下面这样：</p>\n<blockquote>\n<p> <strong><a href=\"javascript:alert(&#39;hi&#39;);\">xxx</a></strong></p>\n</blockquote>\n<p>用户直接把这个链接拖到地址栏或收藏夹就可以用了。</p>\n<p><img src=\"http://image.beekka.com/blog/201106/bg2011061001.png\" /></p>\n<p><strong>二、Bookmarklet的优点</strong></p>\n<p>它有几个很显著的优点，其他技术难以取代：</p>\n<p><strong>1. 安装快速</strong></p>\n<p> Bookmarklet的安装，就是在收藏夹中保存一段代码，一步就能完成。所有浏览器都原生支持。</p>\n<p><strong>2. 使用方便</strong></p>\n<p> 用的时候，点一下这个链接就行了。</p>\n<p><strong>3. 开发容易</strong></p>\n<p> 一段Javascript代码就是Bookmarklet的所有内容，不需要用到其他技术，比开发一个浏览器插件简单多了。</p>\n<p><strong>4. 跨浏览器</strong></p>\n<p> 所有浏览器都支持Bookmarklet。如果写的正确，同样一个Bookmarklet在各种浏览器上都能正常使用。</p>\n<p><strong>三、Bookmarklet的编写规则</strong></p>\n<p><strong>1. 必须以&#8221;javascript:&#8221;开头</strong></p>\n<p>浏览器把&#8221;javascript:&#8221;当做协议看待。有了它，浏览器才知道要用javascript解释后面的代码。它的作用等同于将代码放在<script></script>之间运行。</p>\n<p><strong>2. 所有代码必须在同一行</strong></p>\n<p>因为浏览器把Bookmarklet当做网址保存，而网址是不能分行的，所以Bookmarklet也不能分行。</p>\n<p>另一方面，网址是有长度限制的。大多数浏览器接受的最长网址，都在2000个字符左右，只有IE6是488字符或508字符。这也就是Bookmarklet的最长长度。<a rel=\"nofollow\" href=\"http://ted.mielczarek.org/code/mozilla/bookmarklet.html\">压缩工具</a>可以帮忙减少长度，但是使用下面提到的连接外部代码的方法，可以避开这个限制。</p>\n<p><strong>3. 使用单引号</strong></p>\n<p>根据Javascript的语法，单引号（&#8217;xxx&#8217;）和双引号（&#8221;xxx&#8221;）都能使用。但是由于html语言主要使用双引号，所以Bookmarklet优先使用单引号。万一遇到必须使用双引号的情况，就采用它的URL编码形式&#8221;%22&#8243;。</p>\n<p><strong>4. 不要污染全局变量</strong></p>\n<p>Bookmarklet最好不要生成新的全局变量，可以采用直接运行匿名函数的方式：</p>\n<blockquote>\n<p> <strong>javascript: (function()&#8230;)();</strong></p>\n</blockquote>\n<p>上面式子的第一个括号，定义了一个匿名函数；最后一个括号表示立即执行这个匿名函数。所有的变量都是匿名函数的内部变量，不会生成任何新的全局变量。</p>\n<p>如果必须设置全局变量，就取罕见的变量名（比如hd8ki2），防止与已经存在的全局变量同名。</p>\n<p><strong>5. 对文本和URL进行编码</strong></p>\n<p>为了防止出现非法字符，代码以外的文本都应该使用encodeURIComponent()函数进行编码，比如把空格变成%20。</p>\n<p><strong>四、Bookmarklet的编写技巧</strong></p>\n<p><strong>1. 获取网页信息</strong></p>\n<p>获取当前页面的标题：document.title。</p>\n<p>获取当前页面的URL： location.href。</p>\n<p>获取当前选中的文本：</p>\n<blockquote>\n<p> var t;</p>\n<p> t = (function()</p>\n<p> if (window.getSelection)</p>\n<p> return window.getSelection().toString();</p>\n<p> else if(document.getSelection)</p>\n<p> return document.getSelection();</p>\n<p> else if (document.selection)</p>\n<p> return document.selection.createRange().text;</p>\n</p>\n<p> return &#8221;;</p>\n<p> })();</p>\n</blockquote>\n<p><strong>2. 防止刷新页面</strong></p>\n<p>如果代码对页面有改动（比如使用了document.write），浏览器就会用一个新页面替换原有页面。所以最好用void()命令，把语句放在里面。</p>\n<p>举例来说，下面这个Bookmarklet会导致原页面被一个新页面替代：</p>\n<blockquote>\n<p> javascript:document.links[0].href=&#8217;http://www.ibm.com/&#8217;;</p>\n</blockquote>\n<p>加上void以后，页面就不会跳转了：</p>\n<blockquote>\n<p> javascript:void(document.links[0].href=&#8217;http://www.ibm.com/&#8217;);</p>\n</blockquote>\n<p><strong>3. 框架（frameset）</strong></p>\n<p>对于使用&#8221;框架&#8221;（frameset）的网页，那些需要操作页面的Bookmarklet一般不起作用。所以，如果发现网页使用了框架，就告诉用户Bookmarklet无法使用。</p>\n<blockquote>\n<p> if(frames.length > 0)</p>\n<p> alert(&#8216;对不起，不适用于框架。&#8217;);</p>\n<p> else</p>\n<p> /* 正常情况的代码 */</p>\n</p>\n</blockquote>\n<p>但是，上面的代码有一个问题，那就是行内框架iframe也包含在frames.length之中，所以必须排除iframe的影响。</p>\n<blockquote>\n<p> if(frames.length > <br /> document.getElementsByTagName(&#8216;iframe&#8217;).length)</p>\n<p> alert(&#8216;对不起，不适用于框架。&#8217;);</p>\n<p> else</p>\n<p> /* 正常情况的代码 */</p>\n</p>\n</blockquote>\n<p><strong>4. 连接外部javascript代码</strong></p>\n<p>有时，Bookmarklet必须再引入外部的Javascript代码，这就需要为当前页面添加一个script标签。</p>\n<blockquote>\n<p> javascript:(function()</p>\n<p> var script=document.createElement(&#8216;script&#8217;);</p>\n<p> script.setAttribute(&#8216;src&#8217;,<br /> &#8216;http://path/to/external/file.js&#8217;); </p>\n<p> document.getElementsByTagName(&#8216;head&#8217;)[0]<br /> .appendChild(script);</p>\n<p> )();</p>\n</blockquote>\n<p><strong>5. 添加外部函数库</strong></p>\n<p>如果Bookmarklet需要用到外部函数库，就必须把它也加进来。但是，前提是必须先检查一下，看看原页面是否已经加载了这个函数库。</p>\n<p>下面以加载jQuery为例：</p>\n<blockquote>\n<p> if (!window.jQuery)  </p>\n<p> script=document.createElement( &#8216;script&#8217; ); </p>\n<p> script.src=&#8217;http://ajax.googleapis.com/<br /> ajax/libs/jquery/1/jquery.min.js&#8217;; </p>\n<p> script.onload=foo; </p>\n<p> document.body.appendChild(script); </p>\n<p>  else </p>\n<p> foo(); </p>\n<p> function foo()  </p>\n<p> /* &#8230; */</p>\n</p>\n</blockquote>\n<p><strong>五、延伸阅读</strong></p>\n<p> * Kalid Azad, <a rel=\"nofollow\" href=\"http://betterexplained.com/articles/how-to-make-a-bookmarklet-for-your-web-application/\">How To Make a Bookmarklet For Your Web Application</a> </p>\n<p> * Troels Jakobsen, <a rel=\"nofollow\" href=\"http://subsimple.com/bookmarklets/rules.asphttp://subsimple.com/bookmarklets/rules.asp\">Rules for Bookmarklets</a> </p>\n<p> * Troels Jakobsen, <a rel=\"nofollow\" href=\"http://subsimple.com/bookmarklets/tips.asp\">Tips for Writing Bookmarklets</a></p>\n<p> * Siddharth, <a rel=\"nofollow\" href=\"http://net.tutsplus.com/tutorials/javascript-ajax/create-bookmarklets-the-right-way/\">Create Bookmarklets &#8211; The Right Way</a></p>\n<p>（完）\n</p>\n<div>\n<h3>文档信息</h3>\n<ul>\n<li>版权声明：自由转载-非商用-非衍生-保持署名 | <a rel=\"nofollow\" href=\"http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh\">Creative Commons BY-NC-ND 3.0</a></li>\n<li>原文网址：<a rel=\"nofollow\" href=\"http://www.ruanyifeng.com/blog/2011/06/a_guide_for_writing_bookmarklet.html\">http://www.ruanyifeng.com/blog/2011/06/a_guide_for_writing_bookmarklet.html</a></li>\n<li>最后修改时间：2011年6月11日 00:47</li>\n<li>付费支持（<a rel=\"nofollow\" href=\"http://www.ruanyifeng.com/blog/2011/05/my_google_adsense_is_disabled.html\">说明</a>）：<a rel=\"nofollow\" href=\"https://lab.alipay.com/p.htm?id=2011051700196144\"><img alt=\"支付宝担保交易\" src=\"http://chinadigitaltimes.net/chinese/files/2011/06/3a976ef2rmb_32.png.png\" /></a> | <a rel=\"nofollow\" href=\"https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&#038;business=yifeng.ruan@gmail.com&#038;currency_code=USD&#038;amount=0.3&#038;return=http://www.ruanyifeng.com/thank.html&#038;item_name=Ruan%20YiFeng's%20Blog&#038;undefined_quantity=1&#038;no_note=0\"><img alt=\"paypal\" src=\"http://chinadigitaltimes.net/chinese/files/2011/06/5ca83e43dollar_32.png.png\" /></a> </li>\n</ul>\n</div>\n<p><img src=\"http://chinadigitaltimes.net/chinese/files/2011/06/981fcb61g2011052704.png-150x150.png\" /></p>\n<p><small>本文由自动聚合程序取自网络，内容和观点不代表数字时代立场</small></p>\n<form method=\"POST\" action=\"http://www.feedblitz.com/f/f.fbz?AddNewUserDirect\">\n定期获得翻墙信息？<a href=\"http://www.feedblitz.com/f/?Sub=738338\">请电邮订阅数字时代</a> <br /><input name=\"EMAIL\" maxlength=\"64\" type=\"text\" size=\"25\" value=\"\"><br />\n<input name=\"FEEDID\" type=\"hidden\" value=\"738338\"><br />\n<input name=\"PUBLISHER\" type=\"hidden\" value=\"7485568\"><br />\n<input type=\"submit\" value=\"订阅!\"><br />\n</form>\n","author":762,"categories":[9203],"tags":[9400]}