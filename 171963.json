{"id":171963,"link":"https://chinadigitaltimes.net/chinese/2011/08/windows-iis日志文件分析程序/","date":"2011-08-13T08:30:21Z","modified":"2011-08-13T08:30:21Z","title":"Windows IIS日志文件分析程序","content":"<p><p>　　<a href=\"http://www.williamlong.info/archives/1308.html\">Windows Server</a>具有事件日志记录的功能，其<a href=\"http://www.williamlong.info/archives/257.html\">IIS</a>日志文件里记录了包括下列信息：谁访问了您的站点，访问者查看了哪些内容等等。通过定期检查这些日志文件，网站管理员可以检测到服务器或站点的哪些方面易受攻击或存在其他安全隐患。</p>\n<p>　　不过，目前的日志分析工具并不是很完善，有些功能并不具备，特别是针对某个URL地址进行攻击的分析并不多，下面是一个VB Script程序，保存为VBS程序后可以在服务器上运行，用于分析和检测IIS日志里针对某个URL地址进行攻击的IP地址。</p>\n<div lang=\"asp\">&#8216;代码开始<br />targeturl = &#8220;/archives/2761.html&#8221;  &#39;受攻击网站的URL地址。<br />logfilepath = &#8220;C:LogFilesW3SVCex110813.log&#8221;  &#39;受攻击网站的日志路径。</p>\n<p> </p>\n<p>On Error Resume Next<br />Set fileobj = CreateObject(&#8220;scripting.filesystemobject&#8221;)<br />Set fileobj2 = CreateObject(&#8220;scripting.filesystemobject&#8221;)<br />Set myfile = fileobj2.opentextfile(logfilepath, 1, False)<br />  <br />Do While myfile.atendofstream <> True<br />myline = myfile.readline()<br />myline2 = Split(myline, &#8221; &#8220;)<br />newip = myline2(9)<br />myurl = myline2(5)<br />If targeturl = myurl Then<br />      writelog newip<br />End If<br />Loop</p>\n<p>myfile.Close<br />Set fileobj2 = Nothing<br />Msgbox &#8220;结束.&#8221;</p>\n<p>Sub writelog(errmes)<br />ipfilename = &#8220;blockip.txt&#8221;<br />Set logfile = fileobj.opentextfile(ipfilename, 8, True)<br />logfile.writeline errmes<br />logfile.Close<br />Set logfile = Nothing<br />End Sub<br />&#8216;代码结束<br /> </p>\n</div>\n<p><img alt=\"IIS日志\" src=\"http://download.williamlong.info/upload/2771_1.jpg\" /></p>\n<p>　　分析出来的IP如果出现异常，可以通过程序，将其批量添加到IIS的屏蔽IP列表里，下面是网上找到的一段VBScript代码，将其改名为vbs后，把上面那段程序的IP导入，即可批量屏蔽攻击者的IP地址。</p>\n<div lang=\"asp\">&#8216;代码开始<br />&#8216;/*=========================================================================<br />&#8216; * Intro VBScript使用ADSI为IIS批量添加屏蔽或允许访问的IP <br />&#8216; * FileName VBScript-ADSI-IIS-Add-Deny-Grant-IP-Change-MetaBase.xml.vbs <br />&#8216; *==========================================================================*/ <br />&#39;AddDenyIP2All &#8220;192.168.1.106,255.255.255.0&#8221; <br />&#39;AddDenyIP &#8220;123456&#8221;,&#8221;127.0.0.1&#8243; <br />&#39;AddDenyIP2All &#8220;14.113.226.116&#8221;</p>\n<p> </p>\n<p>&#8216;添加要屏蔽的IP或一组计算机，到一个指定站点上 <br />Sub AddDenyIP(strWebNo, strDenyIp) <br />On Error Resume Next <br />Set SecObj = GetObject(&#8220;IIS://LocalHost/W3SVC/&#8221; &#038; strWebNo &#038; &#8220;/Root&#8221;) <br />Set MyIPSec = SecObj.IPSecurity <br />MyIPSec.GrantByDefault = True <br />IPList = MyIPSec.IPDeny <br />i = UBound(IPList) + 1 <br />ReDim Preserve IPList(i) <br />IPList(i) = strDenyIp <br />MyIPSec.IPDeny = IPList <br />SecObj.IPSecurity = MyIPSec <br />SecObj.Setinfo <br />End Sub <br />&#8216;添加要屏蔽的IP或一组计算机，到IIS公共配置，以应用到所有站点 <br />&#8216;如果之前对有些站点单独做过屏蔽IP设置，在些设置不会生效，得在总的网站上设置一下，然后覆盖所有子结点 <br />Sub AddDenyIP2All(strDenyIp) <br />On Error Resume Next <br />Set SecObj = GetObject(&#8220;IIS://LocalHost/W3SVC&#8221;) <br />Set MyIPSec = SecObj.IPSecurity <br />MyIPSec.GrantByDefault = True <br />IPList = MyIPSec.IPDeny <br />i = UBound(IPList) + 1 <br />ReDim Preserve IPList(i) <br />IPList(i) = strDenyIp <br />MyIPSec.IPDeny = IPList <br />SecObj.IPSecurity = MyIPSec <br />SecObj.Setinfo <br />End Sub <br />&#8216;添加允许的IP或一组计算机，到一个指定站点上 <br />Sub AddGrantIP(strWebNo, strGrantIp) <br />On Error Resume Next <br />Set SecObj = GetObject(&#8220;IIS://LocalHost/W3SVC/&#8221; &#038; strWebNo &#038; &#8220;/Root&#8221;) <br />Set MyIPSec = SecObj.IPSecurity <br />MyIPSec.GrantByDefault = False <br />IPList = MyIPSec.IPGrant <br />i = UBound(IPList) + 1 <br />ReDim Preserve IPList(i) <br />IPList(i) = strGrantIp <br />MyIPSec.IPGrant = IPList <br />SecObj.IPSecurity = MyIPSec <br />SecObj.Setinfo <br />End Sub <br />&#8216;添加允许的IP或一组计算机，到IIS公共配置，以应用到所有站点 <br />&#8216;如果之前对有些站点单独做过屏蔽IP设置，在些设置不会生效，得在总的网站上设置一下，然后覆盖所有子结点 <br />Sub AddGrantIP2All(strGrantIp) <br />On Error Resume Next <br />Set SecObj = GetObject(&#8220;IIS://LocalHost/W3SVC&#8221;) <br />Set MyIPSec = SecObj.IPSecurity <br />MyIPSec.GrantByDefault = False <br />IPList = MyIPSec.IPGrant <br />i = UBound(IPList) + 1 <br />ReDim Preserve IPList(i) <br />IPList(i) = strGrantIp <br />MyIPSec.IPGrant = IPList <br />SecObj.IPSecurity = MyIPSec <br />SecObj.Setinfo <br />End Sub <br />&#8216;显示IIS公共配置里禁止访问的IP <br />Sub ListDenyIP() <br />Set SecObj = GetObject(&#8220;IIS://LocalHost/W3SVC&#8221;) <br />Set MyIPSec = SecObj.IPSecurity <br />IPList = MyIPSec.IPDeny &#8216;IPGrant/IPDeny <br />WScript.Echo Join(IPList, vbCrLf) <br />&#8216; For i = 0 To UBound(IPList) <br />&#39; WScript.Echo i + 1 &#038; &#8220;&#8211;>&#8221; &#038; IPList(i) <br />&#8216; Next <br />End Sub<br /> </p>\n</div>\n<p><a href=\"http://www.williamlong.info/archives/2771.html\">评论《Windows IIS日志文件分析程序》的内容&#8230;</a></p>\n<h3>相关文章:</h3>\n<ul>\n<p><a href=\"http://www.williamlong.info/archives/2654.html\">网站备案被注销引发网站生存危机</a></p>\n<p><a href=\"http://www.williamlong.info/archives/2617.html\">过滤广告的是是非非</a></p>\n<p><a href=\"http://www.williamlong.info/archives/2274.html\">中国网站备案与认证计划介绍</a></p>\n<p><a href=\"http://www.williamlong.info/archives/2246.html\">从DTD网络流量谈W3C管理员的郁闷、惆怅和纠结</a></p>\n<p><a href=\"http://www.williamlong.info/archives/1971.html\">Google网站性能优化工具Page Speed</a></p>\n</ul>\n<p><img alt=\"统计\" border=\"0\" src=\"http://img.tongji.linezing.com/707050/tongji.gif\" /><br />关于我们： 地址 &#8211; www.williamlong.info &#8211; <a href=\"http://www.google.com/reader/shared/williamlone\">谷歌阅读器</a> &#8211; <a href=\"http://weibo.com/williamlong\">新浪微博</a> &#8211; <a href=\"http://t.qq.com/williamlong\">腾讯微博</a> <br />月光博客投稿信箱：williamlong.info(at)gmail.com</p>\n<p><small>本文由自动聚合程序取自网络，内容和观点不代表数字时代立场</small></p>\n<form method=\"POST\" action=\"http://www.feedblitz.com/f/f.fbz?AddNewUserDirect\">\n定期获得翻墙信息？<a href=\"http://www.feedblitz.com/f/?Sub=750556\">请电邮订阅数字时代</a> <br /><input name=\"EMAIL\" maxlength=\"64\" type=\"text\" size=\"25\" value=\"\"><br />\n<input name=\"FEEDID\" type=\"hidden\" value=\"750556\"><br />\n<input name=\"PUBLISHER\" type=\"hidden\" value=\"7485568\"><br />\n<input type=\"submit\" value=\"订阅!\"><br />\n</form>\n","author":176,"categories":[9203],"tags":[]}