{"id":275903,"link":"https://chinadigitaltimes.net/chinese/2013/01/编程随想-多台电脑如何共享翻墙通道/","date":"2013-01-23T21:00:49Z","modified":"2013-01-23T21:00:49Z","title":"编程随想 | 多台电脑如何共享翻墙通道","content":"<p><h2>★引子</h2>\n<p>\n　　元旦前后，俺写了《<a rel=\"nofollow\" href=\"http://program-think.blogspot.com/2010/04/howto-cover-your-tracks-0.html\">如何隐藏你的踪迹，避免跨省追捕</a>》系列的第6、7篇——《用虚拟机隐匿公网IP》。之后有不少网友到博客留言，询问如何让不同虚拟机的软件共享翻墙代理。<br />\n　　所以，俺今天就来聊一聊&#8221;多台电脑共享翻墙通道&#8221;这个话题。今天介绍的招数，既可以在不同虚拟机之间共享翻墙通道，也可以在不同的实体机（包括PC、平板、手机）之间共享翻墙通道。</p>\n<h2>★准备工作</h2>\n<p>\n　　考虑到俺博客的读者，有很多人不是 IT 技术人员。所以，俺先通俗地扫盲若干基础知识。</p>\n<h3>◇什么是&#8221;翻墙&#8221;</h3>\n<p>\n　　如果你对&#8221;翻墙&#8221;还不太了解，建议你先看看俺写的《<a rel=\"nofollow\" href=\"http://program-think.blogspot.com/2009/05/how-to-break-through-gfw.html\">如何翻墙</a>》一文。这篇扫盲教程可以说是面面俱到，很适合翻墙方面的新手入门。</p>\n<h3>◇什么是&#8221;代理&#8221;</h3>\n<p>\n　　&#8221;代理&#8221;好比是一个中转站，可以中转你的上网数据流量，以此来避开 GFW 这堵墙。<br />\n　　翻墙代理通常包括两部分：代理软件，代理服务器。代理软件安装在你的电脑上，代理服务器通常都位于墙外（也就是境外）。当你通过代理上网时，你的浏览器并不是直接连到目标网站。而是通过如下几个步骤：<br />\n1. 浏览器发送数据到代理软件<br />\n2. 代理软件把你的数据发送到墙外的代理服务器<br />\n3. 代理服务器发送数据到目标网站</p>\n<h3>◇什么是&#8221;监听端口&#8221;</h3>\n<p>\n　　代理软件要正常工作，通常都需要开启一个&#8221;监听端口&#8221;。浏览器通过这个&#8221;监听端口&#8221;来跟代理软件建立连接。只有建立了连接，浏览器才能把数据发送到代理软件上。</p>\n<h3>◇如何看本机开启的监听端口</h3>\n<p>\n　　对于 Windows 系统，在命令行窗口（先运行 cmd 就会出现命令行窗口）运行如下命令，可以看到本机开启的所有监听端口。</p>\n<blockquote><p>netstat -an | find &#8220;LISTEN&#8221;</p></blockquote>\n<p></p>\n<h3>◇什么是监听端口的&#8221;绑定地址&#8221;</h3>\n<p>\n　　以俺手头的虚拟机为例，执行刚才那个命令后，会显示如下</p>\n<blockquote><p>TCP    127.0.0.1:8118    0.0.0.0:0    LISTENING</p></blockquote>\n<p>\n　　其中的 127.0.0.1 表示这个监听端口绑定的网卡地址，而 8118 表示监听的端口号。所谓的&#8221;绑定地址&#8221;，意思就是说，这个监听端口只接受来自该网卡的连接。<br />\n　　因为 127.0.0.1 表示本机网卡地址；所以，绑定在 127.0.0.1 表示该监听端口只接受来自本机的连接。<br />\n　　如果要让某个监听端口接受任意连接（包括外部电脑的连接），可以把绑定地址设置为 0.0.0.0</p>\n<h3>◇小心防火墙的配置</h3>\n<p>\n　　在《<a rel=\"nofollow\" href=\"http://program-think.blogspot.com/2013/01/howto-cover-your-tracks-7.html\">用虚拟机隐匿公网IP</a>》一文，俺就特别用红字，提醒大伙儿要小心防火墙的设置。结果还是有很多人因为防火墙的问题而中招，功亏一篑。<br />\n　　俺再啰嗦一下：<br />\n<span><b>要特别小心操作系统中防火墙的设置</b></span>。很多人是因为防火墙没设好，导致代理无法连通。</p>\n<h2>★如何共享翻墙的代理？</h2>\n<p></p>\n<h3>◇问题</h3>\n<p>\n　　大部分翻墙代理都会提供一个 HTTP 的代理端口（也就是前面说的监听端口）。问题在于：很多翻墙代理的代理端口都绑定在 127.0.0.1 上。也就是说，这个代理只能被本机的软件使用，外部电脑的软件无法连接到该端口。</p>\n<h3>◇解决方案之 &#8220;修改配置文件&#8221;</h3>\n<p>\n　　最简单的解决方案，就是修改翻墙软件的配置文件，让代理端口绑定到 0.0.0.0 上。<br />\n　　以 GoAgent 为例，它的配置文件是 proxy.ini，在该文件中找到 [listen] 字段，然后把该字段下面的 127.0.0.1 改为 0.0.0.0 即可。<br />\n　　可惜的是，很多翻墙软件都没有提供配置文件让你修改监听端口绑定的地址（比如 无界、自由门、世界通 都没有提供配置选项）。所以，俺下面传授一个通用的招数，无需修改配置文件，可以<b>搞定任何翻墙代理</b>，让它的监听端口被外部电脑使用。</p>\n<h3>◇解决方案之 &#8220;端口转发&#8221;</h3>\n<p>\n　　所谓的&#8221;端口转发&#8221;，通俗地说就是让 A 监听端口的数据转发到 B 监听端口。<br />\nB 监听端口就是你的翻墙软件原先开启的端口<br />\nA 监听端口是新开的，而且绑定地址是 0.0.0.0<br />\n　　如此一来，外部电脑就可以用 A 端口作为代理的端口，数据都发给 A 端口，然后利用&#8221;端口转发&#8221;功能，把数据转向 B 端口（也就是翻墙工具自身的端口）</p>\n<h2>★如何搞端口转发？</h2>\n<p>\n　　端口转发是本文的重点，所以俺单独开一个章节详细说。<br />\n　　用来搞端口转发的工具有很多，如果你去 Google 一下 &#8220;TCP proxy&#8221; 或 &#8220;TCP redirection&#8221;，应该能找到一大堆软件和解决方案。考虑到很多读者是菜鸟，俺挑选两种最简单的办法。</p>\n<h3>◇利用 Windows 自带的 netsh</h3>\n<p>\n<b>准备工作</b><br />\n对于 Vista 以及更新版本的 Windows （比如 Win7 Win8 &#8230;）可以直接使用该方案。<br />\n对于 Vista 之前的 Windows（比如 WinXP、Win2003），需要先安装 IPv6 协议栈。具体步骤如下：<br />\n1. 进入&#8221;控制面板&#8221;下面的&#8221;网络连接&#8221;<br />\n2. 选中本地连接，点右键，在右键菜单选&#8221;属性&#8221;<br />\n3. 弹出&#8221;属性&#8221;对话框，点&#8221;安装&#8221;按钮<br />\n4. 弹出&#8221;选择网络组件类型&#8221;对话框，选&#8221;协议&#8221;，再点&#8221;添加&#8221;<br />\n5. 在弹出的对话框中选&#8221;IPv6&#8243;，点&#8221;确定&#8221;</p>\n<p><b>命令详解</b><br />\n添加端口转发的命令</p>\n<blockquote><p>netsh interface portproxy add v4tov4 listenport=<i>新开的监听端口</i> listenaddress=<i>新开端口的绑定地址</i> connectaddress=<i>要转发的地址</i> connectport=<i>要转发的端口</i> protocol=tcp</p></blockquote>\n<p>\n删除端口转发的命令</p>\n<blockquote><p>netsh interface portproxy delete v4tov4 listenport=<i>新开的监听端口</i> listenaddress=<i>新开端口的绑定地址</i></p></blockquote>\n<p>\n<b>举例</b><br />\n比方说，俺本地已经运行了 TOR，端口是 8118，绑定在 127.0.0.1<br />\n如果俺希望通过建立一个新的端口，端口号是 12345（这个端口号是俺随手编的，你也可以用其它端口号），绑定在 0.0.0.0<br />\n那么就执行如下命令</p>\n<blockquote><p>netsh interface portproxy add v4tov4 listenport=<u>12345</u> listenaddress=<u>0.0.0.0</u> connectaddress=<u>127.0.0.1</u> connectport=<u>8118</u> protocol=tcp</p></blockquote>\n<p>\n为了保险起见，再用前面介绍的 netstat 命令，看一下本机开启的端口。如果正常的话，你就可以看到如下一行</p>\n<blockquote><p>TCP    0.0.0.0:12345    0.0.0.0:0    LISTENING</p></blockquote>\n<p>\n如果要删除该端口转发，就执行如下命令</p>\n<blockquote><p>netsh interface portproxy delete v4tov4 listenport=<u>12345</u> listenaddress=<u>0.0.0.0</u></p></blockquote>\n<p>删除之后，再用 netstat 命令查一下，这个 12345 的监听端口就看不到了</p>\n<p><b>优点</b><br />\n无需安装任何第三方软件<br />\n一旦设置好就会持续有效——即使系统重新启动也没关系。</p>\n<p><b>缺点</b><br />\n需要以管理员身份登录，才能执行上述命令。<br />\n该方法只能用于 Windows 系统。</p>\n<h3>◇利用 rinetd</h3>\n<p>\n<b>获取软件</b><br />\nrinetd 是一个很小巧的、跨平台的、开源的工具，它能提供 TCP 端口转发的功能。它的官网在&#8221;<a rel=\"nofollow\" href=\"http://www.boutell.com/rinetd/\">这里</a>&#8220;，上面提供了 Linux 平台和 Windows 平台的软件包。考虑到大多数同学用的是 Windows，俺针对 Windows 的使用介绍一下。<br />\n把那个 rinetd.zip 下载到本地，解压出来，里面有好几个文件（包括源代码）。你只需取出其中的 rinetd.exe 其它文件不需要。</p>\n<p><b>编写配置文件</b><br />\nrinetd 的配置文件很简单，就是一个普通的文本文件，每一行对应一条转发规则。<br />\n每一条转发规则包含4个字段，分别如下，字段之间用空格分开<br />\n绑定地址 监听端口 转发的地址 转发的端口</p>\n<p><b>举例</b><br />\n比方说，俺本地已经运行了 TOR，端口是 8118，绑定在 127.0.0.1<br />\n如果俺希望通过 rinetd 建立一个新的端口，端口号是 12345（这个端口号是俺随手编的，你也可以用其它端口号），绑定在 0.0.0.0<br />\n那么，转发规则就这么写</p>\n<blockquote><p>0.0.0.0 12345 127.0.0.1 8118</p></blockquote>\n<p>\n<b>运行</b><br />\n把刚才写好的配置文件保存成 config.txt（俺只是举例，你也可以用其它文件名），把该文件跟 rinetd.exe 放到同一个目录。<br />\n运行 cmd 进入 Windows 的命令行窗口，然后进入 rinetd.exe 所在的目录，执行如下命令</p>\n<blockquote><p>rinetd.exe -c <u>config.txt</u></p></blockquote>\n<p>为了保险起见，再用前面介绍的 netstat 命令，看一下本机开启的端口。如果正常的话，你就可以看到如下一行</p>\n<blockquote><p>TCP    0.0.0.0:12345    0.0.0.0:0    LISTENING</p></blockquote>\n<p>\n<b>优点</b><br />\n该软件很小巧（整个下载包才 100 多 KB），而且是绿色软件。几乎不占用啥系统资源<br />\n无需管理员即可运行<br />\n跨平台</p>\n<p><b>缺点</b><br />\n每次都要运行（为了方便，你可以把 rinetd 的启动命令加入 Windows 的启动项）</p>\n<h2>★如何共享翻墙的VPN？</h2>\n<p></p>\n<h3>◇问题</h3>\n<p>\n　　用 VPN 翻墙，虽然可以让本机的所有网络软件自动通过 VPN 服务器中转。但是其它电脑的软件无法使用本机的 VPN 网络。</p>\n<h3>◇解决方案之 &#8220;Privoxy&#8221;</h3>\n<p>\n　　&#8221;VPN 翻墙&#8221; 跟 &#8220;代理翻墙&#8221; 的技术原理不同——VPN 软件本身是不开启监听端口的。所以刚才介绍的端口转发，对于 VPN 软件是无效滴！<br />\n　　不过没关系，咱们可以在本机运行 Web 代理或 SOCKS 代理，把监听端口绑定到 0.0.0.0，就可以让其它电脑的软件通过本机的 VPN 翻墙。考虑到大部分人翻墙都是为了浏览网页，俺重点介绍一下 Privoxy 这个工具。</p>\n<p><b>获取软件</b><br />\nPrivoxy 是一个跨平台的，开源的 Web 代理，官网在&#8221;<a rel=\"nofollow\" href=\"http://www.privoxy.org/\">这里</a>&#8220;。<br />\n在官网上有 exe 安装包，也有 zip 的压缩包（免安装）。下哪个看你自己的喜好。俺喜欢免安装的，比较绿色。</p>\n<p><b>修改配置文件</b><br />\nPrivoxy 默认的监听端口是8118，绑定在 127.0.0.1 上。为了让其它电脑能连上来，需要修改绑定的地址。<br />\nPrivoxy 的配置文件是 config.txt 。打开它，搜索 <u>listen-address</u> 会看到如下一行</p>\n<blockquote><p>listen-address  127.0.0.1:8118</p></blockquote>\n<p>修改为</p>\n<blockquote><p>listen-address  0.0.0.0:8118</p></blockquote>\n<p>即可</p>\n<p><b>运行</b><br />\n直接双击 Privoxy.exe<br />\n为了保险起见，再用前面介绍的 netstat 命令，看一下本机开启的端口。如果正常的话，你就可以看到如下一行</p>\n<blockquote><p>TCP    0.0.0.0:8118    0.0.0.0:0    LISTENING</p></blockquote>\n<p></p>\n<h2>★虚拟机的问题</h2>\n<p>\n　　（还不了解虚拟机的同学，可以先看俺写的《<a rel=\"nofollow\" href=\"http://program-think.blogspot.com/2012/10/system-vm-0.html\">扫盲操作系统虚拟机</a>》系列教程）<br />\n　　有些网友（包括俺）会单独开一个虚拟机（Guest OS），专门用来安装翻墙工具。这个虚拟机上，除了翻墙工具，不放其它任何东西。这样做的好处之一是：即使某些翻墙工具有后门，也不会威胁到真实系统（Host OS）的安全。<br />\n　　那么，如何把虚拟机中的翻墙工具共享给其它电脑（Host OS 之外的系统）用捏？</p>\n<h3>◇步骤1</h3>\n<p>\n　　首先，你还是需要参照前面介绍的方法：如果用代理翻墙，就搞端口转发；如果用 VPN 翻墙，就新开一个 Web 代理。</p>\n<h3>◇步骤2</h3>\n<p>\n　　配置虚拟机的网卡模式，可以有两种搞法。</p>\n<p><b>对于 NAT 模式的网卡</b><br />\n你需要添加端口映射。主流的虚拟机软件（包括 VMware 和 VirtualBox）都有此功能。<br />\n该功能类似于刚才提到的端口转发，其原理是：把 Host OS 上的某个端口映射到某个虚拟机的 NAT 网卡上的另一个端口。<br />\n该方法配置稍嫌麻烦，VirtualBox 甚至没图形界面，还要敲一串命令。如果你对网络和虚拟机不太熟悉，俺不推荐用这种搞法。建议改用 Bridge 模式。</p>\n<p><b>对于 Bridge 模式的网卡</b><br />\n如果网卡是 Bridge 模式，那就简单了，<b>无需任何额外设置</b>。<br />\n因为这种模式的虚拟网卡，对于 Host OS 之外的网络是可见的。也就是说，（Host OS 之外的）其它电脑可以直接访问到此网卡——因此就能直接连上代理端口。</p>\n<h2>★结尾</h2>\n<p>\n　　暂且写到这里。如果列位看官针对此话题有啥疑问，或者在实践过程中碰到啥困难，可以到本文留言。俺会尽量解答。<img src=\"http://feeds.feedburner.com/~r/programthink/~4/4b7DbFbZzZc\" height=\"1\" width=\"1\" /></p>\n<p><small>本文由自动聚合程序取自网络，内容和观点不代表数字时代立场</small></p>\n<p><iframe src=\"https://docs.google.com/spreadsheet/embeddedform?formkey=dGRpN3FrVThuMFFsZHBZcmNGLW94dEE6MQ\" width=\"450\" height=\"309\" frameborder=\"0\" marginheight=\"0\" marginwidth=\"0\">Loading&#8230;</iframe></p>\n<form method=\"POST\" action=\"http://chinadigitaltimes.us4.list-manage.com/subscribe/post?u=17daa75df533f6c6ff72e51ab&#038;id=2ea93c5b7b\">\n<a href=\"http://eepurl.com/msuvD\">墙外新闻实时更新 欢迎订阅数字时代</a><br />\n <br /><input type=\"email\" value=\"\" name=\"EMAIL\" id=\"mce-EMAIL_in_post\" size=\"25\" style=\"display:block;\" placeholder=\"请输入您的邮件地址\" required><br />\n\t<input type=\"submit\" value=\"点击订阅\" name=\"subscribe\" style=\"height: 20px;\" id=\"in_post_subscribe\"><br />\n</form>\n","author":1004,"categories":[18270,18269,9203],"tags":[9400]}